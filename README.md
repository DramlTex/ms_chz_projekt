# Проект «Маркировка лёгкой промышленности»

Обновлённое приложение реализует полный цикл работы участника оборота:
авторизация через УКЭП, заказ кодов маркировки в СУЗ и ввод в оборот через True API.
Фронтенд написан на чистом HTML/JS, сервер — на PHP без фреймворков.

## Структура репозитория

```
app/            — PHP-клиенты True API, СУЗ и Национального каталога.
app/Support/    — общий HTTP‑клиент и вспомогательные функции.
config/app.php  — базовые URL, OMS ID/Connection и API‑ключи каталога.
public/         — точка входа (index.php), статические assets и REST-ручки.
  api/          — PHP-endpoints для фронта (auth, catalog, orders, documents).
  assets/       — CSS и JS (Signature, API, App).
  vendor/       — официальный `cadesplugin_api.js` CryptoPro.
docs/           — нормативная и технологическая документация (не изменялась).
```

## Запуск

1. Установите и активируйте **CryptoPro Browser Plug-in** и соответствующее расширение в браузере (Chromium/Edge).
2. В файле `config/app.php` укажите:
   - боевые базовые URL (по умолчанию уже production);
   - `oms_id` и `oms_connection` для СУЗ;
   - `api_key` Национального каталога.
3. Запустите встроенный PHP-сервер из корня репозитория:
   ```bash
   php -S 0.0.0.0:8080 -t public
   ```
4. Откройте `http://localhost:8080` в браузере с установленным CryptoPro.

## Пользовательский поток

1. **Сертификат УКЭП.** Приложение запрашивает список сертификатов из хранилища CryptoPro и отображает срок действия.
2. **Авторизация True API.** Кнопка «Получить challenge» выполняет `GET /auth/key`, пользователь подписывает
   строку challenge, после чего `POST /auth/simpleSignIn` сохраняет токен в сессии.
3. **Авторизация СУЗ.** Аналогично — `GET /auth/key` и `POST /auth/simpleSignIn/{omsConnection}`. Полученный `clientToken`
   сохраняется и подставляется во все дальнейшие запросы СУЗ.
4. **Карточки каталога.** Секция «Карточки НК» обращается к `GET /v4/product-list`, позволяет выбрать товары и собрать
   заготовку заказа с указанием количества КМ по каждой позиции.
5. **Заказ КМ.** Пользователь редактирует JSON заказа (при необходимости добавляя параметры шаблонов), нажимает
   «Подписать и отправить» — фронт формирует откреплённую подпись и отправляет `POST /api/v3/order?omsId=…`.
6. **Отслеживание.** Таблица заказов строится по ответу `GET /api/v3/order/list`.
7. **Ввод в оборот.** На вкладке True API заполняется бизнес‑документ, который автоматически кодируется в Base64,
   подписывается откреплённой подписью и отправляется в `POST /lk/documents/create?pg=…`.
8. **Мониторинг документов.** Таблица документов использует `GET /api/v4/true-api/doc/list`.

Журнал операций внизу страницы показывает все шаги с временными метками, что упрощает расследование ошибок.

## Настройка и расширение

- Конфигурацию стендов можно переключить, изменив `config/app.php`.
- PHP-клиенты (`app/Services/*Client.php`) инкапсулируют вызовы API и могут использоваться в фоновых задачах.
- Для дополнительных операций СУЗ (агрегация, выбытие, утилизация) уже подготовлены endpoint'ы `orders.php?action=dropout`
  и `orders.php?action=utilisation` — достаточно передать payload и подпись.
- Документация по методам True API/СУЗ/НК остаётся в `docs/` и не требует правок при обновлении приложения.

## Требования

- PHP ≥ 8.1 с расширением cURL.
- CryptoPro Browser Plug-in с доступом к сертификатам пользователя.
- Доступ в боевые контуры Честного Знака и действующие учетные данные (`api_key`, OMS ID/Connection).

## Отладка

- В случае HTTP-ошибок серверные эндпоинты возвращают структуру `{ error, details }` с полным ответом внешнего API.
- Логи работы cURL не пишутся на диск; при необходимости можно добавить вывод в `logArea` или расширить `HttpClient`.
- Для работы через прокси/тестовые контуры достаточно заменить базовые URL в `config/app.php`.
