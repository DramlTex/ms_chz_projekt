<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</title>
<link rel="stylesheet" href="css/login.css">
</head>
<body>
<div id="loginForm">
    <h1 style="text-align: center; margin-bottom: 10px; color: #667eea;">üîÑ –ú–æ–π–°–∫–ª–∞–¥ ‚Üí –ù–ö</h1>
    <p style="text-align: center; margin-bottom: 30px; color: #718096; font-size: 14px;">–í–æ–π–¥–∏—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
    
    <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω –ú–æ–π–°–∫–ª–∞–¥" autocomplete="username">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
    <button id="submit" type="button">–í–æ–π—Ç–∏</button>
    <div id="error"></div>
</div>
<script>
    function doLogin() {
        const login = document.getElementById('login').value.trim();
        const password = document.getElementById('password').value;
        
        if (!login || !password) {
            document.getElementById('error').textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
            return;
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        document.getElementById('error').textContent = '';
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        const submitBtn = document.getElementById('submit');
        submitBtn.disabled = true;
        submitBtn.textContent = '–í—Ö–æ–¥...';
        
        fetch('api_ms/login.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({login, password})
        }).then(async r => {
            if (r.ok) return r.json();
            const data = await r.json().catch(() => ({}));
            throw new Error(data.error || 'auth');
        }).then((data) => {
            console.log('Login successful:', data);
            location.href = 'index.html';
        }).catch(err => {
            console.error('Login error:', err);
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = false;
            submitBtn.textContent = '–í–æ–π—Ç–∏';
            
            if (err.message === 'no_api_access') {
                document.getElementById('error').innerHTML = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ API —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞. <a href="https://online.moysklad.ru/app/#employee" target="_blank">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∞</a>';
            } else if (err.message === 'unauthorized') {
                document.getElementById('error').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
            } else {
                document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.';
            }
        });
    }
    
    // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
    document.getElementById('submit').onclick = doLogin;
    
    // Enter –¥–ª—è –≤—Ö–æ–¥–∞
    document.getElementById('login').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') doLogin();
    });
    
    document.getElementById('password').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') doLogin();
    });
</script>
</body>
</html>