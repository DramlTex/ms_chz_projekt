# Документация модуля: doc/nk_card_flow.md

## Что должен делать код в общих чертах
Код, отвечающий за выпуск карточки товара из МойСклад в Национальный каталог, собирает все обязательные атрибуты из карточки товара и её варианта, нормализует их и формирует JSON-структуру карточки НК. Дальше он отправляет карточку через `POST /v3/feed`, отслеживает обработку по `feed_id`, получает выданный GTIN (технический или боевой) и, если карточка принята, дописывает GTIN обратно в МойСклад. В процессе используется автоматическое определение категории по ТН ВЭД и справочники НК, а ошибки и сетевые обращения логируются в `nk_api.log` и серверный лог Flask.

## Последовательность действий в коде
1. Загружается ассортимент МойСклад и из товара/варианта собираются все наследуемые атрибуты (артикул, цвет, размер, ТН ВЭД, документы, страна, бренд, целевой пол).  
2. Выполняются валидации цвета и "вида товара" на соответствие пресетам НК для подсказок пользователю.  
3. По ТН ВЭД вызывается `detect_category`, при необходимости уточняется продуктовая группа и категория в НК.  
4. Функция `create_card_data` строит JSON карточки: подбирает формат ТН ВЭД, формирует полное название, собирает `good_attrs` с атрибутами НК и выставляет флаги (`is_tech_gtin`, `moderation`).  
5. Перед отправкой при необходимости запрашивается боевой GTIN через `GET /v3/generate-gtins`; иначе карточка идёт с техническим GTIN.  
6. Карточка отправляется в `/v3/feed`, после чего `wait_for_final_status` опрашивает `/v3/feed-status` (и при ошибках — `/v3/feed-details`/`/v3/feeds`).  
7. `format_status_response` вытаскивает GTIN и ошибки из ответа, а `send_product_to_nk` при успехе вызывает `update_product_gtin`, который обновляет штрихкоды товара/варианта в МойСклад.  
8. Все HTTP-запросы НК логируются через `nk_api.logger`, а исключения записываются через `logger.exception`, чтобы отладить ошибки интеграции.

## Карта глобальных переменных
| Имя | Тип | Значение по умолчанию | Экспортируется | Назначение | Используется в |
|---|---|---|:---:|---|---|
| `logger` | `logging.Logger` | пишет в `nk_api.log` | да | Логирование обращений к НК и ошибок GTIN | `_req`, `get_live_gtin`, `send_live_card` и др.【F:nk_api.py†L22-L29】【F:nk_api.py†L62-L77】
| `COUNTRY_ISO_MAP` | `dict[str,str]` | карта русских названий → ISO-2 | да | Нормализация стран производства для атрибута 2630 | `normalize_country_code`, `create_card_data`【F:nk_api.py†L31-L55】【F:nk_api.py†L382-L385】
| `CATEGORIES_WITH_FULL_TNVED` | `set[int]` | из `config.py` | да | Список категорий, требующих 10-значный ТН ВЭД | `create_card_data`, `MoySkladAPI.extract_tnved`【F:nk_api.py†L300-L358】【F:app.py†L386-L470】
| `TNVED_DETAILED_ATTR_ID` | `int` | из `config.py` | да | Атрибут для детального ТН ВЭД при 4-значном коде в карточке | `create_card_data`, `MoySkladAPI.extract_tnved`【F:nk_api.py†L392-L399】【F:app.py†L386-L470】
| `NC_BASE`, `HEADERS` | `str`, `dict` | URL НК и apiKey | да | Настройка запросов определения категории | `detect_category`【F:utils/nk_category.py†L6-L31】
| `AUTO_CATEGORY`, `LAST_PRODUCTS` | `str`, `list` | `"TNVED"`, `[]` | да | Определяют стратегию категорий и кэш списка товаров | `send_product_to_nk`, UI-контроллеры【F:app.py†L63-L83】

## Карта функций
| Имя | Видимость | Сигнатура | Краткое назначение | Исключения | Сайд-эффекты |
|---|---|---|---|---|---|
| `MoySkladAPI.extract_item_data_with_inheritance` | public | `(item) -> dict[str, Any]` | Собирает все данные товара/варианта с учётом родителя | нет | Читает атрибуты, подсчитывает валидации【F:app.py†L404-L540】
| `detect_category` | public | `(tnved: str) -> dict` | Получает productGroupCode и categoryId из НК | `ValueError` при немаркируемом коде | HTTP-запросы в НК【F:utils/nk_category.py†L13-L31】
| `create_card_data` | public | `(product_data, cat_id=None, is_tech_gtin=True, moderation=False, name_options=None) -> dict` | Формирует JSON карточки с `good_attrs` | нет | Печать подсказок в консоль【F:nk_api.py†L300-L439】
| `get_live_gtin` | public | `(quantity: int = 1) -> str` | Запрашивает боевой GTIN | `RuntimeError`, HTTP ошибки | Логирует и печатает, вызывает `requests.get`【F:nk_api.py†L645-L677】
| `send_card_to_nk` | public | `(card_data: dict) -> dict` | Отправляет карточку с тех. GTIN | HTTP ошибки, Exception | POST `/v3/feed`, печатает статус【F:nk_api.py†L476-L510】
| `send_live_card` | public | `(card_data: dict) -> dict` | Отправляет карточку с живым GTIN | `RuntimeError`, HTTP ошибки | POST `/v3/feed`, логирует ошибки【F:nk_api.py†L681-L705】
| `wait_for_final_status` | public | `(feed_id: str, interval=10, retries=30) -> dict` | Периодически опрашивает `/v3/feed-status` | нет | `time.sleep`, консольный лог【F:nk_api.py†L569-L579】
| `format_status_response` | public | `(feed_info: dict) -> dict` | Структурирует ответ, вытаскивает GTIN и ошибки | нет | Печатает найденный GTIN【F:nk_api.py†L756-L798】
| `MoySkladAPI.update_product_gtin` | public | `(product_id, new_gtin, is_variant=False) -> dict` | Добавляет GTIN в штрихкоды товара/варианта МойСклад | `requests.exceptions.RequestException` | GET/PUT в МойСклад, формирует сообщения об ошибке【F:app.py†L544-L584】
| `ms_request_args` | public | `() -> tuple[dict,str|tuple|None]` | Готовит заголовки/авторизацию для МойСклад | `RuntimeError` при отсутствии сессии | нет【F:utils_ms.py†L4-L20】

## Описание функций
### `MoySkladAPI.extract_item_data_with_inheritance(item) -> dict[str, Any]`
**Назначение.** Собирает все данные из товара и его родителя: артикул, бренд, цвет, размер, ТН ВЭД, документы, страну и признаки для НК, а также подготавливает флаги валидности цвета и "вида товара".  
**Параметры.** `item` — словарь МойСклад (продукт или вариант).  
**Возвращает.** Словарь атрибутов для отправки в НК.  
**Исключения.** Нет.  
**Сайд-эффекты.** Обращается к вспомогательным методам и вызывает `validate_color`/`validate_product_kind` для подсказок пользователю.【F:app.py†L404-L540】

### `detect_category(tnved: str) -> dict`
**Назначение.** По коду ТН ВЭД получает `productGroupCode` и `categoryId` через REST API НК.  
**Параметры.** `tnved` — код ТН ВЭД.  
**Возвращает.** Словарь вида `{"productGroupCode": ..., "categoryId": ...}`.  
**Исключения.** `ValueError`, если товар не маркируемый; сетевые исключения при сбоях.  
**Сайд-эффекты.** Выполняет `POST /check/feacn` и `GET /categories/by-feacn` к НК; выводит диагностические сообщения в консоль.【F:utils/nk_category.py†L13-L31】

### `create_card_data(...) -> dict`
**Назначение.** Собирает финальный JSON карточки: выбирает категорию, корректирует длину ТН ВЭД, строит наименование и добавляет атрибуты НК (страна, бренд, вид товара, цвет, размер, состав, документы).  
**Параметры.** `product_data` — данные из МойСклад; `cat_id` — фиксированная категория (если уже известна); `is_tech_gtin` — признак технического GTIN; `moderation` — флаг модерации; `name_options` — включение артикул/размера/цвета в имя.  
**Возвращает.** Словарь, готовый к отправке в `/v3/feed`.  
**Исключения.** Нет.  
**Сайд-эффекты.** Печатает ход определения категории и выбора ТН ВЭД в консоль для отладки.【F:nk_api.py†L300-L439】

### `get_live_gtin(quantity: int = 1) -> str`
**Назначение.** Получить боевой GTIN перед отправкой карточки.  
**Параметры.** `quantity` — сколько GTIN нужно.  
**Возвращает.** Строку GTIN из первого драфта.  
**Исключения.** HTTP ошибки, `RuntimeError` при превышении лимитов или пустом ответе.  
**Сайд-эффекты.** Логирует запрос через `logger`, выводит диагностические сообщения, бросает исключение при 4xx/5xx чтобы не продолжать отправку.【F:nk_api.py†L645-L677】

### `send_card_to_nk(card_data: dict) -> dict`
**Назначение.** Отправить карточку с техническим GTIN в `/v3/feed`.  
**Параметры.** `card_data` — JSON карточки.  
**Возвращает.** `{success: True, feed_id}` при HTTP 200, иначе `{success: False, error, status_code}`.  
**Исключения.** Перехватывает любые исключения и возвращает их текст в `error`.  
**Сайд-эффекты.** Логирует HTTP статус, очищает сессию при 401 (через `_req`), печатает в консоль результат.【F:nk_api.py†L476-L510】

### `send_live_card(card_data: dict) -> dict`
**Назначение.** Отправить карточку, если GTIN уже боевой (поле `gtin`).  
**Параметры.** `card_data` — JSON карточки с заполненным GTIN.  
**Возвращает.** `{success: True, feed_id}` либо кидает `RuntimeError` при некорректном ответе.  
**Исключения.** HTTP ошибки поднимаются, чтобы код-выше обработал их.  
**Сайд-эффекты.** Пишет ошибки в `nk_api.log` через `logger.exception`.【F:nk_api.py†L681-L705】

### `wait_for_final_status(feed_id: str, interval=10, retries=30) -> dict`
**Назначение.** Пульсирует `/v3/feed-status`, пока фид не выйдет из статусов `Processing`/`InProgress`.  
**Параметры.** `feed_id` — идентификатор отправки; `interval`, `retries` — пауза и число попыток.  
**Возвращает.** Последний ответ `check_feed_status`; добавляет `timeout=True`, если лимит попыток исчерпан.  
**Исключения.** Нет.  
**Сайд-эффекты.** `time.sleep`, выводит в консоль статус каждой попытки.【F:nk_api.py†L569-L579】

### `check_feed_status(feed_id: str) -> dict`
**Назначение.** Получить расширенный статус обработки фида.  
**Параметры.** `feed_id` — идентификатор загрузки.  
**Возвращает.** Словарь с полями `status`, `items_*`, `errors`, `warnings`, `raw_data`; добавляет отформатированные ошибки и детали при отклонении.  
**Исключения.** Возвращает `{success: False, error}` при сетевых сбоях.  
**Сайд-эффекты.** Дёргает `/v3/feed-status`, а при ошибках — `/v3/feed-details` и `/v3/feeds`.【F:nk_api.py†L514-L615】

### `format_status_response(feed_info: dict) -> dict`
**Назначение.** Привести ответ НК к удобному виду: достать GTIN, статистику, ошибки и проблемные позиции.  
**Параметры.** `feed_info` — результат `check_feed_status`.  
**Возвращает.** Словарь для UI/API, включая `gtin`, `stats`, `errors`, `raw_response`.  
**Исключения.** Нет.  
**Сайд-эффекты.** Печатает найденный GTIN в консоль для отладки.【F:nk_api.py†L756-L798】

### `MoySkladAPI.update_product_gtin(product_id, new_gtin, is_variant=False) -> dict`
**Назначение.** Дописать полученный GTIN в список штрихкодов товара или варианта МойСклад.  
**Параметры.** `product_id` — UUID сущности; `new_gtin` — число/строка; `is_variant` — признак варианта.  
**Возвращает.** `{success: True, ...}` с сообщением и количеством штрихкодов или `{success: False, error}`.  
**Исключения.** Оборачивает `requests.exceptions.RequestException`, дополняя текст ответом МойСклад.  
**Сайд-эффекты.** Делает `GET /entity/{product|variant}/{id}` и `PUT` с обновлённым массивом `barcodes`; форматирует GTIN до 14 знаков. 【F:app.py†L544-L584】

### `ms_request_args() -> tuple[dict, tuple[str,str] | None]`
**Назначение.** Сформировать заголовки и авторизацию для обращений в МойСклад на основании сессии Flask.  
**Параметры.** Нет.  
**Возвращает.** Кортеж `(headers, auth)`; при токене выставляет Bearer, иначе Basic.  
**Исключения.** `RuntimeError`, если ни токена, ни логина/пароля нет в сессии.  
**Сайд-эффекты.** Нет. 【F:utils_ms.py†L4-L20】

### `generate_gtin(cat_id: int, producer_inn: str) -> str | None`
**Назначение.** Заказать технический GTIN по категории и ИНН производителя (используется при подготовке карточек).  
**Параметры.** `cat_id` — категория НК; `producer_inn` — ИНН.  
**Возвращает.** Строку GTIN или `None`, если ответ пустой.  
**Исключения.** Перехватывает исключения и печатает ошибку.  
**Сайд-эффекты.** POST `/v3/generate-code`, печатает HTTP статус при ошибках. 【F:nk_api.py†L618-L642】

## Описание исполнительной части кода
- Действия при импорте: `nk_api` настраивает файл логов `nk_api.log` и общую функцию `_req`, которая пишет в лог каждое обращение к НК, фиксируя метод, URL и время отклика; при 401 токен стирается из сессии, поэтому новые вызовы потребуют повторной авторизации.【F:nk_api.py†L22-L77】  
- CLI/entrypoints: основной сценарий — HTTP-роут `/send_to_nk/<product_index>` в Flask. Он получает от клиента желаемые изменения, решает, нужен ли боевой GTIN, и инициирует последовательность построения и отправки карточки.【F:app.py†L1114-L1206】  
- Типичный вызов:
  1. Клиент выбирает товар и отправляет POST `/send_to_nk/{index}` с опциями (`user_changes`, `is_tech_gtin`, `moderation`, `name_options`).  
  2. Сервер извлекает товар/вариант из кэша ассортимента, наследует данные, валидирует атрибуты и уточняет категорию через `detect_category`.  
  3. `create_card_data` строит JSON карточки (пример ниже), при необходимости добавляя детальный ТН ВЭД и обязательные атрибуты.  
  4. Если запрошен боевой GTIN, вызывается `get_live_gtin`. Затем `send_card_to_nk` или `send_live_card` отправляет карточку в `/v3/feed` и возвращает `feed_id`.  
  5. `wait_for_final_status` опрашивает `/v3/feed-status`; при отклонении запрашиваются детали (`/v3/feed-details`, `/v3/feeds`). `format_status_response` извлекает GTIN и оформляет ошибки.  
  6. Если карточка не отклонена, `update_product_gtin` делает GET+PUT к API МойСклад, добавляя новый GTIN в `barcodes`. Ошибки из МойСклад добавляются в ответ для пользователя.  
  7. Ответ API включает `raw_response` НК, `errors`, `validation_errors`, `error_summary` (для rejected) и флаг `gtin_updated_in_ms`, чтобы интерфейс мог показать пользователю итог.  

### Пример JSON карточки для `/v3/feed`
```json
{
  "is_tech_gtin": true,
  "tnved": "6204",
  "brand": "БрендОдежды",
  "good_name": "АРТ123 Платье 46 СИНИЙ",
  "moderation": 0,
  "categories": [30933],
  "good_attrs": [
    {"attr_id": 2630, "attr_value": "RU"},
    {"attr_id": 2478, "attr_value": "АРТ123 Платье 46 СИНИЙ"},
    {"attr_id": 2504, "attr_value": "БрендОдежды"},
    {"attr_id": 13933, "attr_value": "6204430000"},
    {"attr_id": 12, "attr_value": "ПЛАТЬЯ"},
    {"attr_id": 36, "attr_value": "СИНИЙ"},
    {"attr_id": 35, "attr_value": "46", "attr_value_type": "МЕЖДУНАРОДНЫЙ"},
    {"attr_id": 2483, "attr_value": "100% хлопок"},
    {"attr_id": 13836, "attr_value": "ТР ТС 017/2011 \"О безопасности продукции легкой промышленности\""},
    {"attr_id": 13914, "attr_value": "АРТ123", "attr_value_type": "Артикул"},
    {"attr_id": 14013, "attr_value": "ЖЕНСКИЙ"}
  ]
}
```
Карточка может содержать дополнительный `product_group_code`, если `detect_category` вернул значение, и поле `gtin`, если был получен боевой номер перед отправкой.【F:nk_api.py†L300-L439】【F:app.py†L1151-L1167】

### Форматы ответов и обработка ошибок
- `/v3/feed` возвращает `{result: {feed_id}}`. Если `result` или `feed_id` отсутствуют, `send_card_to_nk` возвращает ошибку, а статус HTTP ≠200 включается в текст ошибки. Это же место печатает сообщение об ошибке в stdout для дальнейшего анализа логов контейнера.【F:nk_api.py†L476-L507】
- `/v3/feed-status` предоставляет поля `status`, `items_*`, `errors`, `warnings`, `item`. При `Rejected` дополнительно подтягиваются `validation_errors` и `items` через `get_feed_details`. Ошибки нормализуются функцией `format_errors`, которая добавляет расшифровку атрибута по `attr_id`. Итоговый ответ для UI содержит агрегированные ошибки, статистику и `raw_response` для отладки.【F:nk_api.py†L514-L798】
- `/v3/generate-gtins` может вернуть лимиты (`monthly-limit`, `usage`). При превышении лимита генерируется `RuntimeError`, чтобы карточка не ушла без GTIN. Любой HTTP ≠200 логируется через `logger.exception`, и исключение пробрасывается выше, что попадает в `send_product_to_nk` и возвращает ошибку пользователю.【F:nk_api.py†L645-L677】
- Обновление GTIN в МойСклад делает `GET` для получения текущих штрихкодов и `PUT` с добавленным элементом. Если GTIN уже есть, возвращается `success=True` с пояснением. При ошибках API сообщение дополняется деталями из JSON `errors` или текстом HTTP-ответа. Это позволяет журналировать точные причины отказа в `ms_update_error`.【F:app.py†L544-L584】

### Логирование
- Все низкоуровневые вызовы НК проходят через `_req`, который пишет строку `NK {method} {url} -> {status} {elapsed}s` в `nk_api.log` и очищает токен при 401, что помогает диагностировать проблемы с авторизацией. Для ручных запросов (`send_card_to_nk`, `get_live_gtin`, `send_live_card`) используются `logger.info`/`logger.exception`, чтобы технические детали попадали в файл логов и систему мониторинга.【F:nk_api.py†L62-L77】【F:nk_api.py†L645-L705】
- Во Flask-приложении общий `logger` настроен через `logging.basicConfig(level=logging.INFO)`. Критические места (`send_to_nk`, `nk_preview`, `index`) логируют исключения через `logger.exception`, что упрощает поиск ошибок UI и синхронизации с МойСклад.【F:app.py†L63-L83】【F:app.py†L1080-L1111】
- Рекомендуется при добавлении новых точек интеграции использовать те же логгеры (`nk_api.logger` и `app.logger`) и включать в сообщения идентификаторы товара, `feed_id`, `gtin` и HTTP-статусы, чтобы поддерживать единую структуру логов.
