# Документация веб-страницы: /orders/settings.php

## 1. Назначение страницы и роль в продукте
Страница позволяет инженеру интеграции настроить параметры подключения к OMS/СУЗ и протестировать получение `clientToken`. Не оформляет заказы, а готовит окружение и проверяет связку УКЭП → True API → СУЗ. Не редактирует карточки товара и не отправляет заявки.

## 2. Информационная архитектура и навигация
- Входы: ссылка с `/orders/create.php` («Настройки OMS»), прямой deeplink `/orders/settings.php`.
- Выходы: кнопки-навигации к `/orders/create.php` и `/index.php`.
- URL: `/orders/settings.php`, без параметров. Страница находится в разделе «Заказ кодов → Настройки».

## 3. Состав страницы (UI-карта и состояния)
| ID/селектор | Тип | Назначение | Условия показа | SSR/CSR | Варианты |
|---|---|---|---|---|---|
| `.page-header` | block | Заголовок и навигация | всегда | SSR | — |
| `#statusCard` | block | Текущее состояние токена и OMS | всегда | CSR | активен / отсутствует |
| `#omsConnection`, `#omsId`, `#participantInn`, `#stationUrl`, `#locationAddress` | atom | Поля ввода настроек | всегда | CSR | заполнено / пусто / невалидно (проверка в JS) |
| `#certSelect` | atom | Выбор сертификата УКЭП | если доступен `cadesplugin` | CSR | список / ошибка / пусто |
| `#saveSettings`, `#testConnection`, `#resetToken` | atom | Действия с настройками | всегда | CSR | enabled / disabled (ручное) |
| `#testLog` | block | Журнал тестового подключения | всегда | CSR | initial / прогресс / ошибка |

## 4. Поведение и сценарии (user flows)
1. «Сохранить»: пользователь заполняет поля → `POST /api/orders/suz-settings.php` → уведомление в логе «Настройки сохранены».
2. «Тестовое подключение»: страница сохраняет контекст → запрашивает challenge `GET /api/orders/suz-auth.php?mode=challenge` → подписывает → отправляет `POST /api/orders/suz-auth.php` → на успех пишет в лог «clientToken получен» и обновляет статус.
3. «Сбросить token»: `DELETE /api/orders/suz-auth.php` → статус «clientToken отсутствует».
4. При загрузке страница подтягивает сохранённый контекст (`initial.context`) и актуальный статус токена (`initial.status`) и заполняет форму.

## 5. Данные и интеграции (API/контракты)
- Источники: REST-эндпоинты `/api/orders/suz-settings.php` (GET/POST/DELETE) и `/api/orders/suz-auth.php` (GET challenge, POST token, DELETE).
- Ответы описаны в `docs/processed/api/suz/oms-settings.md`.
- Ошибки API отображаются пользователю через `alert` и строку в `#testLog` («✗ Ошибка: …»). Коды 4xx/5xx выводятся целиком.
- Кэширование отсутствует (`Cache-Control: no-store`).

## 6. Контент и локализация (i18n)
| Ключ | Значение (ru) | Комментарий | Плейсхолдеры |
|---|---|---|---|
| title | «Настройки OMS и СУЗ» | `<title>` | — |
| subtitle | «Сохраните параметры подключения…» | `p.block__meta` | — |
| placeholders | «GUID подключения», «00000000-0000-…», «Например, 7700000000», «https://suzgrid.crpt.ru/api/v3» | Поля ввода | — |
| log messages | «Настройки сохранены», «→ Запрос challenge…», «✓ clientToken получен», «✗ Ошибка: …» | `#testLog` | `{error}` |

## 7. SEO и метаданные
- `<title>` и `meta description` заданы статически. Канонический URL не требуется (служебная страница).
- Robots не изменяются (наследуется от web-сервера). OpenGraph/Twitter Cards не используются.

## 8. Доступность (a11y)
- Все поля имеют `<label for=…>`.
- Кнопки — `<button>` с текстом.
- Фокусные состояния используют стандартный браузерный outline. Нет hotkeys.
- Журнал `#testLog` — `<pre>`, обновляется текстом; скринридеру читается содержимое (нет live region).

## 9. Аналитика и трекинг
- Отсутствует: событийная аналитика не внедрена.

## 10. Производительность и медиа
- Единственный статический JS — `cadesplugin_api.js` (для работы расширения). 
- Страница не подгружает изображения, CSS inline. 
- Логи и запросы выполняются по требованию пользователя.

## 11. Безопасность и приватность
- Настройки хранятся в PHP-сессии (cookie `PHPSESSID`).
- Чувствительные поля (`omsConnection`, `omsId`) не логируются на клиенте, но события фиксируются на сервере (`orders_debug.log`).
- Нет внешних доменов кроме `fonts.gstatic.com` (preconnect).

## 12. Адаптивность и кроссбраузерность
- Макет — адаптивная сетка `grid` с `minmax(240px, 1fr)`; при ширине <900px уменьшается padding.
- Тестировалось на современных Chromium; требуется поддержка CryptoPro plugin (только Windows/IE-режим/Chromium через расширение).
- Для мобильных устройств страница доступна, но тест подписи возможен только с поддерживаемых браузеров.

## 13. Тестирование и критерии приёмки
- Smoke: заполнение полей → POST успешен → ответ `{status:"ok"}`.
- Тест подписи: выбран сертификат, challenge запрошен, подпись создана, `clientToken` получен (видно в `#testLog`).
- Негатив: пустой `omsConnection` → JS ошибка «Заполните omsConnection»; API 400 → сообщение в логе и `alert`.

## 14. Исполнительная часть (entrypoints/SSR/фичефлаги)
- Страница запускает скрипт сразу после загрузки (`(() => { … })()`), без фичефлагов.
- Требуется активная PHP-сессия и доступ к True API/СУЗ (окружение `config/app.php`).
- Для теста необходимо установленное расширение CryptoPro (`cadesplugin`).
