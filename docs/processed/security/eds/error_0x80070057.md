# Документация модуля: docs/processed/security/eds/error_0x80070057.md

## История изменений
- 2025-09-23 — Добавлена памятка по устранению ошибки «Параметр задан неверно (0x80070057)» в сценариях CryptoPro SignHash (agent).

## Что должен делать код в общих чертах
Модуль описывает правильную подготовку данных для методов CryptoPro Browser Plug-in `RawSignature.SignHash` и `CadesSignedData.SignHash`, чтобы исключить ошибку 0x80070057: алгоритм хэширования объявляется через `propset_Algorithm`, digest передаётся в шестнадцатеричном виде, сертификат подписанта выбирается в хранилище и связывается с `CPHashedData` либо `CPSigner`, после чего выполняется подпись и проверка с совпадающими параметрами.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L5-L8】【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L8-L8】【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L11-L12】【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L13-L13】

## Последовательность действий в коде
1) Получить SubjectName пользователя, открыть `CAPICOM_CURRENT_USER_STORE` и извлечь первый сертификат по совпадению CN, затем закрыть хранилище, чтобы исключить утечки ресурсов.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L8-L8】
2) Создать `CAdESCOM.HashedData`, вызвать `propset_Algorithm` и указать ГОСТ-алгоритм до передачи хэш-значения, иначе метод вернёт ошибку параметров.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L6-L7】
3) Передать digest как строку шестнадцатеричных пар байт (с пробелами либо без) в `SetHashValue`; другой формат спровоцирует 0x80070057 на этапе подписи.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L7-L7】
4) Для «сырой» подписи создать `RawSignature`, вызвать `SignHash` и затем `VerifyHash`, используя тот же объект `HashedData` и сертификат.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L8-L8】
5) Для CAdES-BES подписи подготовить `CPSigner` с сертификатом и проверкой, затем вызвать `CadesSignedData.SignHash`/`VerifyHash` с идентичными параметрами; несогласованность алгоритма или digest приведёт к 0x80070057.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L11-L13】

## Карта глобальных переменных
нет

## Карта функций
| Имя | Видимость | Сигнатура | Краткое назначение | Исключения | Сайд-эффекты |
|---|---|---|---|---|---|
| `CAdESCOM.HashedData.propset_Algorithm` | external | `propset_Algorithm(hashAlg)` | Фиксирует алгоритм перед загрузкой хэша, чтобы плагин понимал формат digest. | 0x80070057 при несоответствии входных данных. | Нет. 【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L6-L6】|
| `CAdESCOM.HashedData.SetHashValue` | external | `SetHashValue(hexDigest)` | Принимает шестнадцатеричную строку и связывает её с объектом хэша. | 0x80070057, если строка не соответствует формату или алгоритму. | Нет. 【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L7-L7】|
| `CAdESCOM.RawSignature.SignHash` | external | `SignHash(hashedData, certificate)` | Вычисляет «сырую» подпись над подготовленным хэш-значением. | 0x80070057 при неподходящих параметрах. | Запрашивает доступ к контейнеру закрытого ключа. 【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L8-L8】|
| `CAdESCOM.RawSignature.VerifyHash` | external | `VerifyHash(hashedData, certificate, signature)` | Проверяет подпись, ожидая совпадающий digest и алгоритм. | 0x80070057 при несогласованных данных. | Нет. 【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L8-L8】|
| `CAdESCOM.CPSigner.propset_Certificate` | external | `propset_Certificate(certificate)` | Назначает сертификат подписанта для CAdES-BES подписи. | 0x80070057, если сертификат не подходит. | Нет. 【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L11-L12】|
| `CAdESCOM.CPSigner.propset_CheckCertificate` | external | `propset_CheckCertificate(true|false)` | Включает проверку сертификата перед подписью. | 0x80070057 при ошибке проверки. | Может инициировать сетевые проверки статуса. 【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L12-L12】|
| `CAdESCOM.CadesSignedData.SignHash` | external | `SignHash(hashedData, signer, signatureType)` | Формирует отделённую подпись CAdES-BES над хэшем. | 0x80070057 при несоответствии параметров. | Создаёт PKCS#7 контейнер. 【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L11-L13】|
| `CAdESCOM.CadesSignedData.VerifyHash` | external | `VerifyHash(hashedData, signature, signatureType)` | Проверяет подпись, требуя идентичные алгоритм и digest. | 0x80070057 при расхождениях. | Нет. 【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L13-L13】|

## Описание функций
### `CAdESCOM.HashedData.propset_Algorithm`
**Назначение.** Установить идентификатор алгоритма (например, ГОСТ 34.11), чтобы плагин интерпретировал digest корректно и не возвращал ошибку параметров.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L6-L6】
**Параметры.** `hashAlg: number` — код алгоритма из `CADESCOM_HASH_ALGORITHM`.
**Возвращает.** `void`.
**Исключения.** 0x80070057, если алгоритм конфликтует с уже загруженным значением.
**Сайд-эффекты.** Нет.
**Локальные переменные.** нет.

### `CAdESCOM.HashedData.SetHashValue`
**Назначение.** Передать подготовленный digest в виде шестнадцатеричной строки; любые другие форматы вызывают исключение параметров.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L7-L7】
**Параметры.** `hexDigest: string` — хэш, разбитый на пары символов.
**Возвращает.** `void`.
**Исключения.** 0x80070057 при неверном формате строки или несоответствии алгоритму.
**Сайд-эффекты.** Нет.
**Локальные переменные.** нет.

### `CAdESCOM.RawSignature.SignHash`
**Назначение.** Выполнить подпись хэша напрямую, используя сертификат, найденный в пользовательском хранилище.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L8-L8】
**Параметры.** `hashedData: CAdESCOM.HashedData`, `certificate: CAdESCOM.Certificate`.
**Возвращает.** `string` — подпись в Base64.
**Исключения.** 0x80070057 при несогласованности параметров.
**Сайд-эффекты.** Обращается к контейнеру закрытого ключа.
**Локальные переменные.** нет.

### `CAdESCOM.RawSignature.VerifyHash`
**Назначение.** Проверить, что подпись соответствует переданному digest и сертификату, используя тот же алгоритм.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L8-L8】
**Параметры.** `hashedData`, `certificate`, `signature: string`.
**Возвращает.** `void`.
**Исключения.** 0x80070057 при несовпадении параметров.
**Сайд-эффекты.** Нет.
**Локальные переменные.** нет.

### `CAdESCOM.CPSigner.propset_Certificate`
**Назначение.** Назначить сертификат подписанта перед вызовом `SignHash` в формате CAdES-BES.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L11-L12】
**Параметры.** `certificate: CAdESCOM.Certificate`.
**Возвращает.** `void`.
**Исключения.** 0x80070057 при неподходящем сертификате.
**Сайд-эффекты.** Нет.
**Локальные переменные.** нет.

### `CAdESCOM.CPSigner.propset_CheckCertificate`
**Назначение.** Включить проверку сертификата при формировании подписи, чтобы не получить отказ по параметрам в процессе `SignHash`.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L12-L12】
**Параметры.** `flag: boolean`.
**Возвращает.** `void`.
**Исключения.** 0x80070057, если проверка завершается с ошибкой.
**Сайд-эффекты.** Может инициировать сетевые запросы к УЦ.
**Локальные переменные.** нет.

### `CAdESCOM.CadesSignedData.SignHash`
**Назначение.** Создать отделённую подпись BES над заранее подготовленным digest, требуя согласованные параметры алгоритма и signer.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L11-L13】
**Параметры.** `hashedData`, `signer: CAdESCOM.CPSigner`, `signatureType: number`.
**Возвращает.** `string` — PKCS#7 подпись.
**Исключения.** 0x80070057 при несоответствии digest/алгоритма.
**Сайд-эффекты.** Формирует контейнер подписи.
**Локальные переменные.** нет.

### `CAdESCOM.CadesSignedData.VerifyHash`
**Назначение.** Проверить отделённую подпись, используя те же параметры алгоритма и хэш, что и при подписании.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L13-L13】
**Параметры.** `hashedData`, `signature: string`, `signatureType: number`.
**Возвращает.** `void`.
**Исключения.** 0x80070057 при расхождении входов.
**Сайд-эффекты.** Нет.
**Локальные переменные.** нет.

## Описание исполнительной части кода
- Действия при импорте: нет.
- CLI/entrypoints: нет.
- Типичный вызов:
  1. Найти сертификат в пользовательском хранилище и подготовить `HashedData` с установленным алгоритмом ГОСТ.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L5-L8】
  2. Загрузить digest в формате шестнадцатеричных пар и подписать его через `RawSignature.SignHash` либо `CadesSignedData.SignHash` с теми же параметрами.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L7-L8】【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L11-L13】
  3. Проверить подпись `VerifyHash`, используя исходный `HashedData`; несогласованность приводит к ошибке 0x80070057.【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L8-L8】【F:docs/reference/crypto_pro/extracted/plugin_samples_sign_hash.md†L13-L13】
