# Массовый заказ карточек: как работает UI

Этот документ описывает основные механизмы, которые позволяют странице `index.html` оформлять заказ сразу по нескольким карточкам товара.

## 1. Поиск карточки (шаг 1)
1. Пользователь вводит GTIN и нажимает кнопку «Найти карточку» (`#findCardBtn`).
2. После успешного поиска функция `state.card` наполняется данными карточки, а блок `#cardInfo` становится видимым (заполняются название, теги и подробности).
3. В этом блоке находится поле количества `#cardQuantity` — именно оно определяет, сколько КМ попадёт в заказ при добавлении карточки.

## 2. Формирование списка заказа
1. Кнопка «Добавить карточку в заказ» (`#addCardBtn`) создаёт новый объект в массиве `state.orderItems` вида `{ gtin, goodId, templateId, name, productGroup, quantity }`.
2. После добавления вызывается `renderOrderItems()`:
   * функция очищает контейнер `#orderItemsList`,
   * для каждой карточки создаёт блок `.order-item` с названием, GTIN и дополнительными идентификаторами,
   * добавляет поле редактирования количества и кнопку удаления для строки.
3. Под списком выводится сводка `#orderItemsSummary`, которую обновляет `updateOrderItemsSummary()`.

## 3. Редактирование и контроль количества
* Поле количества внутри каждой карточки связано с состоянием через события `input` и `blur`. Валидация не позволяет опустить значение ниже 1.
* При каждом изменении пересчитывается общий итог КМ в `updateOrderItemsSummary()` и вызывается `updateStatus()` (отвечает за доступность кнопок отправки заказа).
* Кнопка «Удалить» убирает запись из `state.orderItems`, повторно рендерит список и пишет событие в лог.

## 4. Оформление заказа (шаг 2)
1. Когда пользователь нажимает кнопку «Отправить заказ», формируется payload на основе `state.orderItems`.
2. Каждый элемент массива переводится в формат, который ожидает бекенд: GTIN, `goodId`, `templateId`, количество и связанные параметры шага 2 (товарная группа, способ выпуска и т.д.).
3. Итоговый запрос уходит в `order.php`, а идентификатор последнего заказа сохраняется в `state.lastOrderId`.

## 5. Скачивание КМ
* Блок скачивания (`#downloadCodesBtn`) использует GTIN первой карточки в списке заказа, когда формирует запрос в `codes.php`.
* Полученные данные сохраняются в `state.buffers`, и при успешной операции формируется ссылка `state.downloadUrl` для выгрузки PDF/CSV.

## 6. Почему теперь можно заказать много карточек сразу
* Раньше в форме хранился только один `state.card` и одно количество.
* Сейчас все добавленные карточки живут в массиве `state.orderItems` — его можно наполнять, редактировать и чистить, не теряя уже введённые данные.
* Отправка заказа собирает данные сразу по всему массиву, поэтому бекенд получает единый заказ с несколькими позициями.

Эти функции находятся в нижней части `index.html` после основного HTML-шаблона и обеспечивают массовый заказ КМ без перезагрузки страницы.
