Источник: Guides-v16.0-11.07.2025-at-20-38-39.docx
Версия: 16.0 (11.07.2025)
Дата выгрузки: 2025-09-16
Инструмент: docx2txt 0.9

Инструкция по получению динамического клиентского токена (clientToken)

посредством обращения к методам единой аутентификации

Версия 16.0


Содержание

	1. Общее описание и назначение функциональности	3

	2. Получение уникального идентификатора соединения (внешнего подключения —omsConnection) посредством пользовательского интерфейса СУЗ	4

	3. Получение уникального идентификатора соединения (внешнего подключения — omsConnection) посредством регистрации установки интеграционного решения, используяAPI	8

	4. Получение динамического клиентского токена (clientToken) посредством обращения кметодам единой аутентификации	10

	5. Метод «Запрос регистрации установки экземпляра интеграционного решения»	11

	5.1. Запрос	11

	5.2. Ответ	13

	6. Получение клиентского токена посредством обращения к методам единой аутентификацииTrue API	15

	6.1. Запрос авторизации при единой аутентификации	15

	6.1.1. Запрос	15

	6.1.2. Ответ	15

	6.2. Получение аутентификационного токена	16

	6.2.1. Запрос	16

	6.2.2. Ответ	18

	Перечень сокращений, условных обозначений и терминов	20






Общее описание и назначение функциональности

Для получения динамического клиентского токена посредством обращения к методам единой аутентификации ГИС МТ предварительно получить уникальный идентификатор соединения (внешнего подключения — omsConnection) для установки интеграционного решения. Под динамическим токеном понимается токен с ограниченным по времени сроком действия.

На переходном этапе получение уникального идентификатора соединения (внешнего подключения — omsConnection) будет доступно двумя способами:

посредством пользовательского интерфейса СУЗ (см. раздел «Получение уникального идентификатора соединения (внешнего подключения — omsConnection) посредством пользовательского интерфейса СУЗ»);

посредством регистрации установки интеграционного решения, используя API (см. раздел «Получение уникального идентификатора соединения (внешнего подключения — omsConnection) посредством регистрации установки интеграционного решения, используя API»).

Доступ к функциональности ГИС МТ осуществляется в соответствии с

ВАЖНОролевой моделью. Информацию об ограничениях прав см. в «Памятке по

ролевой модели доступа Системы маркировки».



Получение уникального идентификатора соединения (внешнего подключения — omsConnection) посредством пользовательского интерфейса СУЗ

авторизоваться в СУЗ-Облако.

Участникам после авторизации в ГИС МТ под пользователем с ролью «Администратор» перейти в СУЗ, выбрав раздел «Управление заказами» в «Главном окне»;



Рисунок 1. Переход в СУЗ

после успешной авторизации в верхней панели меню «Главного окна» СУЗ перейти в раздел «Устройства».

Данный раздел доступен для просмотра и редактирования только пользователям с ролью

«Администратор»;



Рисунок 2. Кнопка «Устройства»

в разделе «Устройства» отображается весь список клиентских устройств.

Для зарегистрированных устройств уникальный идентификатор соединения (внешнего подключения — omsConnection) отображается в столбце «Идентификатор соединения» (у каждого устройства он разный), который используют при запросе динамического клиентского токена (clientToken) посредством обращения к методам единой аутентификации (см. раздел «Получение динамического клиентского токена (clientToken) посредством обращения к методам единой аутентификации»).



Рисунок 3. Cписок клиентских устройств участника

Для получения уникального идентификатора соединения (внешнего подключения — omsConnection) нового устройства добавить устройство самостоятельно;

уникальный идентификатор соединения (внешнего подключения — omsConnection), который используется для получения динамического клиентского токена посредством методов единой аутентификации (см. раздел «Получение динамического клиентского токена (clientToken) посредством обращения к методам единой аутентификации»), генерируется автоматически

(после создания устройства);

для добавления нового устройства нажать кнопку [ + Создать устройство ] в левом верхнем углу экрана и в открывшемся окне заполнить поля ввода данных (красным отмечены обязательные для заполнения поля):

◦ «Имя» — заполнить прямым вводом данных, указав наименование устройства;

◦ «Тип» — по умолчанию установлено значение «АСУ ТП» и не подлежит редактированию;

◦ «Режим отправки отчетов» — выбрать значение из выпадающего списка (по умолчанию установлено значение «Автоматически»).



Рисунок 4. Создание нового устройства

после заполнения формы нового устройства нажать кнопку [ Создать ]. При нажатии кнопки [ Отменить ] процедура добавления устройства прекращается.

Созданное устройство отобразится в списке клиентских устройств (см. иллюстрацию к п.3).

1. Устройство можно удалить, для этого в строке устройства через меню быстрых действий  нажать кнопку [ Удалить ].



Рисунок 5. Кнопка «Удалить»

Удаление подтвердить в модальном окне.



Рисунок 6. Подтверждение удаления


Получение уникального идентификатора соединения (внешнего подключения — omsConnection) посредством регистрации установки интеграционного решения, используя API

Альтернативным способом получения уникального идентификатора соединения (внешнего подключения — omsConnection) является регистрация установки интеграционного решения, используя API.

Получение уникального идентификатора соединения (внешнего подключения — omsConnection) через личный кабинет СУЗ описано в разделе «Получение уникального идентификатора соединения (внешнего подключения — omsConnection) посредством пользовательского интерфейса СУЗ».

Для получения уникального идентификатора соединения (внешнего подключения omsConnection) посредством регистрации установки интеграционного решения, используя API СУЗ, используемое интеграционное решение должно быть зарегистрировано Оператором (подробнее о регистрации см. в «Инструкции по работе с реестром партнёров и интеграторов»).

Регистрация интеграционных решений у Оператора на данный момент является добровольной. В процессе регистрации интеграционного решения выполняется проверка корректности взаимодействия с СУЗ интеграционного решения, предоставляются рекомендации по исправлению выявленных проблем и оптимизации взаимодействия. Основными заинтересованными лицами данного процесса являются системные интеграторы, разработчики и поставщики программного обеспечения, вместе с тем для участников оборота товаров, использующих собственные разработки, данная процедура также доступна и рекомендована.

При успешном завершении тестирования интеграционному решению выдается уникальный код (registrationKey), который используется в «Запросе регистрации установки экземпляра интеграционного решения» (см. пункт 1 ниже).

Вместе с тем, при необходимости владелец может ограничить доступ к информации о регистрации своего интеграционного решения.

Если интеграционное решение было зарегистрировано Оператором:

используя уникальный код регистрации интеграционного решения (registrationKey), сформировать запрос по методу «Запрос регистрации установки экземпляра интеграционного решения» (POST /api/v2/integration/connection?omsId={omsId}, см. раздел «Метод «Запрос регистрации установки экземпляра интеграционного решения»»), указав данные регистрируемой установки интеграционного решения;

отправить запрос по методу «Запрос регистрации установки экземпляра интеграционного решения» (POST /api/v2/integration/connection?omsId={omsId}) в СУЗ;

получить ответ на запрос. Если запрос был успешно обработан, то ответ будет содержать уникальный идентификатор соединения (внешнего подключения — omsConnection), который сохраняется для использования при запросе динамического клиентского токена (clientToken) посредством обращения к методам единой аутентификации (см. раздел «Получение динамического клиентского токена (clientToken) посредством обращения к методам единой аутентификации»).


Получение динамического клиентского токена (clientToken) посредством обращения к методам единой аутентификации

после получения уникального идентификатора соединения (внешнего подключения — omsConnection) сформировать запрос для получения идентификатора аутентификации и данных для подписи посредством True API (описание метода «Запрос авторизации при единой аутентификации» (GET /auth/key) см. в разделе «Получение клиентского токена посредством обращения к методам единой аутентификации True API»);

отправить запрос, сформированный на шаге 1, посредством True API;

получив ответ на запрос, отправленный на шаге 2, сформировать, используя уникальный идентификатор соединения (внешнего подключения — omsConnection), запрос для получения ключа сессии при единой аутентификации посредством True API (описание метода «Получение ключа сессии при единой аутентификации» (POST

/auth/simpleSignIn/{omsConnection}) см. в разделе «Получение клиентского токена посредством обращения к методам единой аутентификации True API»);

отправить запрос, сформированный на шаге 3, посредством True API;

при успешной обработке запроса, ответ будет содержать динамический клиентский токен

(clientToken), указав который в параметре HTTP-заголовка, можно направлять запросы к API СУЗ. При этом время действия клиентского токена, полученного посредством True API, – 10 часов.

Для каждой установки интеграционного решения доступно получение только одного токена, при повторном запросе клиентского токена для установки интеграционного решения действие ранее полученного токена прекращается и генерируется новый токен.

Примечание: после успешного обращения к API СУЗ с помощью клиентского токена, полученного посредством методов единой аутентификации (динамического клиентского токена), использование статичных клиентских токенов становится недоступным (должны использоваться только динамические токены).

Метод «Запрос регистрации установки экземпляра интеграционного решения»

Этот метод используется для отправки запроса на регистрацию установки экземпляра интеграционного решения в СУЗ.

Запрос регистрации установки экземпляра интеграционного решения должен быть подписан сертификатом участника оборота товаров.

Участник оборота товаров формирует запрос, подписывает его и формирует присоединённую или откреплённую подпись с использованием сертификата. Присоединённая или откреплённая подпись помещается в HTTP заголовок в параметр «X-Signature» в кодировке Base64. Для подписи используются данные, помещаемые в тело сообщения.

В данном разделе под <url стенда> подразумевается базовый адрес стенда, на котором размещено API для регистрации установки экземпляра интеграционного решения.

Доступны следующие адреса стендов для отправки запроса регистрации установки экземпляра интеграционного решения:

https://suz-integrator.sandbox.crpt.tech – базовый адрес демонстрационного контура. Для тестирования на демонстрационном контуре всем участникам доступен следующий код регистрации интеграционного решения — 4344d884-7f21-456c-981e-cd68e92391e8;

https://suzgrid.crpt.ru:16443 – базовый адрес продуктивного контура.

Запрос

URL: <url стенда>/api/v2/integration/connection?omsId={omsId}

Метод: POST

X-Signature: <Присоединённая или откреплённая подпись запроса>

X-RegistrationKey: <Уникальный код регистрации интеграционного решения>

Content-type: application/json;charset=UTF-8

Параметры заголовка запроса:

Параметр

Тип

Обяз.

Описание

Комментарий

X-Signature

string

+

Присоединённая или откреплённая подпись запроса



Параметр

Тип

Обяз.

Описание

Комментарий

Content-type

string

+

Content-

type:application/json;charset=

UTF-8



X-RegistrationKey

string

+

Уникальный код регистрации интеграционного решения



Параметры строки запроса:

Параметр

Тип

Обяз.

Описание

Комментарий

omsId

string

(UUID)

+

Уникальный идентификатор

СУЗ



Параметры тела запроса:

Параметр

Тип

Обяз.

Описание

Комментарий

address

string

+

Адрес установки экземпляра интеграционного решения



name

string

-

Наименование экземпляра интеграционного решения (внешнего подключения). Не должно дублировать наименования зарегистрированных у участника оборота товаров экземпляров интеграционного решения (внешнего подключения)

Если параметр не указан, то будет сгенерировано случайное наименование в формате UUID. Длина значения может состоять от 1 до 256 символов включительно

Пример запроса:

POST /api/v2/integration/connection?omsId=cdf12109-10d3-11e6-8b6f-0050569977a1

HTTP/1.1

Content-Type: application/json;charset=UTF-8

X-Signature: <Присоединённая или откреплённая подпись запроса>

X-RegistrationKey: cdf12109-10d3-11e6-8b6f-0050569977a1



{

    "address": "

г

.

Москва

, 

ул

. 

Тестовая

, 1",

{

    "address": "

г

.

Москва

, 

ул

. 

Тестовая

, 1",



    "name": "

Наименование

"

}

    "name": "

Наименование

"

}

Ответ

При успешном выполнении запроса сервер возвращает HTTP код 200 и статус регистрации установки экземпляра интеграционного решения.

Параметры ответа:

Параметр

Тип

Обяз.

Описание

status

string

+

Статус регистрации установки экземпляра интеграционного решения.

Принимает значения:

SUCCESS 	– 	обработка 	завершена успешно;

REJECTED – запрос отклонен

omsConnection

string (UUID)

-

Уникальный идентификатор соединения (внешнего подключения), присвоенный зарегистрированной установке интеграционного решения.

Содержится в ответе, если status =

SUCCESS

name

string

-

Наименование экземпляра интеграционного решения (внешнего подключения).

Содержится в ответе, если status =

SUCCESS

rejectionReason

string

-

Причина отклонения запроса на регистрацию установки экземпляра интеграционного решения.

Содержится в ответе, если status =

REJECTED

Примечание: для каждой установки интеграционного решения (omsConnection) доступно получение только одного токена, при повторном запросе клиентского токена для установки интеграционного решения (omsConnection) действие ранее полученного токена прекращается и генерируется новый токен.

Пример ответа:



HTTP/1.1 200 OK

Content-Type: application/json;charset=UTF-8

HTTP/1.1 200 OK

Content-Type: application/json;charset=UTF-8



{

    "status": "SUCCESS",

    "omsConnection": "ccc11111-11c1-11c1-1c1c-0000500000c0",

    "name": "

Наименование

"

}

{

    "status": "SUCCESS",

    "omsConnection": "ccc11111-11c1-11c1-1c1c-0000500000c0",

    "name": "

Наименование

"

}


Получение клиентского токена посредством обращения к методам единой аутентификации True API

В данном разделе описаны методы True API для получения клиентского токена, который используется при обращении к методам API СУЗ.

В данном разделе под <url стенда> подразумевается базовый адрес стенда, на котором размещено True API.

Доступны следующие адреса стендов:

базовые адреса демонстрационного контура:

◦ https://markirovka.sandbox.crptech.ru/api/v3/true-api;

◦ https://markirovka.sandbox.crptech.ru/api/v4/true-api;

базовые адреса промышленного контура: ◦ https://markirovka.crpt.ru/api/v3/true-api; ◦ https://markirovka.crpt.ru/api/v4/true-api.

Запрос авторизации при единой аутентификации

Этот метод используется для получения идентификатора аутентификации и данных для подписи УКЭП участника оборота товаров.

Запрос

URL: <url стенда>/auth/key

Метод: GET

Пример запроса:



GET /auth/key

GET /auth/key

Ответ

При успешном выполнении запроса сервер возвращает HTTP код 200, идентификатор сгенерированных случайных данных и данные для подписи.

Параметры ответа:

Параметр

Тип

Обяз.

Описание

uuid

string

+

Уникальный идентификатор сгенерированных случайных данных

data

string

+

Случайная строка данных

Пример ответа:



HTTP/1.1 200 OK

Content-Type: application/json;charset=UTF-8

HTTP/1.1 200 OK

Content-Type: application/json;charset=UTF-8



{

   "uuid":"a63ff582-b723-4da7-958b-453da27a6c62",

   "data":"GNUFBAZBMPIUUMLXNMIOGSHTGFXZM"

}

{

   "uuid":"a63ff582-b723-4da7-958b-453da27a6c62",

   "data":"GNUFBAZBMPIUUMLXNMIOGSHTGFXZM"

}

Получение аутентификационного токена

Этот метод используется для получения маркера безопасности (аутентификационного токена) для СУЗ. Для получения токена для СУЗ в метод добавлен параметр «omsConnection» — уникальный 	идентификатор 	соединения 	(внешнего 	подключения), 	присвоенный зарегистрированной установке интеграционного решения.

Запрос

URL: <url стенда>/auth/simpleSignIn/{omsConnection}

Метод: POST

Пример строки запроса:

curl -X POST "<url стенда>/auth/simpleSignIn/11b1abc1-f1ee-11db-1a11-f11ac11111e1"

 -H "accept: application/json"

 -H "Content-Type: application/json"

Параметры строки запроса:

Параметр

Тип

Обяз.

Описание

Комментарий

omsConnection

string

Должен быть указан для получения токена для доступа к API

СУЗ

Уникальный идентификатор соединения (внешнего подключения), присвоенный зарегистрированной установке интеграционного решения

Выдаётся при регистрации установки интеграционного решения

Примечание: на переходном этапе получение уникального идентификатора соединения (внешнего подключения — omsConnection) также будет доступно посредством регистрации в пользовательском 	интерфейсе 	СУЗ 	клиентского 	устройства 	(системы), 	которое 	будет взаимодействовать посредством API СУЗ.

Пример тела запроса:



{

   "uuid":"b223216d-5c43-416a-b2c3-39c79240c08a",

   "data":"<

Подписанные данные в 

base64>"

}

{

   "uuid":"b223216d-5c43-416a-b2c3-39c79240c08a",

   "data":"<

Подписанные данные в 

base64>"

}

Параметры тела запроса:

Параметр

Тип

Обяз.

Описание

Комментарий

uuid

string

+

Уникальный идентификатор подписанных случайных данных



data

string

+

Подписанные УКЭП зарегистрированного участника оборота товаров, случайные данные в base64 (электронная подпись присоединённая или откреплённая)



Параметр

Тип

Обяз.

Описание

Комментарий

inn

string

-

ИНН участника оборота товаров, под которым требуется авторизация для физического лица по машиночитаемой доверенности

Параметр заполняется для получения аутентификационн ого токена на конкретную организацию / индивидуального предпринимателя и только в случае, если пользователь, выполняющий

запрос, имеет активные машиночитаемые доверенности от разных организаций / индивидуальных предпринимателей. Длина значения: 10 или 12 цифр

Ответ

При успешном выполнении запроса сервер возвращает HTTP код 200 и токен.

Параметры ответа:

Параметр

Тип

Обяз.

Описание

token

string

-

Аутентификационный токен. Токен действителен 10 часов. Параметр указывается в случае успешного ответа

code

string

-

Код ошибки

error_message

string

-

Сообщение об ошибке

description

string

-

Описание ошибки

Пример ответа:



HTTP/1.1 200 OK

Content-Type: application/json;charset=UTF-8

HTTP/1.1 200 OK

Content-Type: application/json;charset=UTF-8



{

   "token":"2f2222c2-cbc2-22ff-bc2c-2222222fbef2"

}

{

   "token":"2f2222c2-cbc2-22ff-bc2c-2222222fbef2"

}


Перечень сокращений, условных обозначений и терминов

Сокращение, условное обозначение, термин

Описание

API

Application Programming Interface (интерфейс программирования приложений) — программный интерфейс приложения, набор готовых классов, процедур, функций, структур и констант, предоставляемых приложением (библиотекой, сервисом) или операционной системой для использования во внешних программных продуктах

ГИС МТ

Государственная информационная система, созданная в целях автоматизации процессов сбора и обработки информации об обороте товаров, подлежащих обязательной маркировке средствами идентификации, хранения такой информации, обеспечения доступа к ней, её предоставления и распространения, повышения эффективности обмена такой информацией и обеспечения прослеживаемости указанных товаров, а также в иных целях, предусмотренных федеральными законами



Сокращение, условное обозначение, термин

Описание

Оператор

Частный партнёр, действующий в качестве Оператора Единой системы маркировки в соответствии с распоряжением Правительства РФ от 8 мая 2019 г. № 899-р «О реализации проекта государственно-частного партнёрства, заключаемого в целях создания, эксплуатации и технического обслуживания объекта, предназначенного для обеспечения маркировки и прослеживаемости отдельных видов товаров» (https://честныйзнак.рф), распоряжением Правительства Российской Федерации от 3 апреля 2019 г. № 620-р «Об операторе государственной информационной системы мониторинга за оборотом товаров, подлежащих обязательной маркировке», и распоряжением № 2828-р от 18 декабря 2019 года

СУЗ

Станция управления заказами кодов маркировки

УКЭП

Усиленная квалифицированная электронная подпись, обладающая дополнительными признаками защищённости: ключом проверки и подтверждёнными средствами электронной подписи



3

19



20

5