# СУЗ‑Облако 4.0 — API СУЗ 3.0 (Полный Markdown по разделам)

> Документ: «СУЗ‑Облако 4.0. СПО. Руководство программиста» (API СУЗ 3.0)  
> Формат: Полностью структурированный Markdown с оглавлением и якорями.

---

## Оглавление

- [Аннотация](#annotation)
- [1. Назначение программы](#sec-1)
  - [1.1. Назначение](#sec-1-1)
  - [1.2. Функции программы](#sec-1-2)
- [2. Условия применения программы](#sec-2)
  - [2.1. Используемые технические средства](#sec-2-1)
    - [2.1.1. Требования к ПЭВМ (КТС)](#sec-2-1-1)
    - [2.1.2. Требования к ПЭВМ для «Модуля Web‑интерфейса»](#sec-2-1-2)
  - [2.2. Необходимое программное обеспечение](#sec-2-2)
    - [2.2.1. ПО для компонентов на КТС](#sec-2-2-1)
    - [2.2.2. ПО для «Модуля Web‑интерфейса»](#sec-2-2-2)
  - [2.3. Информационное обеспечение](#sec-2-3)
    - [2.3.1. Общие требования к подписанию запросов](#sec-2-3-1)
    - [2.3.2. Формирование GS1 DataMatrix](#sec-2-3-2)
    - [2.3.3. Требования к обработке JSON/XML](#sec-2-3-3)
- [3. Характеристики программы](#sec-3)
  - [3.1. Показатели назначения](#sec-3-1)
- [4. API СУЗ (основные процессы и REST‑методы)](#sec-4)
  - [4.1. Общие сведения](#sec-4-1)
  - [4.2. Бизнес‑процессы](#sec-4-2)
    - [4.2.X. «Получить КМ из заказа» (01.03.00.00)](#sec-4-2-get-codes)
  - [4.3. Справки/Шаблоны КМ (ссылка на раздел 5.3.1.4)](#sec-4-3)
  - [4.4. Методы (фрагменты наиболее используемых)](#sec-4-4)
    - [4.4.1. Заказ КМ (Order)](#sec-4-4-1)
    - [4.4.2. Получить статус массивов КМ по заказу](#sec-4-4-2)
    - [4.4.10. Отправить отчёт об агрегации КМ](#sec-4-4-10)
    - [4.4.11. Отправить отчёт об использовании (нанесении) КМ](#sec-4-4-11)
      - [4.4.11.1. Атрибуты `UtilisationReport` по ТГ](#sec-4-4-11-1)
        - [4.4.11.1.1. Табачная продукция](#sec-4-4-11-1-1)
        - [… другие ТГ (ветфарма, молочная и т.д.)](#sec-4-4-11-1-more)
      - [4.4.11.X. «Пересорт» (beer) — пример запроса](#sec-4-4-11-resort)
      - [Указание фактического веса (templateId=20, AI=3103)](#sec-4-4-11-weight)
    - [4.4.21. Поиск документов](#sec-4-4-21)
    - [4.4.22. Получить содержимое документа](#sec-4-4-22)
    - [4.4.24. Отправить подписанный документ](#sec-4-4-24)
    - [4.4.25. Проверить доступность СУЗ (ping)](#sec-4-4-25)
- [5. Справочники (фрагменты)](#sec-5)
  - [5.3.1. Справочные разделы (выдержки)](#sec-5-3-1)
- [9. Авторизация и аутентификация](#sec-9)
  - [9.1. Получение клиентского токена (процессы)](#sec-9-1)
  - [9.2. Регистрация установки интеграционного решения](#sec-9-2)
  - [9.3. Получение клиентского токена через единую аутентификацию](#sec-9-3)
- [10. Квитирование 2.0 (фрагменты)](#sec-10)
- [История изменений (выдержки)](#sec-history)

---

<a id="annotation"></a>
## Аннотация

Документ предназначен для ознакомления с функциями API специального программного обеспечения автоматизированной системы «СУЗ‑Облако 4.0» (далее — СУЗ), описывает бизнес‑процессы и REST‑методы для заказа и управления кодами маркировки, отчётами (нанесение, агрегация, отбраковка), поиском и получением документов, а также правила аутентификации и квитирования.

---

<a id="sec-1"></a>
## 1. Назначение программы

<a id="sec-1-1"></a>
### 1.1. Назначение
СУЗ обеспечивает размещение заказов на КМ, их получение, регистрацию отчётов об использовании/нанесении и агрегации, управление документами и взаимодействие с внешними системами.

<a id="sec-1-2"></a>
### 1.2. Функции программы
Основные функции: создание заказов на КМ, проверки и статусы заказов, отчёты (нанесение/агрегация/отбраковка), поиск и получение документов, сервисные методы (ping), а также квитирование событий и авторизация.

---

<a id="sec-2"></a>
## 2. Условия применения программы

<a id="sec-2-1"></a>
### 2.1. Используемые технические средства
Требования к ПЭВМ/серверу и к компонентам «Модуля Web‑интерфейса» определены для корректной работы компонентов СУЗ‑Облако 4.0.

<a id="sec-2-1-1"></a>
#### 2.1.1. Требования к ПЭВМ (КТС)
*(см. исходный документ для детализированных характеристик)*

<a id="sec-2-1-2"></a>
#### 2.1.2. Требования к ПЭВМ для «Модуля Web‑интерфейса»
*(см. исходный документ для детализированных характеристик)*

<a id="sec-2-2"></a>
### 2.2. Необходимое программное обеспечение

<a id="sec-2-2-1"></a>
#### 2.2.1. ПО для компонентов на КТС
*(перечень ОС/ПО см. оригинал)*

<a id="sec-2-2-2"></a>
#### 2.2.2. ПО для «Модуля Web‑интерфейса»
*(перечень компонентов см. оригинал)*

<a id="sec-2-3"></a>
### 2.3. Информационное обеспечение

<a id="sec-2-3-1"></a>
#### 2.3.1. Общие требования к подписанию запросов
Запросы должны быть подписаны откреплённой подписью (Base64), заголовок `X-Signature`. Дополнительные поля безопасности — `Authorization: token {token_id}` (для ТГ ЛП) либо `clientToken` (маркер безопасности).

<a id="sec-2-3-2"></a>
#### 2.3.2. Формирование GS1 DataMatrix
При формировании GS1 DataMatrix перед конвертацией в двумерный символ добавляйте признак символики **ASCII 232** в начало формируемой строки кода маркировки, иначе средства распознавания не идентифицируют код корректно. См. спецификации GS1 General Specification и GS1 DataMatrix Guideline.  

<a id="sec-2-3-3"></a>
#### 2.3.3. Требования к обработке JSON/XML
КОДы маркировки содержат специальные символы — используйте средства обработки JSON строго по **RFC 8259** (не как «plain text»); для XML — экранирование по спецификациям XML. Это гарантирует корректную передачу/приём КМ со спецсимволами.

---

<a id="sec-3"></a>
## 3. Характеристики программы

<a id="sec-3-1"></a>
### 3.1. Показатели назначения
Показатели назначения (например, перечень показателей для СУЗ‑Облако 4.0) приведены в таблицах исходного документа.

---

<a id="sec-4"></a>
## 4. API СУЗ (основные процессы и REST‑методы)

<a id="sec-4-1"></a>
### 4.1. Общие сведения
API СУЗ опирается на идентификатор СУЗ `omsId` (UUID, ISO/IEC 9834‑8), маркер безопасности `clientToken` или заголовок `Authorization: token {token_id}` (для ТГ «ЛП»), и откреплённую подпись `X-Signature` (кроме ТГ «ЛП»).

<a id="sec-4-2"></a>
### 4.2. Бизнес‑процессы

<a id="sec-4-2-get-codes"></a>
#### 01.03.00.00 «Получить КМ из заказа» (фрагмент)
Сценарий: система формирует запрос на получение КМ из заказа → СУЗ валидирует запрос → формирует массив эмитированных КМ → возвращает ответ → система обрабатывает ошибки/данные и при необходимости запрашивает следующие партии. Диаграмма процесса и шаги — в исходном документе.

<a id="sec-4-3"></a>
### 4.3. Справки/Шаблоны КМ
Справочник «Шаблоны КМ» по ТГ — в разделе 5.3.1.4 (поддерживаются разные `templateId`, включая templateId=20 для молочной продукции и др.).

<a id="sec-4-4"></a>
### 4.4. Методы (фрагменты наиболее используемых)

<a id="sec-4-4-1"></a>
#### 4.4.1. Заказ КМ (Order) — (фрагменты полей и примечаний)
Объект `Order` и связанные структуры (`OrderProduct` и т.д.). Для ряда ТГ используется атрибут `paymentType` (платность). Требования к серийным номерам, длинам, допустимым значениям атрибутов — см. соответствующие подпункты для ТГ.

<a id="sec-4-4-2"></a>
#### 4.4.2. Получить статус массивов КМ по заказу (пример ответа)
```http
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
{
  "omsId": "cdf12109-10d3-11e6-8b6f-0050569977a1",
  "orderInfos": [{
    "orderId": "b024ae09-ef7c-449e-b461-05d8eb116c79",
    "orderStatus": "READY",
    "createdTimestamp": 1550650989568,
    "productGroup": "vetpharma",
    "buffers": [{
      "leftInBuffer": 20,
      "totalCodes": 20,
      "unavailableCodes": 0,
      "gtin": "01334567894339",
      "bufferStatus": "ACTIVE",
      "templateId": 50
    }]
  }]
}
```
В ответе возвращаются статусы заказов и буфера КМ (см. «Формат ответа» в документе).

<a id="sec-4-4-10"></a>
#### 4.4.10. Отправить отчёт об агрегации КМ
**Назначение:** передать отчёт об агрегации в СУЗ. Формат запроса/ответа, коды ошибок — см. оригинал. В ошибках могут встречаться коды типа `13`, `21`, `24`, `31`, `44`, `46`, `56`, `62`, `66` и т. д. (см. справочник кодов обработки).

<a id="sec-4-4-11"></a>
#### 4.4.11. Отправить отчёт об использовании (нанесении) КМ

**Заголовки (общие):**
- `Content-Type: application/json`
- `Accept: application/json`
- `Authorization: token {token_id}` — для ТГ ЛП, если нет `clientToken`
- `clientToken: {uuid}` — маркер безопасности (если нет `Authorization`)
- `X-Signature: {подпись Base64}` — откреплённая подпись (кроме ТГ ЛП)

**Query:** `omsId={UUID}` — идентификатор СУЗ (UUID, ISO/IEC 9834‑8).

**Тело (`UtilisationReport` общая структура):**
```json
{
  "productGroup": "tobacco|beer|milk|...",
  "utilisationType": "UTILISATION|RESORT|REMARK",
  "sntins": ["<полные коды маркировки с кодом проверки>", "..."],
  "attributes": { "attribute1": "value1", "attribute2": "value2" }
}
```
> Примечание: `sntins` **всегда** передаются полными КМ **с кодом проверки**. Максимум КМ в отчёте — 30 000.  
> Для молочной продукции (templateId=20) допускается указание фактического веса (см. ниже).

<a id="sec-4-4-11-1"></a>
##### 4.4.11.1. Атрибуты `UtilisationReport` по ТГ (фрагмент)

<a id="sec-4-4-11-1-1"></a>
###### 4.4.11.1.1. Табачная продукция — пример
```http
POST /api/v3/utilisation?omsId=CDF12109-10D3-11E6-8B6F-0050569977A1
Accept: application/json
clientToken: 1cecc8fb-fb47-4c8a-af3d-d34c1ead8c4f
Content-Type: application/json
X-Signature: {подпись}

{
  "productGroup": "tobacco",
  "sntins": [
    "0123859334576487215Lo/hON\u001d8005123456\u001d93dGVz",
    "0123859334576487215wJTxjr\u001d8005123456\u001d93dGVz"
  ],
  "attributes": {
    "productionOrderId": "123",
    "productionDate": "2021-10-13T17:50:02±0550",
    "brandcode": "2212Brandcode",
    "kpp": "123456789",
    "sourceReportId": "8ed74f90-0119-48f2-b289-379707934e2f"
  }
}
```
Описание поля `attributes` — см. таблицу для ТГ «Табачная продукция».

<a id="sec-4-4-11-1-more"></a>
###### … Другие ТГ
Для каждой ТГ приводятся собственные требования к атрибутам (`productionDate`, `batchNumber`, `seriesNumber`, `alcoholVolume`, `paymentGroup`, и т. п.).

<a id="sec-4-4-11-resort"></a>
##### «Пересорт» (beer) — пример REST‑запроса
```http
POST /api/v3/utilisation?omsId=cdf12109-10d3-11e6-8b6f-0050569977a1
Accept: application/json
clientToken: 1cecc8fb-fb47-4c8a-af3d-d34c1ead8c4f
Content-Type: application/json
X-Signature: {подпись}

{
  "productGroup": "beer",
  "utilisationType": "RESORT",
  "sntins": [
    "0123859334576487215ew3212\u001d93dGVz\u001e0123859334576487215nm3212\u001d93dGVz",
    "0123859334576487215235egd\u001d93123w\u001e0123859334576487215ui3456\u001d93123w"
  ],
  "attributes": {
    "participantId": "1123456789",
    "kpp": "1234567898"
  }
}
```
Требования: обязательный `participantId`, условно обязательные `kpp` (ЮЛ) или `fiasId` (ИП); отсутствуют `productionDate`, `expirationDate`, `alcoholVolume`, `documentNumber`, `documentDate`. Коды в `sntins` — строго в заданном формате.

<a id="sec-4-4-11-weight"></a>
##### Указание фактического веса (templateId=20, AI=3103)
Для молочной продукции фактический вес указывается в структуре КМ после обязательных групп данных с использованием AI=`3103` (десятичная точка подразумевается после трёх знаков). В отчёте возможны коды как с весом, так и без него.

<a id="sec-4-4-21"></a>
#### 4.4.21. Поиск документов
Метод ищет документы УОТ в статусах: `CREATED` (заказ), `DRAFT|PENDING` (отчет о нанесении), `PENDING` (агрегация/отбраковка), `PENDING` (уведомление о принятии к учету). Для просмотра содержимого используйте метод 4.4.22.

<a id="sec-4-4-22"></a>
#### 4.4.22. Получить содержимое документа — пример ответа
```http
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8

{
  "docId": "04990484-55f3-4289-96f0-ca8bdd2c9e8d",
  "productGroup": "milk",
  "documentType": "ORDER",
  "status": "CREATED",
  "createdTimestamp": 1644232918197,
  "content": "<Документ в формате base64>"
}
```
Поля ответа: `docId`, `productGroup`, `documentType (ORDER|UTILISATION_REPORT|AGGREGATION_REPORT|DROPOUT_REPORT)`, `status`, `createdTimestamp`, `content` (base64).

<a id="sec-4-4-24"></a>
#### 4.4.24. Отправить подписанный документ (фрагмент ответа)
```http
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8

{"success": true}
```
Тело запроса: `docId` (UUID), `signature` (Base64, откреплённая).

<a id="sec-4-4-25"></a>
#### 4.4.25. Проверить доступность СУЗ (ping)
**Запрос:**
```http
GET /api/v3/ping?omsId={UUID}
Accept: application/json
clientToken: {uuid}   # либо Authorization: token {token_id} для ТГ ЛП
```
**Ответ:**
```json
{
  "omsId":"cdf12109-10d3-11e6-8b6f-0050569977a1",
  "apiVersion": "2.0.0.54",
  "omsVersion": "3.1.8.0"
}
```

---

<a id="sec-5"></a>
## 5. Справочники (фрагменты)
- **HTTP заголовки для отчётов**: `Content-Type`, `Accept`, `Authorization token` (для ЛП) или `clientToken`, `X-Signature` (кроме ЛП).  
- **Query**: `omsId` — UUID.  
- **Справочники**: «Шаблоны КМ», «Типы документов», «Статусы документов/заказов», «Причины выбытия/возврата», «Способы выпуска», «Коды результата обработки КМ» и др.

---

<a id="sec-9"></a>
## 9. Авторизация и аутентификация (выдержки)

<a id="sec-9-1"></a>
### 9.1. Получение клиентского токена (процессы)
- 01.00.00.00 — Зарегистрировать установку интеграционного решения в СУЗ.  
- 01.00.00.01 — Получить клиентский токен посредством ГИС МТ *(помечено как исключённое из актуальной редакции)*.  
- 01.00.00.02 — Получить клиентский токен посредством ИС МДЛП.

<a id="sec-9-2"></a>
### 9.2. Регистрация установки экземпляра интеграционного решения
Метод «Запрос регистрации установки экземпляра интеграционного решения» (запрос/ответ).

<a id="sec-9-3"></a>
### 9.3. Клиентский токен через единую аутентификацию
- 9.3.1 — Через ИС МДЛП: получить код аутентификации → получить ключ сессии.  
- 9.3.2 — Через True API: `GET /auth/key` (код/uuid), затем `POST /auth/simpleSignIn` (получение токена).

---

<a id="sec-10"></a>
## 10. Квитирование 2.0 (фрагменты)
- Описание пользовательских данных событий (например, `CREATE_ORDER`, `CREATE_ORDER_VALIDATION`, `CREATE_ORDER_VALIDATION_RESULT` и др.).  
- Метод «Получить связанный с квитанцией документ» возвращает контент связанного документа в виде строки; возможны JSON‑структуры с массивом `cisList` (код КМ, код результата, комментарий).

---

<a id="sec-history"></a>
## История изменений (выдержки)
Документ содержит подробную историю изменений по версиям (например: 4.30, 4.35, 4.37, 4.40, 4.47 и др.), в том числе добавление атрибутов и ТГ, корректировки обязательности полей, примечания по отчётам и т. п.

---

### Примечания по навигации и использованию
- Внутренние якоря оформлены как GitHub‑совместимые `#`‑заголовки.  
- Блоки кода используют ```http / ```json.  
- Для полной детализации полей/таблиц по каждой ТГ ориентируйтесь на исходный документ — в данном Markdown сведены ключевые и часто используемые разделы, чтобы быстро сориентироваться и собрать корректные REST‑запросы.

