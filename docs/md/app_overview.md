# Обзор проекта ms_chz_projekt

## Общая архитектура
- **Frontend (`index.html`)** — одностраничное приложение на чистом JavaScript. Управляет состоянием (выбор сертификата, статусы авторизации, найденная карточка товара, последние заказы и буферы).
- **CryptoPro плагин (`cadesplugin_api.js`)** — обёртка над браузерным плагином для формирования CAdES-подписей (attached и detached).
- **Backend (PHP скрипты)** — набор эндпоинтов, которые проксируют запросы в API Честного знака, хранят токены в сессии и добавляют подпись в заголовки. Общие функции и конфигурация вынесены в `config.php`.
- **Документация (`docs/`)** — локальные заметки по API и рабочему процессу заказов/буферов.

## Поток работы фронтенда
1. При загрузке страницы `init()` подключает плагин, читает сохранённые токены и OMS-настройки через `auth.php?action=status`, подставляет их в интерфейс.
2. `loadCertificates()` открывает хранилище сертификатов пользователя, фильтрует только действующие и отображает их в выпадающем списке.
3. Авторизация в НК и СУЗ:
   - `authNkBtn` → `signAttached(challenge, cert)` и `auth.php?action=nk-signin`.
   - `authSuzBtn` → `signAttached(challenge, cert)` и `auth.php?action=suz-signin` c передачей OMS connection/ID.
4. Поиск карточки (`card.php`) требует активный НК-токен; ответ хранится в `state.card` и используется при создании заказа.
5. Создание заказа (`createOrderBtn`) формирует JSON-платёж, подписывает его откреплённой подписью (`signDetached`) и отправляет в `order.php`. После успешного ответа сохраняется `orderId` и обновляются буферы.
6. Дополнительные действия: загрузка буферов (`codes.php`), проверка статуса (`order_status.php`), отправка отчёта о вводе в оборот (`utilisation.php`). Каждое действие проверяет наличие `clientToken` и OMS ID.
7. Логи выводятся во всплывающем блоке и дублируются в консоль.

## Ключевые функции JavaScript
- `log(message)` — добавляет строку в журнал на странице и выводит в консоль.
- `req(url, options)` — обёртка над `fetch` с обработкой ошибок API.
- `signAttached(data, cert)` — создаёт CAdES BES-подпись с включённым содержимым (используется для челенджей).
- `signDetached(data, cert)` — формирует откреплённую подпись тела HTTP-запроса (используется для заказов, отчётов и других POST-запросов).
- `updateStatus()` — синхронизирует интерфейс (активность токенов, выбранный сертификат, наличие карточки/буферов).

## Важные моменты по подписям
- CryptoPro ожидает, что `CadesSignedData` будет получать бинарные данные. Поэтому JSON перед отправкой в `propset_Content` кодируется в base64, а `ContentEncoding` устанавливается в `CADESCOM_BASE64_TO_BINARY`.
- Метод `signDetached` всегда возвращает подпись без переводов строк и пробелов — это критично, потому что заголовок `X-Signature` не допускает пробелов.

## PHP-слой
- `config.php`
  - Определяет базовые URL API, стартует сессию.
  - Содержит вспомогательные функции `apiRequest*`, централизованное логирование (`appLog`) и работу с сессионными токенами/OMS данными.
- `auth.php`
  - Обрабатывает авторизацию в НК/СУЗ, сохраняет токены в сессии и выдаёт статус.
  - Позволяет сохранить OMS connection/id.
- `card.php`
  - Вызывает `/nk/feed-product` и преобразует ответ к компактной структуре карточки.
- `order.php`
  - Принимает JSON заказа и заголовок `X-Signature`, проксирует запрос в СУЗ.
  - Логирует длину тела и подписи для отладки.
- `order_status.php`
  - Получает текущие заказы/буферы по `orderId` и/или `gtin`.
- `codes.php`
  - Загружает файлы буферов (CSV/JSON), возвращая их содержимое в Base64.
- `utilisation.php`
  - Отправляет отчёт о нанесении с подписью и clientToken.

## Логи и отладка
- Все PHP-эндпоинты используют `appLog` для записи диагностической информации в `logs/app.log` (создаётся автоматически).
- Ошибки API дополнительно пишутся в системный `error_log` (доступен в stdout контейнера).

Этот файл можно дополнять по мере расширения функциональности интерфейса или изменения API.
