<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ó–∞–∫–∞–∑ –ö–ú</title>
    <script src="cadesplugin_api.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #1a202c;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }
        
        .step {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .step h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #2d3748;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .status.inactive {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status.active {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        input[type="checkbox"] {
            width: auto;
            height: auto;
            margin: 0;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn-secondary {
            background: #edf2f7;
            color: #2d3748;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #e2e8f0;
        }
        
        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .card-info {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .card-info h3 {
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .card-info .pill {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
        }

        .auth-summary {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .summary-list {
            list-style: none;
            display: grid;
            gap: 0.35rem;
            padding: 0;
            margin: 0;
        }

        .summary-list li {
            font-weight: 600;
            color: #4a5568;
        }

        .summary-note {
            font-size: 0.85rem;
            color: #718096;
        }
        
        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .mini-log {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-x: auto;
            min-height: 160px;
        }

        .hint {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-top: 0.25rem;
        }

        body.modal-open {
            overflow: hidden;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 1000;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: #ffffff;
            border-radius: 16px;
            width: 100%;
            max-width: 520px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.45);
            transform: translateY(20px);
            transition: transform 0.2s ease;
        }

        .modal-backdrop.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin-bottom: 0;
            font-size: 1.4rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #4a5568;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .modal-section h3 {
            font-size: 1rem;
            color: #2d3748;
        }

        .modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .grid.grid-small {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        label.checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 0;
            color: #4a5568;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üéØ –ó–∞–∫–∞–∑ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏</h1>
    <p class="subtitle">–ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ –°–£–ó —á–µ—Ä–µ–∑ True API</p>
    
    <!-- –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="step">
        <h2>–®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>

        <div class="card-info auth-summary">
            <h3>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</h3>
            <ul class="summary-list">
                <li id="nkSummary">üî¥ –¢–æ–∫–µ–Ω –ù–ö –Ω–µ –ø–æ–ª—É—á–µ–Ω</li>
                <li id="suzSummary">üî¥ –¢–æ–∫–µ–Ω –°–£–ó –Ω–µ –ø–æ–ª—É—á–µ–Ω</li>
                <li id="omsSummary">üî¥ OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</li>
            </ul>
            <p class="summary-note" id="certSummary">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: –Ω–µ –≤—ã–±—Ä–∞–Ω</p>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" id="openSettingsBtn" type="button">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
        </div>
    </div>
    
    <!-- –®–∞–≥ 2: –ö–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="step">
        <h2>–®–∞–≥ 2: –ù–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞</h2>
        
        <div class="form-group">
            <label>GTIN —Ç–æ–≤–∞—Ä–∞</label>
            <input type="text" id="gtinInput" placeholder="04601234567890">
        </div>
        
        <button class="btn btn-secondary" id="findCardBtn">–ù–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É</button>
        
        <div class="card-info" id="cardInfo" style="display: none;">
            <h3 id="cardName"></h3>
            <div id="cardPills"></div>
            <p id="cardDetails" style="margin-top: 0.5rem; color: #718096;"></p>
        </div>
    </div>
    
    <!-- –®–∞–≥ 3: –ó–∞–∫–∞–∑ -->
    <div class="step">
        <h2>–®–∞–≥ 3: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–∫–∞–∑–∞</h2>

        <div class="grid">
            <div class="form-group">
                <label>–¢–æ–≤–∞—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞</label>
                <select id="productGroup">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    <option value="lp">–õ–µ–≥–∫–∞—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å</option>
                    <option value="shoes">–û–±—É–≤—å</option>
                    <option value="tobacco">–¢–∞–±–∞–∫</option>
                    <option value="pharma">–õ–µ–∫–∞—Ä—Å—Ç–≤–∞</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ú</label>
                <input type="number" id="quantity" value="1" min="1">
            </div>
        </div>
        
        <div class="form-group">
            <label>–°–ø–æ—Å–æ–± –≤—ã–ø—É—Å–∫–∞</label>
            <select id="releaseMethod">
                <option value="PRODUCTION">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ –≤ –†–§</option>
                <option value="IMPORT">–ò–º–ø–æ—Ä—Ç</option>
                <option value="REMAINS">–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤</option>
            </select>
        </div>

        <div class="form-group" id="lpAttributes" style="display: none;">
            <label>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø–ª–∞—Ç—ã –¥–ª—è –æ–¥–µ–∂–¥—ã</label>
            <div class="grid grid-small">
                <label class="checkbox">
                    <input type="checkbox" id="lpFreeCode">
                    –ö–ú –Ω–µ –ø–æ–¥–ª–µ–∂–∏—Ç –æ–ø–ª–∞—Ç–µ (freeCode)
                </label>
                <div>
                    <label for="lpPaymentType">–¢–∏–ø –æ–ø–ª–∞—Ç—ã</label>
                    <select id="lpPaymentType">
                        <option value="1">–û–ø–ª–∞—Ç–∞ –ø–æ —ç–º–∏—Å—Å–∏–∏</option>
                        <option value="2" selected>–û–ø–ª–∞—Ç–∞ –ø–æ –Ω–∞–Ω–µ—Å–µ–Ω–∏—é</option>
                    </select>
                    <p class="hint">–ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ç–æ–≤–∞—Ä–Ω–æ–π –≥—Ä—É–ø–ø—ã –æ–¥–µ–∂–¥—ã.</p>
                </div>
            </div>
        </div>

        <button class="btn btn-primary" id="createOrderBtn" disabled>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <!-- –®–∞–≥ 4: –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ -->
    <div class="step">
        <h2>–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h2>

        <div class="form-group">
            <label>ID –∑–∞–∫–∞–∑–∞</label>
            <input type="text" id="orderIdInput" placeholder="UUID –∑–∞–∫–∞–∑–∞">
            <p class="hint">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" id="statusBtn" disabled>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            <button class="btn btn-secondary" id="listOrdersBtn" disabled>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</button>
        </div>

        <div class="card-info" style="margin-top: 1rem;">
            <h3>–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤</h3>
            <pre class="mini-log" id="statusOutput">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞.</pre>
        </div>
    </div>

    <!-- –®–∞–≥ 5: –ü–æ–ª—É—á–∏—Ç—å –ö–ú -->
    <div class="step">
        <h2>–®–∞–≥ 5: –ü–æ–ª—É—á–∏—Ç—å –º–∞—Å—Å–∏–≤—ã –ö–ú</h2>

        <div class="form-group">
            <label>–ë—É—Ñ–µ—Ä</label>
            <select id="bufferSelect" disabled>
                <option>–ë—É—Ñ–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>
            </select>
            <p class="hint">–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–∞.</p>
        </div>

        <div class="grid">
            <div class="form-group">
                <label>GTIN –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ö–ú</label>
                <input type="text" id="codeGtin" placeholder="04601234567890" maxlength="14">
                <p class="hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GTIN –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞. –§–æ—Ä–º–∞—Ç ‚Äî 14 —Ü–∏—Ñ—Ä.</p>
            </div>

            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ú –∑–∞ –∑–∞–ø—Ä–æ—Å</label>
                <input type="number" id="codeQuantity" value="1000" min="1" max="150000">
                <p class="hint">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 150‚ÄØ000 –ö–ú.</p>
            </div>

            <div class="form-group">
                <label>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞</label>
                <select id="codeFormat">
                    <option value="CSV">CSV</option>
                    <option value="JSON">JSON</option>
                </select>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" id="downloadCodesBtn" disabled>–°–∫–∞—á–∞—Ç—å –ö–ú</button>
            <a class="btn btn-secondary" id="downloadLink" style="display: none;" download>–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>
        </div>
    </div>

    <!-- –®–∞–≥ 6: –í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç -->
    <div class="step">
        <h2>–®–∞–≥ 6: –û—Ç—á—ë—Ç –æ –Ω–∞–Ω–µ—Å–µ–Ω–∏–∏ (–≤–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç)</h2>
        <p class="hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–Ω—ã–µ –ö–ú (sntins) –∏–∑ –±—É—Ñ–µ—Ä–∞. –ú–∞–∫—Å–∏–º—É–º 30 000 –ö–ú –∑–∞ –∑–∞–ø—Ä–æ—Å.</p>

        <textarea id="utilisationPayload">{
  "productGroup": "",
  "utilisationType": "UTILISATION",
  "sntins": [
    ""
  ],
  "attributes": {}
}</textarea>

        <div class="btn-group" style="margin-top: 1rem;">
            <button class="btn btn-primary" id="sendUtilisationBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
        </div>
    </div>

    <!-- –õ–æ–≥ -->
    <div class="log" id="log">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</div>
</div>

<div class="modal-backdrop" id="settingsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal-header">
            <h2 id="settingsTitle">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OMS</h2>
            <button class="modal-close" id="closeSettingsBtn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <h3>–°—Ç–∞—Ç—É—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                <div class="status inactive" id="nkStatus">
                    <span>üî¥</span>
                    <span>–¢–æ–∫–µ–Ω –ù–ö: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>
                </div>
                <div class="status inactive" id="suzStatus">
                    <span>üî¥</span>
                    <span>–¢–æ–∫–µ–Ω –°–£–ó: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>
                </div>
                <div class="status inactive" id="omsStatus">
                    <span>üî¥</span>
                    <span>OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</span>
                </div>
            </div>

            <div class="modal-section">
                <h3>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ —Ç–æ–∫–µ–Ω—ã</h3>
                <div class="form-group">
                    <label>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –£–ö–≠–ü</label>
                    <select id="certSelect" disabled>
                        <option>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã...</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="loadCertsBtn" type="button">–û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</button>
                    <button class="btn btn-primary" id="authNkBtn" type="button" disabled>–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –ù–ö</button>
                    <button class="btn btn-primary" id="authSuzBtn" type="button" disabled>–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –°–£–ó</button>
                </div>
            </div>

            <div class="modal-section">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ OMS</h3>
                <div class="form-group">
                    <label for="omsConnection">–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</label>
                    <input type="text" id="omsConnection" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
                    <p class="hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GUID –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –û–ú–°.</p>
                </div>
                <div class="form-group">
                    <label for="omsId">OMS ID (UUID –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)</label>
                    <input type="text" id="omsId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancelSettingsBtn" type="button">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="saveOmsBtn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
const state = {
    certs: [],
    currentCert: null,
    card: null,
    nkActive: false,
    suzActive: false,
    omsSaved: false,
    omsConnection: '',
    omsId: '',
    lastOrderId: '',
    buffers: [],
    downloadUrl: null
};

const $ = id => document.getElementById(id);

function log(msg) {
    $('log').textContent += '\n' + msg;
    $('log').scrollTop = $('log').scrollHeight;
}

function updateBufferOptions() {
    const select = $('bufferSelect');
    if (!select) return;

    const previous = select.value;
    select.innerHTML = '';

    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = state.buffers.length ? '–ê–≤—Ç–æ–≤—ã–±–æ—Ä –±—É—Ñ–µ—Ä–∞' : '–ë—É—Ñ–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
    select.appendChild(placeholder);

    state.buffers.forEach((buffer, index) => {
        const option = document.createElement('option');
        option.value = String(index);
        option.dataset.key = buffer.bufferId || buffer.id || buffer.buffer_id || buffer.uuid || '';
        option.dataset.orderId = buffer.orderId || state.lastOrderId;

        const pieces = [];
        if (buffer.gtin) pieces.push(`GTIN ${buffer.gtin}`);
        if (buffer.templateId) pieces.push(`template ${buffer.templateId}`);
        const left = buffer.leftInBuffer ?? buffer.left ?? buffer.totalCodes ?? null;
        if (left !== null) pieces.push(`–¥–æ—Å—Ç—É–ø–Ω–æ ${left}`);

        const label = pieces.length ? pieces.join(' ‚Ä¢ ') : '–±–µ–∑ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π';
        option.textContent = `${option.dataset.key || '–ë—É—Ñ–µ—Ä ' + (index + 1)} ‚Ä¢ ${label}`;
        select.appendChild(option);
    });

    select.disabled = state.buffers.length === 0;

    if (previous && [...select.options].some(opt => opt.value === previous)) {
        select.value = previous;
    } else {
        select.value = '';
    }
}

function updateStatus() {
    const nkStatus = $('nkStatus');
    if (nkStatus) {
        nkStatus.className = 'status ' + (state.nkActive ? 'active' : 'inactive');
        nkStatus.innerHTML = state.nkActive
            ? '<span>‚úÖ</span><span>–¢–æ–∫–µ–Ω –ù–ö: –∞–∫—Ç–∏–≤–µ–Ω</span>'
            : '<span>üî¥</span><span>–¢–æ–∫–µ–Ω –ù–ö: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>';
    }

    const suzStatus = $('suzStatus');
    if (suzStatus) {
        suzStatus.className = 'status ' + (state.suzActive ? 'active' : 'inactive');
        suzStatus.innerHTML = state.suzActive
            ? '<span>‚úÖ</span><span>–¢–æ–∫–µ–Ω –°–£–ó: –∞–∫—Ç–∏–≤–µ–Ω</span>'
            : '<span>üî¥</span><span>–¢–æ–∫–µ–Ω –°–£–ó: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>';
    }

    const omsStatus = $('omsStatus');
    const shortConnection = state.omsConnection
        ? `${state.omsConnection.slice(0, 8)}‚Ä¶${state.omsConnection.slice(-4)}`
        : '';
    const omsDescription = state.omsSaved
        ? shortConnection
            ? `OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (${shortConnection})`
            : 'OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'
        : 'OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
    if (omsStatus) {
        omsStatus.className = 'status ' + (state.omsSaved ? 'active' : 'inactive');
        omsStatus.innerHTML = state.omsSaved
            ? `<span>‚úÖ</span><span>${omsDescription}</span>`
            : '<span>üî¥</span><span>OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</span>';
    }

    const summaryNk = $('nkSummary');
    if (summaryNk) {
        summaryNk.textContent = (state.nkActive ? '‚úÖ ' : 'üî¥ ') + (state.nkActive ? '–¢–æ–∫–µ–Ω –ù–ö –∞–∫—Ç–∏–≤–µ–Ω' : '–¢–æ–∫–µ–Ω –ù–ö –Ω–µ –ø–æ–ª—É—á–µ–Ω');
    }

    const summarySuz = $('suzSummary');
    if (summarySuz) {
        summarySuz.textContent = (state.suzActive ? '‚úÖ ' : 'üî¥ ') + (state.suzActive ? '–¢–æ–∫–µ–Ω –°–£–ó –∞–∫—Ç–∏–≤–µ–Ω' : '–¢–æ–∫–µ–Ω –°–£–ó –Ω–µ –ø–æ–ª—É—á–µ–Ω');
    }

    const summaryOms = $('omsSummary');
    if (summaryOms) {
        const summaryText = state.omsSaved
            ? shortConnection
                ? `OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (${shortConnection})`
                : 'OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'
            : 'OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
        summaryOms.textContent = (state.omsSaved ? '‚úÖ ' : 'üî¥ ') + summaryText;
    }

    const certSummary = $('certSummary');
    if (certSummary) {
        const select = $('certSelect');
        if (state.currentCert && select && select.options.length) {
            const currentText = select.options[select.selectedIndex]?.textContent?.trim();
            certSummary.textContent = currentText
                ? `–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: ${currentText}`
                : '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: –≤—ã–±—Ä–∞–Ω';
        } else {
            certSummary.textContent = '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: –Ω–µ –≤—ã–±—Ä–∞–Ω';
        }
    }

    const canOrder = state.nkActive && state.suzActive && state.omsSaved && state.card;
    const createBtn = $('createOrderBtn');
    if (createBtn) createBtn.disabled = !canOrder;

    const statusBtn = $('statusBtn');
    if (statusBtn) statusBtn.disabled = !(state.suzActive && state.omsSaved);

    const listOrdersBtn = $('listOrdersBtn');
    if (listOrdersBtn) listOrdersBtn.disabled = !(state.suzActive && state.omsSaved);

    const downloadBtn = $('downloadCodesBtn');
    if (downloadBtn) {
        const orderInput = $('orderIdInput');
        const gtinInput = $('codeGtin');
        const hasOrderId = !!(state.lastOrderId || (orderInput && orderInput.value));
        const hasGtin = !!(gtinInput && gtinInput.value.trim());
        downloadBtn.disabled = !(state.suzActive && state.omsSaved && hasOrderId && hasGtin);
    }

    const utilBtn = $('sendUtilisationBtn');
    if (utilBtn) utilBtn.disabled = !(state.suzActive && state.currentCert && state.omsSaved);

    const authNkBtn = $('authNkBtn');
    if (authNkBtn) authNkBtn.disabled = !state.currentCert;

    const authSuzBtn = $('authSuzBtn');
    if (authSuzBtn) authSuzBtn.disabled = !state.currentCert || !state.omsSaved;

    if (state.lastOrderId) {
        const orderInput = $('orderIdInput');
        if (orderInput && !orderInput.value) {
            orderInput.value = state.lastOrderId;
        }
    }

    updateBufferOptions();
}

function updateClothingVisibility() {
    const block = $('lpAttributes');
    const select = $('productGroup');
    if (!block || !select) return;

    const isClothing = select.value === 'lp';
    block.style.display = isClothing ? 'block' : 'none';
}

['orderIdInput', 'codeGtin'].forEach(id => {
    const element = $(id);
    if (element) {
        element.addEventListener('input', () => updateStatus());
    }
});

const productGroupSelect = $('productGroup');
if (productGroupSelect) {
    productGroupSelect.addEventListener('change', () => {
        updateClothingVisibility();
    });
}

updateClothingVisibility();

async function req(url, options = {}) {
    const resp = await fetch(url, options);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);
    return data;
}

function setModalVisibility(visible) {
    const modal = $('settingsModal');
    if (!modal) return;

    if (visible) {
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');

        const connectionInput = $('omsConnection');
        if (connectionInput) {
            connectionInput.value = state.omsConnection || '';
            connectionInput.focus();
            connectionInput.select();
        }

        const idInput = $('omsId');
        if (idInput) {
            idInput.value = state.omsId || '';
        }
    } else {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        const trigger = $('openSettingsBtn');
        if (trigger) {
            trigger.focus();
        }
    }
}

const openSettingsBtn = $('openSettingsBtn');
if (openSettingsBtn) {
    openSettingsBtn.addEventListener('click', () => setModalVisibility(true));
}

['closeSettingsBtn', 'cancelSettingsBtn'].forEach(id => {
    const btn = $(id);
    if (btn) {
        btn.addEventListener('click', () => setModalVisibility(false));
    }
});

const settingsBackdrop = $('settingsModal');
if (settingsBackdrop) {
    settingsBackdrop.addEventListener('click', (event) => {
        if (event.target === settingsBackdrop) {
            setModalVisibility(false);
        }
    });
}

document.addEventListener('keydown', (event) => {
    const modal = $('settingsModal');
    if (event.key === 'Escape' && modal && modal.classList.contains('active')) {
        setModalVisibility(false);
    }
});

async function loadCertificates(isAuto = false) {
    try {
        log(isAuto ? 'üîÑ –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...' : 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...');

        await cadesplugin;
        const store = await cadesplugin.CreateObjectAsync('CAdESCOM.Store');
        await store.Open(2, 'My', 2);

        const certs = await store.Certificates;
        const count = await certs.Count;

        const select = $('certSelect');
        state.certs = [];
        state.currentCert = null;
        if (select) {
            select.innerHTML = '';
            select.disabled = true;
        }

        for (let i = 1; i <= count; i++) {
            const cert = await certs.Item(i);
            const validTo = new Date(await cert.ValidToDate);
            if (validTo < new Date()) continue;

            state.certs.push(cert);
            const option = document.createElement('option');
            option.value = state.certs.length - 1;
            option.textContent = await cert.SubjectName;
            if (select) {
                select.appendChild(option);
            }
        }

        await store.Close();

        if (state.certs.length) {
            if (select) {
                select.disabled = false;
                select.value = '0';
            }
            state.currentCert = state.certs[0];
            $('authNkBtn').disabled = false;
            $('authSuzBtn').disabled = false;
            log(`‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã ${isAuto ? '–∑–∞–≥—Ä—É–∂–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' : '–æ–±–Ω–æ–≤–ª–µ–Ω—ã'}: ` + state.certs.length);
        } else {
            log('‚ùå –î–µ–π—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            $('authNkBtn').disabled = true;
            $('authSuzBtn').disabled = true;
            if (select) {
                const placeholder = document.createElement('option');
                placeholder.textContent = '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                placeholder.disabled = true;
                placeholder.selected = true;
                select.appendChild(placeholder);
            }
        }

        updateStatus();
    } catch (e) {
        state.certs = [];
        state.currentCert = null;
        updateStatus();
        log(`‚ùå ${isAuto ? '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã' : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤'}: ` + e.message);
    }
}

$('loadCertsBtn').onclick = async () => {
    await loadCertificates(false);
};

$('certSelect').onchange = (e) => {
    state.currentCert = state.certs[e.target.value];
    updateStatus();
};

// –ü–æ–¥–ø–∏—Å—å attached (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
// –ü–æ–¥–ø–∏—Å—å attached (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
async function signAttached(data, cert) {
    const signer = await cadesplugin.CreateObjectAsync('CAdESCOM.CPSigner');
    await signer.propset_Certificate(cert);
    
    const sd = await cadesplugin.CreateObjectAsync('CAdESCOM.CadesSignedData');
    
    // –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É
    if (typeof sd.propset_ContentEncoding === 'function') {
        try {
            await sd.propset_ContentEncoding(cadesplugin.CADESCOM_STRING_TO_UCS2LE);
        } catch (e) {
            console.log('ContentEncoding –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }
    }
    
    await sd.propset_Content(data);  // ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û: –±—ã–ª–æ payload, —Å—Ç–∞–ª–æ data
    
    return sd.SignCades(signer, cadesplugin.CADESCOM_CADES_BES);
}

function encodeBase64Utf8(data) {
    const utf8 = new TextEncoder().encode(data);
    let binary = '';
    for (const byte of utf8) {
        binary += String.fromCharCode(byte);
    }
    return btoa(binary);
}

// –ü–æ–¥–ø–∏—Å—å detached (–¥–ª—è –∑–∞–∫–∞–∑–∞)
// –ü–æ–¥–ø–∏—Å—å detached (–¥–ª—è –∑–∞–∫–∞–∑–∞) - CMS —Ñ–æ—Ä–º–∞—Ç
async function signDetached(data, cert) {
    const signer = await cadesplugin.CreateObjectAsync('CAdESCOM.CPSigner');
    await signer.propset_Certificate(cert);

    const sd = await cadesplugin.CreateObjectAsync('CAdESCOM.CadesSignedData');

    // –í–ê–ñ–ù–û: –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –±–∞–π—Ç—ã HTTP-—Ç–µ–ª–∞ ‚Üí –∫–æ–¥–∏—Ä—É–µ–º JSON –≤ base64 –∏ –≥–æ–≤–æ—Ä–∏–º –ø–ª–∞–≥–∏–Ω—É, —á—Ç–æ —ç—Ç–æ –±–∏–Ω–∞—Ä—å
    const base64Payload = encodeBase64Utf8(data);
    if (typeof sd.propset_ContentEncoding === 'function') {
        await sd.propset_ContentEncoding(cadesplugin.CADESCOM_BASE64_TO_BINARY);
    }
    await sd.propset_Content(base64Payload);

    // –í–ê–ñ–ù–û: detached = true, –ë–ï–ó –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const signature = await sd.SignCades(signer, cadesplugin.CADESCOM_CADES_BES, true);

    // –£–¥–∞–ª—è–µ–º –í–°–ï –ø–µ—Ä–µ–Ω–æ—Å—ã –∏ –ø—Ä–æ–±–µ–ª—ã
    return signature.replace(/[\r\n\s]/g, '');
}
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ OMS –Ω–∞—Å—Ç—Ä–æ–µ–∫
$('saveOmsBtn').onclick = async () => {
    const omsConnection = $('omsConnection').value.trim();
    const omsId = $('omsId').value.trim();

    if (!omsConnection || !omsId) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ OMS ID');
        return;
    }

    try {
        await req('auth.php?action=save-oms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({omsConnection, omsId})
        });

        state.omsSaved = true;
        state.omsConnection = omsConnection;
        state.omsId = omsId;
        updateStatus();
        log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OMS —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        setModalVisibility(false);
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ù–ö
$('authNkBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }
    
    try {
        log('üîê –ó–∞–ø—Ä–æ—Å challenge –ù–ö...');
        const challenge = await req('auth.php?action=nk-challenge');
        
        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å challenge...');
        const signature = await signAttached(challenge.data, state.currentCert);
        
        log('üì§ –û–±–º–µ–Ω –Ω–∞ —Ç–æ–∫–µ–Ω...');
        await req('auth.php?action=nk-signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: challenge.uuid, signature})
        });
        
        state.nkActive = true;
        updateStatus();
        log('‚úÖ –¢–æ–∫–µ–Ω –ù–ö –ø–æ–ª—É—á–µ–Ω');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –°–£–ó
$('authSuzBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }
    
    const omsConnection = state.omsConnection || $('omsConnection').value.trim();
    const omsId = state.omsId || $('omsId').value.trim();

    if (!omsConnection || !omsId) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ OMS ID');
        setModalVisibility(true);
        return;
    }
    
    try {
        log('üîê –ó–∞–ø—Ä–æ—Å challenge –°–£–ó...');
        const challenge = await req('auth.php?action=suz-challenge');
        
        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å challenge...');
        const signature = await signAttached(challenge.data, state.currentCert);
        
        log('üì§ –û–±–º–µ–Ω –Ω–∞ clientToken...');
        await req('auth.php?action=suz-signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: challenge.uuid, signature, omsConnection, omsId})
        });
        
        state.suzActive = true;
        updateStatus();
        log('‚úÖ –¢–æ–∫–µ–Ω –°–£–ó –ø–æ–ª—É—á–µ–Ω');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

// –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
$('findCardBtn').onclick = async () => {
    const gtin = $('gtinInput').value.trim();
    if (!gtin) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ GTIN');
        return;
    }
    
    if (!state.nkActive) {
        log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –ù–ö');
        return;
    }
    
    try {
        log('üîç –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–∫–∏...');
        state.card = await req('card.php?gtin=' + encodeURIComponent(gtin));
        
        $('cardInfo').style.display = 'block';
        $('cardName').textContent = state.card.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        
        const pills = [];
        if (state.card.goodId) pills.push(`<span class="pill">ID: ${state.card.goodId}</span>`);
        if (state.card.gtin) pills.push(`<span class="pill">GTIN: ${state.card.gtin}</span>`);
        $('cardPills').innerHTML = pills.join('');
        
        $('cardDetails').textContent = 
            (state.card.tnved ? `–¢–ù –í–≠–î: ${state.card.tnved}` : '') +
            (state.card.productGroup ? ` ‚Ä¢ –ì—Ä—É–ø–ø–∞: ${state.card.productGroup}` : '');
        
        if (state.card.productGroup) {
            $('productGroup').value = state.card.productGroup;
            updatePharmaVisibility();
        }

        const codeGtinInput = $('codeGtin');
        if (codeGtinInput && state.card.gtin) {
            let normalized = String(state.card.gtin).replace(/\s+/g, '');
            if (/^\d+$/.test(normalized)) {
                if (normalized.length < 14) {
                    normalized = normalized.padStart(14, '0');
                }
                if (normalized.length === 14) {
                    codeGtinInput.value = normalized;
                } else {
                    codeGtinInput.value = state.card.gtin;
                }
            } else {
                codeGtinInput.value = state.card.gtin;
            }
        }

        updateStatus();
        log('‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞');
    } catch (e) {
        log('‚ùå ' + e.message);
        state.card = null;
        $('cardInfo').style.display = 'none';
        updateStatus();
    }
};

// –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
$('createOrderBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }
    
    if (!state.card) {
        log('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É');
        return;
    }
    
    const productGroup = $('productGroup').value;
    const quantity = parseInt($('quantity').value);
    const releaseMethod = $('releaseMethod').value;
    
    if (!productGroup || !quantity || !releaseMethod) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞');
        return;
    }
    
    try {
        let gtin = state.card.gtin;
        if (gtin.length < 14) {
            gtin = gtin.padStart(14, '0');
        }
        
        const order = {
            productGroup,
            products: [{
                gtin: gtin,
                quantity,
                serialNumberType: "OPERATOR",
                cisType: "UNIT",
                templateId: state.card.templateId || 10
            }],
            attributes: {
                releaseMethodType: releaseMethod,
                createMethodType: "SELF_MADE"
            }
        };

        if (productGroup === 'lp') {
            const paymentTypeInput = $('lpPaymentType');
            const paymentTypeValue = paymentTypeInput ? parseInt(paymentTypeInput.value, 10) : 2;
            const paymentType = Number.isFinite(paymentTypeValue) ? paymentTypeValue : 2;

            order.attributes.freeCode = $('lpFreeCode').checked;
            order.attributes.paymentType = paymentType;
        }

        const payload = JSON.stringify(order);
        
        console.log('=== PAYLOAD ===');
        console.log('Length:', payload.length);
        console.log('Content:', payload);
        
        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å –∑–∞–∫–∞–∑–∞...');
        const rawSignature = await signDetached(payload, state.currentCert);
        
        console.log('=== SIGNATURE ===');
        console.log('Raw length:', rawSignature.length);
        console.log('Has newlines:', /[\r\n]/.test(rawSignature));
        console.log('Has spaces:', /\s/.test(rawSignature));
        console.log('First 100 chars:', rawSignature.substring(0, 100));
        
        // –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ–¥–ø–∏—Å—å –æ—á–∏—â–µ–Ω–∞
        const signature = rawSignature.replace(/[\r\n\s]/g, '');
        
        console.log('Cleaned length:', signature.length);
        log('üîê –î–ª–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∏: ' + signature.length + ' —Å–∏–º–≤–æ–ª–æ–≤');
        
        log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –°–£–ó...');
        const result = await req('order.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload, signature})
        });

        log('‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –û—Ç–≤–µ—Ç –°–£–ó:');
        log(JSON.stringify(result.response, null, 2));

        const createdOrder = result.response || {};
        const orderId = createdOrder.orderId || createdOrder.id || createdOrder.uuid || createdOrder.order_id || '';
        if (orderId) {
            state.lastOrderId = orderId;
            const orderInput = $('orderIdInput');
            if (orderInput) orderInput.value = orderId;
            log('üÜî ID –∑–∞–∫–∞–∑–∞: ' + orderId);
        }

        state.buffers = [];
        updateBufferOptions();
        updateStatus();
    } catch (e) {
        console.error('Full error:', e);
        log('‚ùå ' + e.message);
    }
};

function extractOrderInfos(payload) {
    if (!payload) return [];
    if (Array.isArray(payload)) return payload;
    if (Array.isArray(payload.orderInfos)) return payload.orderInfos;
    if (Array.isArray(payload.orders)) return payload.orders;
    return [];
}

function applyOrderInfo(orderPayload, fallbackId) {
    const infos = extractOrderInfos(orderPayload);
    const buffers = [];
    infos.forEach(info => {
        const orderId = info.orderId || info.id || info.uuid || fallbackId || '';
        if (!state.lastOrderId && orderId) {
            state.lastOrderId = orderId;
            const orderInput = $('orderIdInput');
            if (orderInput) orderInput.value = orderId;
        }

        (info.buffers || []).forEach(buffer => {
            buffers.push({
                ...buffer,
                orderId,
                bufferId: buffer.bufferId || buffer.id || buffer.buffer_id || buffer.uuid || '',
            });
        });
    });

    state.buffers = buffers;
    updateBufferOptions();

    const gtinInput = $('codeGtin');
    if (gtinInput && !gtinInput.value) {
        const bufferWithGtin = buffers.find(buffer => buffer.gtin);
        if (bufferWithGtin && bufferWithGtin.gtin) {
            let normalized = String(bufferWithGtin.gtin).replace(/\s+/g, '');
            if (/^\d+$/.test(normalized)) {
                if (normalized.length < 14) {
                    normalized = normalized.padStart(14, '0');
                }
                if (normalized.length === 14) {
                    gtinInput.value = normalized;
                }
            }
        }
    }
    updateStatus();
}

$('statusBtn').onclick = async () => {
    const orderInput = $('orderIdInput');
    const orderId = (orderInput ? orderInput.value.trim() : '') || state.lastOrderId;

    if (!orderId) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞');
        return;
    }

    try {
        log('üîÑ –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞...');
        const data = await req('order_status.php?orderId=' + encodeURIComponent(orderId));
        const ordersPayload = data.orders || {};
        const output = $('statusOutput');
        if (output) output.textContent = JSON.stringify(ordersPayload, null, 2);

        state.lastOrderId = orderId;
        applyOrderInfo(ordersPayload, orderId);
        log('‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('listOrdersBtn').onclick = async () => {
    try {
        log('üìã –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤...');
        const data = await req('order_status.php?limit=5');
        const ordersPayload = data.orders || {};
        const output = $('statusOutput');
        if (output) output.textContent = JSON.stringify(ordersPayload, null, 2);

        const infos = extractOrderInfos(ordersPayload);
        if (infos.length) {
            const firstId = infos[0].orderId || infos[0].id || infos[0].uuid || '';
            if (firstId) {
                state.lastOrderId = firstId;
                const orderInput = $('orderIdInput');
                if (orderInput) orderInput.value = firstId;
            }
        }

        applyOrderInfo(ordersPayload);
        log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('downloadCodesBtn').onclick = async () => {
    const orderInput = $('orderIdInput');
    const orderId = (orderInput ? orderInput.value.trim() : '') || state.lastOrderId;

    if (!orderId) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞');
        return;
    }

    const bufferSelect = $('bufferSelect');
    let effectiveOrderId = orderId;
    if (bufferSelect && bufferSelect.value !== '') {
        const option = bufferSelect.options[bufferSelect.selectedIndex];
        if (option && option.dataset.orderId) {
            effectiveOrderId = option.dataset.orderId;
        }
    }

    const formatSelect = $('codeFormat');
    const format = formatSelect ? formatSelect.value : 'CSV';

    const quantityInput = $('codeQuantity');
    let quantity = parseInt(quantityInput ? quantityInput.value : '1000', 10);
    if (!Number.isFinite(quantity) || quantity <= 0) {
        log('‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ú –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
        return;
    }
    if (quantity > 150000) {
        quantity = 150000;
        if (quantityInput) {
            quantityInput.value = '150000';
        }
        log('‚ÑπÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º 150‚ÄØ000 –ö–ú');
    }

    const gtinInput = $('codeGtin');
    let gtin = gtinInput ? gtinInput.value.trim() : '';
    if (!gtin && state.card && state.card.gtin) {
        gtin = String(state.card.gtin);
    }
    gtin = gtin.replace(/\s+/g, '');

    if (!gtin) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ GTIN —Ç–æ–≤–∞—Ä–∞');
        return;
    }

    if (!/^\d+$/.test(gtin)) {
        log('‚ùå GTIN –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä');
        return;
    }

    if (gtin.length < 14) {
        gtin = gtin.padStart(14, '0');
    }

    if (gtin.length !== 14) {
        log('‚ùå GTIN –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 14 —Ü–∏—Ñ—Ä');
        return;
    }

    if (gtinInput) {
        gtinInput.value = gtin;
    }

    try {
        log('üì¶ –ó–∞–ø—Ä–æ—Å –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏...');
        const params = new URLSearchParams({
            orderId: effectiveOrderId,
            gtin,
            quantity: String(quantity),
        });

        const result = await req('codes.php?' + params.toString());
        const payload = result.data || {};

        const codes = Array.isArray(payload.codes) ? payload.codes : [];
        if (!codes.length) {
            throw new Error('–°–µ—Ä–≤–∏—Å –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ö–ú');
        }

        if (state.downloadUrl) {
            URL.revokeObjectURL(state.downloadUrl);
        }

        let blobContent = '';
        let contentType = 'text/plain';
        let ext = 'txt';

        if ((format || '').toUpperCase() === 'JSON') {
            blobContent = JSON.stringify(codes, null, 2);
            contentType = 'application/json';
            ext = 'json';
        } else {
            blobContent = codes.join('\n');
            contentType = 'text/csv';
            ext = 'csv';
        }

        const blob = new Blob([blobContent], {type: contentType});
        const url = URL.createObjectURL(blob);
        state.downloadUrl = url;

        const link = $('downloadLink');
        if (link) {
            link.href = url;
            const blockSuffix = payload.blockId ? `_block_${payload.blockId}` : '';
            link.download = `codes_${orderId}${blockSuffix}.${ext}`;
            link.style.display = 'inline-block';
            link.textContent = '–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª';
        }

        const received = typeof payload.receivedQuantity === 'number' ? payload.receivedQuantity : codes.length;
        const infoParts = [`${received} –ö–ú`];
        if (payload.blockId) {
            infoParts.push(`blockId ${payload.blockId}`);
        }

        log('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ' + infoParts.join(', '));
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('sendUtilisationBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }

    const textarea = $('utilisationPayload');
    if (!textarea || !textarea.value.trim()) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–ª–æ –æ—Ç—á—ë—Ç–∞ –æ –Ω–∞–Ω–µ—Å–µ–Ω–∏–∏');
        return;
    }

    try {
        const parsed = JSON.parse(textarea.value);
        const payload = JSON.stringify(parsed);

        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å –æ—Ç—á—ë—Ç–∞...');
        const signature = await signDetached(payload, state.currentCert);

        log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞...');
        const result = await req('utilisation.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload, signature})
        });

        log('‚úÖ –û—Ç—á—ë—Ç –ø—Ä–∏–Ω—è—Ç:');
        log(JSON.stringify(result.response, null, 2));
    } catch (e) {
        if (e instanceof SyntaxError) {
            log('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç—á—ë—Ç–∞: ' + e.message);
        } else {
            log('‚ùå ' + e.message);
        }
    }
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
(async () => {
    try {
        const status = await req('auth.php?action=status');
        state.nkActive = status.nk.active;
        state.suzActive = status.suz.active;

        const oms = status.oms || {};

        if (oms.connection && oms.id) {
            state.omsConnection = oms.connection;
            state.omsId = oms.id;
            state.omsSaved = true;
            $('omsConnection').value = oms.connection;
            $('omsId').value = oms.id;
        } else {
            state.omsSaved = false;
            state.omsConnection = '';
            state.omsId = '';
        }

        updateStatus();
        if (state.nkActive || state.suzActive || state.omsSaved) {
            log('‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Å–µ—Å—Å–∏–∏');
        }
    } catch (e) {
        console.error(e);
    }
})();

window.addEventListener('beforeunload', () => {
    if (state.downloadUrl) {
        URL.revokeObjectURL(state.downloadUrl);
    }
});

window.addEventListener('load', () => {
    loadCertificates(true);
});
</script>

</body>
</html>