<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ó–∞–∫–∞–∑ –ö–ú</title>
    <script src="cadesplugin_api.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #1a202c;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }
        
        .step {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .step h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #2d3748;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .status.inactive {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status.active {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn-secondary {
            background: #edf2f7;
            color: #2d3748;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #e2e8f0;
        }
        
        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .card-info {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .card-info h3 {
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .card-info .pill {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
        }
        
        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .mini-log {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-x: auto;
            min-height: 160px;
        }

        .hint {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-top: 0.25rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üéØ –ó–∞–∫–∞–∑ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏</h1>
    <p class="subtitle">–ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ –°–£–ó —á–µ—Ä–µ–∑ True API</p>
    
    <!-- –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="step">
    <h2>–®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    
    <div class="status" id="nkStatus">
        <span>üî¥</span>
        <span>–¢–æ–∫–µ–Ω –ù–ö: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>
    </div>
    
    <div class="status" id="suzStatus">
        <span>üî¥</span>
        <span>–¢–æ–∫–µ–Ω –°–£–ó: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>
    </div>
    
    <div class="status" id="omsStatus">
        <span>üî¥</span>
        <span>OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</span>
    </div>
    
    <div class="form-group">
        <label>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –£–ö–≠–ü</label>
        <select id="certSelect" disabled>
            <option>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã...</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>OMS Connection (GUID –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)</label>
        <input type="text" id="omsConnection" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
    </div>
    
    <div class="form-group">
        <label>OMS ID (UUID –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)</label>
        <input type="text" id="omsId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
    </div>
    
    <div class="btn-group">
        <button class="btn btn-secondary" id="loadCertsBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</button>
        <button class="btn btn-secondary" id="saveOmsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OMS</button>
        <button class="btn btn-primary" id="authNkBtn" disabled>–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –ù–ö</button>
        <button class="btn btn-primary" id="authSuzBtn" disabled>–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –°–£–ó</button>
    </div>
</div>
    
    <!-- –®–∞–≥ 2: –ö–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="step">
        <h2>–®–∞–≥ 2: –ù–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞</h2>
        
        <div class="form-group">
            <label>GTIN —Ç–æ–≤–∞—Ä–∞</label>
            <input type="text" id="gtinInput" placeholder="04601234567890">
        </div>
        
        <button class="btn btn-secondary" id="findCardBtn">–ù–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É</button>
        
        <div class="card-info" id="cardInfo" style="display: none;">
            <h3 id="cardName"></h3>
            <div id="cardPills"></div>
            <p id="cardDetails" style="margin-top: 0.5rem; color: #718096;"></p>
        </div>
    </div>
    
    <!-- –®–∞–≥ 3: –ó–∞–∫–∞–∑ -->
    <div class="step">
        <h2>–®–∞–≥ 3: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–∫–∞–∑–∞</h2>

        <div class="grid">
            <div class="form-group">
                <label>–¢–æ–≤–∞—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞</label>
                <select id="productGroup">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    <option value="lp">–õ–µ–≥–∫–∞—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å</option>
                    <option value="shoes">–û–±—É–≤—å</option>
                    <option value="tobacco">–¢–∞–±–∞–∫</option>
                    <option value="pharma">–õ–µ–∫–∞—Ä—Å—Ç–≤–∞</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ú</label>
                <input type="number" id="quantity" value="1" min="1">
            </div>
        </div>
        
        <div class="form-group">
            <label>–°–ø–æ—Å–æ–± –≤—ã–ø—É—Å–∫–∞</label>
            <select id="releaseMethod">
                <option value="PRODUCTION">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ –≤ –†–§</option>
                <option value="IMPORT">–ò–º–ø–æ—Ä—Ç</option>
                <option value="REMAINS">–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤</option>
            </select>
        </div>

        <button class="btn btn-primary" id="createOrderBtn" disabled>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <!-- –®–∞–≥ 4: –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ -->
    <div class="step">
        <h2>–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h2>

        <div class="form-group">
            <label>ID –∑–∞–∫–∞–∑–∞</label>
            <input type="text" id="orderIdInput" placeholder="UUID –∑–∞–∫–∞–∑–∞">
            <p class="hint">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" id="statusBtn" disabled>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            <button class="btn btn-secondary" id="listOrdersBtn" disabled>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</button>
        </div>

        <div class="card-info" style="margin-top: 1rem;">
            <h3>–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤</h3>
            <pre class="mini-log" id="statusOutput">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞.</pre>
        </div>
    </div>

    <!-- –®–∞–≥ 5: –ü–æ–ª—É—á–∏—Ç—å –ö–ú -->
    <div class="step">
        <h2>–®–∞–≥ 5: –ü–æ–ª—É—á–∏—Ç—å –º–∞—Å—Å–∏–≤—ã –ö–ú</h2>

        <div class="form-group">
            <label>–ë—É—Ñ–µ—Ä</label>
            <select id="bufferSelect" disabled>
                <option>–ë—É—Ñ–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>
            </select>
            <p class="hint">–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–∞.</p>
        </div>

        <div class="grid">
            <div class="form-group">
                <label>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞</label>
                <select id="codeFormat">
                    <option value="CSV">CSV</option>
                    <option value="JSON">JSON</option>
                </select>
            </div>

            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ú –∑–∞ –∑–∞–ø—Ä–æ—Å</label>
                <input type="number" id="codeCount" value="1000" min="1" max="5000">
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" id="downloadCodesBtn" disabled>–°–∫–∞—á–∞—Ç—å –ö–ú</button>
            <a class="btn btn-secondary" id="downloadLink" style="display: none;" download>–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>
        </div>
    </div>

    <!-- –®–∞–≥ 6: –í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç -->
    <div class="step">
        <h2>–®–∞–≥ 6: –û—Ç—á—ë—Ç –æ –Ω–∞–Ω–µ—Å–µ–Ω–∏–∏ (–≤–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç)</h2>
        <p class="hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–Ω—ã–µ –ö–ú (sntins) –∏–∑ –±—É—Ñ–µ—Ä–∞. –ú–∞–∫—Å–∏–º—É–º 30 000 –ö–ú –∑–∞ –∑–∞–ø—Ä–æ—Å.</p>

        <textarea id="utilisationPayload">{
  "productGroup": "",
  "utilisationType": "UTILISATION",
  "sntins": [
    ""
  ],
  "attributes": {}
}</textarea>

        <div class="btn-group" style="margin-top: 1rem;">
            <button class="btn btn-primary" id="sendUtilisationBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
        </div>
    </div>

    <!-- –õ–æ–≥ -->
    <div class="log" id="log">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</div>
</div>

<script>
const state = {
    certs: [],
    currentCert: null,
    card: null,
    nkActive: false,
    suzActive: false,
    omsSaved: false,
    lastOrderId: '',
    buffers: [],
    downloadUrl: null
};

const $ = id => document.getElementById(id);

function log(msg) {
    $('log').textContent += '\n' + msg;
    $('log').scrollTop = $('log').scrollHeight;
}

function updateBufferOptions() {
    const select = $('bufferSelect');
    if (!select) return;

    const previous = select.value;
    select.innerHTML = '';

    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = state.buffers.length ? '–ê–≤—Ç–æ–≤—ã–±–æ—Ä –±—É—Ñ–µ—Ä–∞' : '–ë—É—Ñ–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
    select.appendChild(placeholder);

    state.buffers.forEach((buffer, index) => {
        const option = document.createElement('option');
        option.value = String(index);
        option.dataset.key = buffer.bufferId || buffer.id || buffer.buffer_id || buffer.uuid || '';
        option.dataset.orderId = buffer.orderId || state.lastOrderId;

        const pieces = [];
        if (buffer.gtin) pieces.push(`GTIN ${buffer.gtin}`);
        if (buffer.templateId) pieces.push(`template ${buffer.templateId}`);
        const left = buffer.leftInBuffer ?? buffer.left ?? buffer.totalCodes ?? null;
        if (left !== null) pieces.push(`–¥–æ—Å—Ç—É–ø–Ω–æ ${left}`);

        const label = pieces.length ? pieces.join(' ‚Ä¢ ') : '–±–µ–∑ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π';
        option.textContent = `${option.dataset.key || '–ë—É—Ñ–µ—Ä ' + (index + 1)} ‚Ä¢ ${label}`;
        select.appendChild(option);
    });

    select.disabled = state.buffers.length === 0;

    if (previous && [...select.options].some(opt => opt.value === previous)) {
        select.value = previous;
    } else {
        select.value = '';
    }
}

function updateStatus() {
    $('nkStatus').className = 'status ' + (state.nkActive ? 'active' : 'inactive');
    $('nkStatus').innerHTML = state.nkActive
        ? '<span>‚úÖ</span><span>–¢–æ–∫–µ–Ω –ù–ö: –∞–∫—Ç–∏–≤–µ–Ω</span>'
        : '<span>üî¥</span><span>–¢–æ–∫–µ–Ω –ù–ö: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>';
    
    $('suzStatus').className = 'status ' + (state.suzActive ? 'active' : 'inactive');
    $('suzStatus').innerHTML = state.suzActive
        ? '<span>‚úÖ</span><span>–¢–æ–∫–µ–Ω –°–£–ó: –∞–∫—Ç–∏–≤–µ–Ω</span>'
        : '<span>üî¥</span><span>–¢–æ–∫–µ–Ω –°–£–ó: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>';
    
    $('omsStatus').className = 'status ' + (state.omsSaved ? 'active' : 'inactive');
    $('omsStatus').innerHTML = state.omsSaved
        ? '<span>‚úÖ</span><span>OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</span>'
        : '<span>üî¥</span><span>OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</span>';

    const canOrder = state.nkActive && state.suzActive && state.omsSaved && state.card;
    const createBtn = $('createOrderBtn');
    if (createBtn) createBtn.disabled = !canOrder;

    const statusBtn = $('statusBtn');
    if (statusBtn) statusBtn.disabled = !(state.suzActive && state.omsSaved);

    const listOrdersBtn = $('listOrdersBtn');
    if (listOrdersBtn) listOrdersBtn.disabled = !(state.suzActive && state.omsSaved);

    const downloadBtn = $('downloadCodesBtn');
    if (downloadBtn) {
        const orderInput = $('orderIdInput');
        const hasOrderId = !!(state.lastOrderId || (orderInput && orderInput.value));
        downloadBtn.disabled = !(state.suzActive && state.omsSaved && hasOrderId);
    }

    const utilBtn = $('sendUtilisationBtn');
    if (utilBtn) utilBtn.disabled = !(state.suzActive && state.currentCert && state.omsSaved);

    const authSuzBtn = $('authSuzBtn');
    if (authSuzBtn) authSuzBtn.disabled = !state.currentCert || !state.omsSaved;

    if (state.lastOrderId) {
        const orderInput = $('orderIdInput');
        if (orderInput && !orderInput.value) {
            orderInput.value = state.lastOrderId;
        }
    }

    updateBufferOptions();
}

async function req(url, options = {}) {
    const resp = await fetch(url, options);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);
    return data;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
$('loadCertsBtn').onclick = async () => {
    try {
        await cadesplugin;
        const store = await cadesplugin.CreateObjectAsync('CAdESCOM.Store');
        await store.Open(2, 'My', 2);
        
        const certs = await store.Certificates;
        const count = await certs.Count;
        
        state.certs = [];
        $('certSelect').innerHTML = '';
        
        for (let i = 1; i <= count; i++) {
            const cert = await certs.Item(i);
            const validTo = new Date(await cert.ValidToDate);
            if (validTo < new Date()) continue;
            
            state.certs.push(cert);
            const option = document.createElement('option');
            option.value = state.certs.length - 1;
            option.textContent = await cert.SubjectName;
            $('certSelect').appendChild(option);
        }
        
        await store.Close();
        
        if (state.certs.length) {
            $('certSelect').disabled = false;
            $('certSelect').value = '0';
            state.currentCert = state.certs[0];
            $('authNkBtn').disabled = false;
            $('authSuzBtn').disabled = false;
            log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤: ' + state.certs.length);
            updateStatus();
        } else {
            log('‚ùå –î–µ–π—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        }
    } catch (e) {
        log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤: ' + e.message);
    }
};

$('certSelect').onchange = (e) => {
    state.currentCert = state.certs[e.target.value];
    updateStatus();
};

// –ü–æ–¥–ø–∏—Å—å attached (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
// –ü–æ–¥–ø–∏—Å—å attached (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
async function signAttached(data, cert) {
    const signer = await cadesplugin.CreateObjectAsync('CAdESCOM.CPSigner');
    await signer.propset_Certificate(cert);
    
    const sd = await cadesplugin.CreateObjectAsync('CAdESCOM.CadesSignedData');
    
    // –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É
    if (typeof sd.propset_ContentEncoding === 'function') {
        try {
            await sd.propset_ContentEncoding(cadesplugin.CADESCOM_STRING_TO_UCS2LE);
        } catch (e) {
            console.log('ContentEncoding –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }
    }
    
    await sd.propset_Content(data);  // ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û: –±—ã–ª–æ payload, —Å—Ç–∞–ª–æ data
    
    return sd.SignCades(signer, cadesplugin.CADESCOM_CADES_BES);
}

// –ü–æ–¥–ø–∏—Å—å detached (–¥–ª—è –∑–∞–∫–∞–∑–∞)
// –ü–æ–¥–ø–∏—Å—å detached (–¥–ª—è –∑–∞–∫–∞–∑–∞) - CMS —Ñ–æ—Ä–º–∞—Ç
async function signDetached(data, cert) {
    const signer = await cadesplugin.CreateObjectAsync('CAdESCOM.CPSigner');
    await signer.propset_Certificate(cert);
    
    const sd = await cadesplugin.CreateObjectAsync('CAdESCOM.CadesSignedData');
    await sd.propset_Content(data);
    
    // –í–ê–ñ–ù–û: detached = true, –ë–ï–ó –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const signature = await sd.SignCades(signer, cadesplugin.CADESCOM_CADES_BES, true);
    
    // –£–¥–∞–ª—è–µ–º –í–°–ï –ø–µ—Ä–µ–Ω–æ—Å—ã –∏ –ø—Ä–æ–±–µ–ª—ã
    return signature.replace(/[\r\n\s]/g, '');
}
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ OMS –Ω–∞—Å—Ç—Ä–æ–µ–∫
$('saveOmsBtn').onclick = async () => {
    const omsConnection = $('omsConnection').value.trim();
    const omsId = $('omsId').value.trim();
    
    if (!omsConnection || !omsId) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ OMS Connection –∏ OMS ID');
        return;
    }
    
    try {
        await req('auth.php?action=save-oms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({omsConnection, omsId})
        });
        
        state.omsSaved = true;
        updateStatus();
        log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OMS —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ù–ö
$('authNkBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }
    
    try {
        log('üîê –ó–∞–ø—Ä–æ—Å challenge –ù–ö...');
        const challenge = await req('auth.php?action=nk-challenge');
        
        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å challenge...');
        const signature = await signAttached(challenge.data, state.currentCert);
        
        log('üì§ –û–±–º–µ–Ω –Ω–∞ —Ç–æ–∫–µ–Ω...');
        await req('auth.php?action=nk-signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: challenge.uuid, signature})
        });
        
        state.nkActive = true;
        updateStatus();
        log('‚úÖ –¢–æ–∫–µ–Ω –ù–ö –ø–æ–ª—É—á–µ–Ω');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –°–£–ó
$('authSuzBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }
    
    const omsConnection = $('omsConnection').value.trim();
    const omsId = $('omsId').value.trim();
    
    if (!omsConnection || !omsId) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ OMS Connection –∏ OMS ID');
        return;
    }
    
    try {
        log('üîê –ó–∞–ø—Ä–æ—Å challenge –°–£–ó...');
        const challenge = await req('auth.php?action=suz-challenge');
        
        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å challenge...');
        const signature = await signAttached(challenge.data, state.currentCert);
        
        log('üì§ –û–±–º–µ–Ω –Ω–∞ clientToken...');
        await req('auth.php?action=suz-signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: challenge.uuid, signature, omsConnection, omsId})
        });
        
        state.suzActive = true;
        updateStatus();
        log('‚úÖ –¢–æ–∫–µ–Ω –°–£–ó –ø–æ–ª—É—á–µ–Ω');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

// –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
$('findCardBtn').onclick = async () => {
    const gtin = $('gtinInput').value.trim();
    if (!gtin) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ GTIN');
        return;
    }
    
    if (!state.nkActive) {
        log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –ù–ö');
        return;
    }
    
    try {
        log('üîç –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–∫–∏...');
        state.card = await req('card.php?gtin=' + encodeURIComponent(gtin));
        
        $('cardInfo').style.display = 'block';
        $('cardName').textContent = state.card.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        
        const pills = [];
        if (state.card.goodId) pills.push(`<span class="pill">ID: ${state.card.goodId}</span>`);
        if (state.card.gtin) pills.push(`<span class="pill">GTIN: ${state.card.gtin}</span>`);
        $('cardPills').innerHTML = pills.join('');
        
        $('cardDetails').textContent = 
            (state.card.tnved ? `–¢–ù –í–≠–î: ${state.card.tnved}` : '') +
            (state.card.productGroup ? ` ‚Ä¢ –ì—Ä—É–ø–ø–∞: ${state.card.productGroup}` : '');
        
        if (state.card.productGroup) {
            $('productGroup').value = state.card.productGroup;
        }
        
        updateStatus();
        log('‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞');
    } catch (e) {
        log('‚ùå ' + e.message);
        state.card = null;
        $('cardInfo').style.display = 'none';
        updateStatus();
    }
};

// –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
$('createOrderBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }
    
    if (!state.card) {
        log('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É');
        return;
    }
    
    const productGroup = $('productGroup').value;
    const quantity = parseInt($('quantity').value);
    const releaseMethod = $('releaseMethod').value;
    
    if (!productGroup || !quantity || !releaseMethod) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞');
        return;
    }
    
    try {
        let gtin = state.card.gtin;
        if (gtin.length < 14) {
            gtin = gtin.padStart(14, '0');
        }
        
        const order = {
            productGroup,
            products: [{
                gtin: gtin,
                quantity,
                serialNumberType: "OPERATOR",
                cisType: "UNIT",
                templateId: state.card.templateId || 10
            }],
            attributes: {
                releaseMethodType: releaseMethod,
                createMethodType: "SELF_MADE"
            }
        };
        
        const payload = JSON.stringify(order);
        
        console.log('=== PAYLOAD ===');
        console.log('Length:', payload.length);
        console.log('Content:', payload);
        
        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å –∑–∞–∫–∞–∑–∞...');
        const rawSignature = await signDetached(payload, state.currentCert);
        
        console.log('=== SIGNATURE ===');
        console.log('Raw length:', rawSignature.length);
        console.log('Has newlines:', /[\r\n]/.test(rawSignature));
        console.log('Has spaces:', /\s/.test(rawSignature));
        console.log('First 100 chars:', rawSignature.substring(0, 100));
        
        // –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ–¥–ø–∏—Å—å –æ—á–∏—â–µ–Ω–∞
        const signature = rawSignature.replace(/[\r\n\s]/g, '');
        
        console.log('Cleaned length:', signature.length);
        log('üîê –î–ª–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∏: ' + signature.length + ' —Å–∏–º–≤–æ–ª–æ–≤');
        
        log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –°–£–ó...');
        const result = await req('order.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload, signature})
        });

        log('‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –û—Ç–≤–µ—Ç –°–£–ó:');
        log(JSON.stringify(result.response, null, 2));

        const createdOrder = result.response || {};
        const orderId = createdOrder.orderId || createdOrder.id || createdOrder.uuid || createdOrder.order_id || '';
        if (orderId) {
            state.lastOrderId = orderId;
            const orderInput = $('orderIdInput');
            if (orderInput) orderInput.value = orderId;
            log('üÜî ID –∑–∞–∫–∞–∑–∞: ' + orderId);
        }

        state.buffers = [];
        updateBufferOptions();
        updateStatus();
    } catch (e) {
        console.error('Full error:', e);
        log('‚ùå ' + e.message);
    }
};

function extractOrderInfos(payload) {
    if (!payload) return [];
    if (Array.isArray(payload)) return payload;
    if (Array.isArray(payload.orderInfos)) return payload.orderInfos;
    if (Array.isArray(payload.orders)) return payload.orders;
    return [];
}

function base64ToBlob(base64, contentType) {
    const binary = atob(base64);
    const length = binary.length;
    const bytes = new Uint8Array(length);
    for (let i = 0; i < length; i++) {
        bytes[i] = binary.charCodeAt(i);
    }
    return new Blob([bytes], {type: contentType || 'application/octet-stream'});
}

function applyOrderInfo(orderPayload, fallbackId) {
    const infos = extractOrderInfos(orderPayload);
    const buffers = [];
    infos.forEach(info => {
        const orderId = info.orderId || info.id || info.uuid || fallbackId || '';
        if (!state.lastOrderId && orderId) {
            state.lastOrderId = orderId;
            const orderInput = $('orderIdInput');
            if (orderInput) orderInput.value = orderId;
        }

        (info.buffers || []).forEach(buffer => {
            buffers.push({
                ...buffer,
                orderId,
                bufferId: buffer.bufferId || buffer.id || buffer.buffer_id || buffer.uuid || '',
            });
        });
    });

    state.buffers = buffers;
    updateBufferOptions();
    updateStatus();
}

$('statusBtn').onclick = async () => {
    const orderInput = $('orderIdInput');
    const orderId = (orderInput ? orderInput.value.trim() : '') || state.lastOrderId;

    if (!orderId) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞');
        return;
    }

    try {
        log('üîÑ –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞...');
        const data = await req('order_status.php?orderId=' + encodeURIComponent(orderId));
        const ordersPayload = data.orders || {};
        const output = $('statusOutput');
        if (output) output.textContent = JSON.stringify(ordersPayload, null, 2);

        state.lastOrderId = orderId;
        applyOrderInfo(ordersPayload, orderId);
        log('‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('listOrdersBtn').onclick = async () => {
    try {
        log('üìã –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤...');
        const data = await req('order_status.php?limit=5');
        const ordersPayload = data.orders || {};
        const output = $('statusOutput');
        if (output) output.textContent = JSON.stringify(ordersPayload, null, 2);

        const infos = extractOrderInfos(ordersPayload);
        if (infos.length) {
            const firstId = infos[0].orderId || infos[0].id || infos[0].uuid || '';
            if (firstId) {
                state.lastOrderId = firstId;
                const orderInput = $('orderIdInput');
                if (orderInput) orderInput.value = firstId;
            }
        }

        applyOrderInfo(ordersPayload);
        log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('downloadCodesBtn').onclick = async () => {
    const orderInput = $('orderIdInput');
    const orderId = (orderInput ? orderInput.value.trim() : '') || state.lastOrderId;

    if (!orderId) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞');
        return;
    }

    const bufferSelect = $('bufferSelect');
    let effectiveOrderId = orderId;
    let bufferId = '';
    if (bufferSelect && bufferSelect.value !== '') {
        const option = bufferSelect.options[bufferSelect.selectedIndex];
        if (option) {
            bufferId = option.dataset.key || '';
            if (option.dataset.orderId) {
                effectiveOrderId = option.dataset.orderId;
            }
        }
    }
    const format = $('codeFormat') ? $('codeFormat').value : 'CSV';
    const count = parseInt($('codeCount') ? $('codeCount').value : '1000', 10) || 1000;

    try {
        log('üì¶ –ó–∞–ø—Ä–æ—Å –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏...');
        const params = new URLSearchParams({
            orderId: effectiveOrderId,
            count: String(count),
            format,
        });
        if (bufferId) params.set('bufferId', bufferId);

        const result = await req('codes.php?' + params.toString());
        const payload = result.data || {};

        if (!payload.base64) {
            throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–∏—Å–∞ –∫–æ–¥–æ–≤');
        }

        if (state.downloadUrl) {
            URL.revokeObjectURL(state.downloadUrl);
        }

        const blob = base64ToBlob(payload.base64, payload.contentType);
        const url = URL.createObjectURL(blob);
        state.downloadUrl = url;

        const link = $('downloadLink');
        if (link) {
            const ext = format.toLowerCase() === 'json' ? 'json' : 'csv';
            link.href = url;
            link.download = `codes_${orderId}.${ext}`;
            link.style.display = 'inline-block';
        }

        log('‚úÖ –ú–∞—Å—Å–∏–≤ –ö–ú –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('sendUtilisationBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }

    const textarea = $('utilisationPayload');
    if (!textarea || !textarea.value.trim()) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–ª–æ –æ—Ç—á—ë—Ç–∞ –æ –Ω–∞–Ω–µ—Å–µ–Ω–∏–∏');
        return;
    }

    try {
        const parsed = JSON.parse(textarea.value);
        const payload = JSON.stringify(parsed);

        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å –æ—Ç—á—ë—Ç–∞...');
        const signature = await signDetached(payload, state.currentCert);

        log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞...');
        const result = await req('utilisation.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload, signature})
        });

        log('‚úÖ –û—Ç—á—ë—Ç –ø—Ä–∏–Ω—è—Ç:');
        log(JSON.stringify(result.response, null, 2));
    } catch (e) {
        if (e instanceof SyntaxError) {
            log('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç—á—ë—Ç–∞: ' + e.message);
        } else {
            log('‚ùå ' + e.message);
        }
    }
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
(async () => {
    try {
        const status = await req('auth.php?action=status');
        state.nkActive = status.nk.active;
        state.suzActive = status.suz.active;
        
        if (status.oms.connection && status.oms.id) {
            $('omsConnection').value = status.oms.connection;
            $('omsId').value = status.oms.id;
            state.omsSaved = true;
        }

        updateStatus();
        if (state.nkActive || state.suzActive || state.omsSaved) {
            log('‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Å–µ—Å—Å–∏–∏');
        }
    } catch (e) {
        console.error(e);
    }
})();

window.addEventListener('beforeunload', () => {
    if (state.downloadUrl) {
        URL.revokeObjectURL(state.downloadUrl);
    }
});
</script>

</body>
</html>