<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Заказ КМ</title>
    <script src="cadesplugin_api.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        h1 {
            font-size: 2rem;
            color: #1a202c;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .connection-toolbar {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: flex-start;
            flex-wrap: wrap;
            margin-bottom: 0;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .connection-status .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem;
            height: 1.8rem;
            border-radius: 999px;
            border: 2px solid currentColor;
            font-size: 1rem;
        }

        .connection-status.connected {
            color: #2f855a;
        }

        .connection-status.disconnected {
            color: #c53030;
        }
        
        .step {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .step h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #2d3748;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .status.inactive {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status.active {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        input[type="checkbox"] {
            width: auto;
            height: auto;
            margin: 0;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn-secondary {
            background: #edf2f7;
            color: #2d3748;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #e2e8f0;
        }
        
        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .card-info {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .card-info h3 {
            margin-bottom: 0.5rem;
            color: #2d3748;
        }

        .card-info .pill {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
        }

        .card-actions {
            margin-top: 1rem;
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .card-actions .form-group {
            margin-bottom: 0;
            min-width: 160px;
        }

        #cardQuantity {
            max-width: 160px;
        }

        .order-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .order-item {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: space-between;
            align-items: flex-start;
            background: #ffffff;
        }

        .order-item-info {
            flex: 1 1 220px;
        }

        .order-item-title {
            font-weight: 600;
            margin-bottom: 0.35rem;
            color: #2d3748;
        }

        .order-item-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .order-item-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .order-item-quantity-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 120px;
        }

        .order-item-quantity-wrapper label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #4a5568;
        }

        .order-item-quantity {
            width: 120px;
        }

        .order-item-remove {
            white-space: nowrap;
        }

        .order-items-summary {
            margin-top: 0.5rem;
            display: none;
            justify-content: flex-end;
            font-weight: 600;
            color: #2d3748;
        }

        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .mini-log {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-x: auto;
            min-height: 160px;
        }

        .hint {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-top: 0.25rem;
        }

        body.modal-open {
            overflow: hidden;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 1000;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: #ffffff;
            border-radius: 16px;
            width: 100%;
            max-width: 520px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.45);
            transform: translateY(20px);
            transition: transform 0.2s ease;
        }

        .modal-backdrop.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin-bottom: 0;
            font-size: 1.4rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #4a5568;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .modal-section h3 {
            font-size: 1rem;
            color: #2d3748;
        }

        .modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .grid.grid-small {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        label.checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 0;
            color: #4a5568;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="page-header">
        <h1>🎯 Заказ кодов маркировки</h1>
        <div class="connection-toolbar">
            <button class="btn btn-primary" id="openSettingsBtn" type="button">Настройки соединения</button>
            <div class="connection-status disconnected" id="connectionStatus">
                <span class="status-icon" id="connectionStatusIcon">✖</span>
                <span id="connectionStatusText">Нет соединения</span>
            </div>
        </div>
    </div>
    <p class="subtitle">Простой способ создать заказ в СУЗ через True API</p>
    <p class="hint" style="margin-bottom: 1.5rem;">
        Для управления сертификатами, получения токенов и сохранения настроек OMS используйте кнопку
        «Настройки соединения».
    </p>

    <!-- Шаг 1: Карточка -->
    <div class="step">
        <h2>Шаг 1: Найти карточку товара</h2>

        <div class="form-group">
            <label>GTIN товара</label>
            <input type="text" id="gtinInput" placeholder="04601234567890">
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" id="findCardBtn">Найти карточку</button>
            <label class="btn btn-secondary" style="cursor: pointer; margin: 0;">
                📁 Загрузить Excel с GTIN
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
            </label>
        </div>

        <div class="card-info" id="excelProgress" style="display: none; margin-top: 1rem;">
            <h3>Обработка файла</h3>
            <div style="margin-top: 0.5rem;">
                <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="excelProgressBar" style="background: #667eea; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="excelProgressText" style="margin-top: 0.5rem; color: #4a5568; font-size: 0.9rem;"></p>
            </div>
        </div>
        
        <div class="card-info" id="cardInfo" style="display: none;">
            <h3 id="cardName"></h3>
            <div id="cardPills"></div>
            <p id="cardDetails" style="margin-top: 0.5rem; color: #718096;"></p>
            <div class="card-actions">
                <div class="form-group">
                    <label for="cardQuantity">Количество КМ для заказа</label>
                    <input type="number" id="cardQuantity" value="1" min="1">
                </div>
                <button class="btn btn-secondary" id="addCardBtn" type="button">Добавить карточку в заказ</button>
            </div>
        </div>
    </div>

    <!-- Шаг 2: Заказ -->
    <div class="step">
        <h2>Шаг 2: Параметры заказа</h2>

        <div class="form-group">
            <label>Карточки в заказе</label>
            <p class="hint" id="orderItemsEmpty">Добавьте карточки на Шаге 1 и укажите количество для массового заказа.</p>
            <div class="order-items" id="orderItemsList"></div>
            <div class="order-items-summary" id="orderItemsSummary">
                <span id="orderItemsTotal">Всего КМ: 0</span>
            </div>
        </div>

        <div class="grid">
            <div class="form-group">
                <label>Товарная группа</label>
                <select id="productGroup">
                    <option value="">Выберите группу</option>
                    <option value="lp">Легкая промышленность</option>
                    <option value="shoes">Обувь</option>
                    <option value="tobacco">Табак</option>
                    <option value="pharma">Лекарства</option>
                </select>
            </div>

            <div class="form-group">
                <label>Способ выпуска</label>
                <select id="releaseMethod">
                    <option value="PRODUCTION">Произведено в РФ</option>
                    <option value="IMPORT">Импорт</option>
                    <option value="REMAINS">Маркировка остатков</option>
                </select>
            </div>
        </div>

        <div class="form-group" id="lpAttributes" style="display: none;">
            <label>Параметры оплаты для одежды</label>
            <div class="grid grid-small">
                <label class="checkbox">
                    <input type="checkbox" id="lpFreeCode">
                    КМ не подлежит оплате (freeCode)
                </label>
                <div>
                    <label for="lpPaymentType">Тип оплаты</label>
                    <select id="lpPaymentType">
                        <option value="1">Оплата по эмиссии</option>
                        <option value="2" selected>Оплата по нанесению</option>
                    </select>
                    <p class="hint">Значение отправляется только для текущей товарной группы одежды.</p>
                </div>
            </div>
        </div>

        <button class="btn btn-primary" id="createOrderBtn" disabled>Создать заказ</button>
    </div>

    <!-- Шаг 3: Статус заказа -->
    <div class="step">
        <h2>Шаг 3: Проверить статус заказа</h2>

        <div class="form-group">
            <label>ID заказа</label>
            <input type="text" id="orderIdInput" placeholder="UUID заказа">
            <p class="hint">После создания заказа идентификатор подставится автоматически.</p>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" id="statusBtn" disabled>Обновить статус</button>
            <button class="btn btn-secondary" id="listOrdersBtn" disabled>Показать последние заказы</button>
        </div>

        <div class="card-info" style="margin-top: 1rem;">
            <h3>Статусы заказов</h3>
            <pre class="mini-log" id="statusOutput">Статус заказа появится здесь после запроса.</pre>
        </div>
    </div>

    <!-- Шаг 4: Получить КМ -->
    <div class="step">
        <h2>Шаг 4: Получить массивы КМ</h2>

        <div class="form-group">
            <label>Буфер</label>
            <select id="bufferSelect" disabled>
                <option>Буферы не найдены</option>
            </select>
            <p class="hint">Запрос статуса заполнит список активных буферов заказа.</p>
        </div>

        <div class="grid">
            <div class="form-group">
                <label>GTIN для получения КМ</label>
                <input type="text" id="codeGtin" placeholder="04601234567890" maxlength="14">
                <p class="hint">Используйте GTIN из карточки товара. Формат — 14 цифр.</p>
            </div>

            <div class="form-group">
                <label>Количество КМ за запрос</label>
                <input type="number" id="codeQuantity" value="1000" min="1" max="150000">
                <p class="hint">Максимально допустимое значение — 150 000 КМ.</p>
            </div>

            <div class="form-group">
                <label>Формат файла</label>
                <select id="codeFormat">
                    <option value="CSV">CSV</option>
                    <option value="JSON">JSON</option>
                </select>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" id="downloadCodesBtn" disabled>Скачать КМ</button>
            <a class="btn btn-secondary" id="downloadLink" style="display: none;" download>Скачать файл</a>
        </div>
    </div>

    <!-- Шаг 5: Ввод в оборот -->
    <div class="step">
        <h2>Шаг 5: Отчёт о нанесении (ввод в оборот)</h2>
        <p class="hint">Используйте полные КМ (sntins) из буфера. Максимум 30 000 КМ за запрос.</p>

        <textarea id="utilisationPayload">{
  "productGroup": "",
  "utilisationType": "UTILISATION",
  "sntins": [
    ""
  ],
  "attributes": {}
}</textarea>

        <div class="btn-group" style="margin-top: 1rem;">
            <button class="btn btn-primary" id="sendUtilisationBtn" disabled>Отправить отчёт</button>
        </div>
    </div>

    <!-- Лог -->
    <div class="log" id="log">Готов к работе...</div>
</div>

<div class="modal-backdrop" id="settingsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal-header">
            <h2 id="settingsTitle">Авторизация и настройки OMS</h2>
            <button class="modal-close" id="closeSettingsBtn" aria-label="Закрыть">×</button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <h3>Статусы подключения</h3>
                <div class="status inactive" id="nkStatus">
                    <span>🔴</span>
                    <span>Токен НК: не получен</span>
                </div>
                <div class="status inactive" id="suzStatus">
                    <span>🔴</span>
                    <span>Токен СУЗ: не получен</span>
                </div>
                <div class="status inactive" id="omsStatus">
                    <span>🔴</span>
                    <span>OMS настройки: не сохранены</span>
                </div>
            </div>

            <div class="modal-section">
                <h3>Сертификат и токены</h3>
                <div class="form-group">
                    <label for="certSelect">Сертификат УКЭП</label>
                    <select id="certSelect" disabled>
                        <option>Загрузите сертификаты...</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="loadCertsBtn" type="button">Обновить сертификаты</button>
                    <button class="btn btn-primary" id="authNkBtn" type="button" disabled>Получить токен НК</button>
                    <button class="btn btn-primary" id="authSuzBtn" type="button" disabled>Получить токен СУЗ</button>
                </div>
            </div>

            <div class="modal-section">
                <h3>Настройки OMS</h3>
                <div class="form-group">
                    <label for="omsConnection">Идентификатор соединения</label>
                    <input type="text" id="omsConnection" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
                    <p class="hint">Используйте GUID из личного кабинета ОМС.</p>
                </div>
                <div class="form-group">
                    <label for="omsId">OMS ID (UUID идентификатор)</label>
                    <input type="text" id="omsId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancelSettingsBtn" type="button">Отмена</button>
            <button class="btn btn-primary" id="saveOmsBtn" type="button">Сохранить</button>
        </div>
    </div>
</div>

<script>
const state = {
    certs: [],
    currentCert: null,
    card: null,
    orderItems: [],
    nkActive: false,
    suzActive: false,
    omsSaved: false,
    omsConnection: '',
    omsId: '',
    lastOrderId: '',
    buffers: [],
    downloadUrl: null
};

const $ = id => document.getElementById(id);

const STORAGE_KEYS = {
    omsConnection: 'ms_chz_oms_connection',
    omsId: 'ms_chz_oms_id'
};

function loadStoredOmsSettings() {
    try {
        return {
            connection: localStorage.getItem(STORAGE_KEYS.omsConnection) || '',
            id: localStorage.getItem(STORAGE_KEYS.omsId) || ''
        };
    } catch (e) {
        console.warn('Не удалось загрузить OMS из localStorage', e);
        return {connection: '', id: ''};
    }
}

function persistOmsSettings(connection, id) {
    try {
        if (connection) {
            localStorage.setItem(STORAGE_KEYS.omsConnection, connection);
        } else {
            localStorage.removeItem(STORAGE_KEYS.omsConnection);
        }

        if (id) {
            localStorage.setItem(STORAGE_KEYS.omsId, id);
        } else {
            localStorage.removeItem(STORAGE_KEYS.omsId);
        }
    } catch (e) {
        console.warn('Не удалось сохранить OMS в localStorage', e);
    }
}

function applyOmsInputs(connection, id) {
    const connectionInput = $('omsConnection');
    if (connectionInput) {
        connectionInput.value = connection || '';
    }

    const idInput = $('omsId');
    if (idInput) {
        idInput.value = id || '';
    }
}

const storedOms = loadStoredOmsSettings();
if (storedOms.connection || storedOms.id) {
    state.omsConnection = storedOms.connection || state.omsConnection;
    state.omsId = storedOms.id || state.omsId;
    applyOmsInputs(state.omsConnection, state.omsId);
}

let nkAuthInProgress = false;
let suzAuthInProgress = false;
let omsRestoreInProgress = false;

function log(msg) {
    $('log').textContent += '\n' + msg;
    $('log').scrollTop = $('log').scrollHeight;
    console.log('[MS_CHZ]', msg);
}

function clearErrorState() {
    console.log('[MS_CHZ] Clearing error state');
}

function normalizeGtin(rawGtin) {
    if (!rawGtin && rawGtin !== 0) return '';
    const digits = String(rawGtin).replace(/\D+/g, '');
    if (!digits) return '';
    if (digits.length < 14) {
        return digits.padStart(14, '0');
    }
    if (digits.length === 14) {
        return digits;
    }
    return '';
}

function updateOrderItemsSummary() {
    const summary = $('orderItemsSummary');
    const totalEl = $('orderItemsTotal');
    if (!summary || !totalEl) return;

    const total = (state.orderItems || []).reduce((acc, item) => {
        const value = parseInt(item.quantity, 10);
        return acc + (Number.isFinite(value) ? value : 0);
    }, 0);

    totalEl.textContent = 'Всего КМ: ' + total;
    summary.style.display = state.orderItems.length ? 'flex' : 'none';
}

function renderOrderItems() {
    const list = $('orderItemsList');
    const emptyHint = $('orderItemsEmpty');
    if (!list || !emptyHint) return;

    list.innerHTML = '';

    if (!state.orderItems.length) {
        emptyHint.style.display = 'block';
        updateOrderItemsSummary();
        return;
    }

    emptyHint.style.display = 'none';

    state.orderItems.forEach((item, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'order-item';

        const info = document.createElement('div');
        info.className = 'order-item-info';

        const title = document.createElement('div');
        title.className = 'order-item-title';
        title.textContent = item.name || 'Без названия';
        info.appendChild(title);

        const pills = document.createElement('div');
        pills.className = 'order-item-pills';

        const gtinPill = document.createElement('span');
        gtinPill.className = 'pill';
        gtinPill.textContent = 'GTIN: ' + item.gtin;
        pills.appendChild(gtinPill);

        if (item.goodId) {
            const goodPill = document.createElement('span');
            goodPill.className = 'pill';
            goodPill.textContent = 'ID: ' + item.goodId;
            pills.appendChild(goodPill);
        }

        if (item.templateId) {
            const templatePill = document.createElement('span');
            templatePill.className = 'pill';
            templatePill.textContent = 'template ' + item.templateId;
            pills.appendChild(templatePill);
        }

        if (item.productGroup) {
            const groupPill = document.createElement('span');
            groupPill.className = 'pill';
            groupPill.textContent = 'группа ' + item.productGroup;
            pills.appendChild(groupPill);
        }

        info.appendChild(pills);
        wrapper.appendChild(info);

        const controls = document.createElement('div');
        controls.className = 'order-item-controls';

        const quantityWrapper = document.createElement('div');
        quantityWrapper.className = 'order-item-quantity-wrapper';

        const quantityId = `orderItemQuantity${index}`;
        const quantityLabel = document.createElement('label');
        quantityLabel.className = 'order-item-quantity-label';
        quantityLabel.setAttribute('for', quantityId);
        quantityLabel.textContent = 'Количество';

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.min = '1';
        quantityInput.id = quantityId;
        quantityInput.value = String(item.quantity || 1);
        quantityInput.className = 'order-item-quantity';
        quantityInput.addEventListener('input', () => {
            const value = parseInt(quantityInput.value, 10);
            if (!Number.isFinite(value) || value <= 0) {
                state.orderItems[index].quantity = 0;
            } else {
                state.orderItems[index].quantity = value;
            }
            updateOrderItemsSummary();
            updateStatus();
        });
        quantityInput.addEventListener('blur', () => {
            let value = parseInt(quantityInput.value, 10);
            if (!Number.isFinite(value) || value <= 0) {
                value = 1;
            }
            quantityInput.value = String(value);
            state.orderItems[index].quantity = value;
            updateOrderItemsSummary();
            updateStatus();
        });

        quantityWrapper.appendChild(quantityLabel);
        quantityWrapper.appendChild(quantityInput);
        controls.appendChild(quantityWrapper);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-secondary order-item-remove';
        removeBtn.textContent = 'Удалить';
        removeBtn.addEventListener('click', () => {
            const removed = state.orderItems.splice(index, 1)[0];
            renderOrderItems();
            updateStatus();
            if (removed) {
                log(`➖ Карточка ${removed.gtin} удалена из заказа`);
            }
        });
        controls.appendChild(removeBtn);

        wrapper.appendChild(controls);
        list.appendChild(wrapper);
    });

    updateOrderItemsSummary();
}

function updateBufferOptions() {
    const select = $('bufferSelect');
    if (!select) return;

    const previous = select.value;
    select.innerHTML = '';

    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = state.buffers.length ? 'Автовыбор буфера' : 'Буферы не найдены';
    select.appendChild(placeholder);

    state.buffers.forEach((buffer, index) => {
        const option = document.createElement('option');
        option.value = String(index);
        option.dataset.key = buffer.bufferId || buffer.id || buffer.buffer_id || buffer.uuid || '';
        option.dataset.orderId = buffer.orderId || state.lastOrderId;

        const pieces = [];
        if (buffer.gtin) pieces.push(`GTIN ${buffer.gtin}`);
        if (buffer.templateId) pieces.push(`template ${buffer.templateId}`);
        const left = buffer.leftInBuffer ?? buffer.left ?? buffer.totalCodes ?? null;
        if (left !== null) pieces.push(`доступно ${left}`);

        const label = pieces.length ? pieces.join(' • ') : 'без подробностей';
        option.textContent = `${option.dataset.key || 'Буфер ' + (index + 1)} • ${label}`;
        select.appendChild(option);
    });

    select.disabled = state.buffers.length === 0;

    if (previous && [...select.options].some(opt => opt.value === previous)) {
        select.value = previous;
    } else {
        select.value = '';
    }
}

function updateStatus() {
    const nkStatus = $('nkStatus');
    if (nkStatus) {
        nkStatus.className = 'status ' + (state.nkActive ? 'active' : 'inactive');
        nkStatus.innerHTML = state.nkActive
            ? '<span>✅</span><span>Токен НК: активен</span>'
            : '<span>🔴</span><span>Токен НК: не получен</span>';
    }

    const suzStatus = $('suzStatus');
    if (suzStatus) {
        suzStatus.className = 'status ' + (state.suzActive ? 'active' : 'inactive');
        suzStatus.innerHTML = state.suzActive
            ? '<span>✅</span><span>Токен СУЗ: активен</span>'
            : '<span>🔴</span><span>Токен СУЗ: не получен</span>';
    }

    const omsStatus = $('omsStatus');
    const shortConnection = state.omsConnection
        ? `${state.omsConnection.slice(0, 8)}…${state.omsConnection.slice(-4)}`
        : '';
    const omsDescription = state.omsSaved
        ? shortConnection
            ? `OMS настройки: сохранены (${shortConnection})`
            : 'OMS настройки: сохранены'
        : 'OMS настройки: не сохранены';

    if (omsStatus) {
        omsStatus.className = 'status ' + (state.omsSaved ? 'active' : 'inactive');
        omsStatus.innerHTML = state.omsSaved
            ? `<span>✅</span><span>${omsDescription}</span>`
            : '<span>🔴</span><span>OMS настройки: не сохранены</span>';
    }

    const connectionIndicator = $('connectionStatus');
    const connectionIcon = $('connectionStatusIcon');
    const connectionText = $('connectionStatusText');
    if (connectionIndicator && connectionIcon && connectionText) {
        const connected = state.nkActive && state.suzActive && state.omsSaved;
        connectionIndicator.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
        connectionIcon.textContent = connected ? '✔' : '✖';
        connectionText.textContent = connected ? 'Соединение установлено' : 'Нет соединения';
    }

    const hasValidItems = Array.isArray(state.orderItems)
        && state.orderItems.some(item => {
            const value = parseInt(item.quantity, 10);
            return Number.isFinite(value) && value > 0;
        });
    const canOrder = state.nkActive && state.suzActive && state.omsSaved && hasValidItems;
    const createBtn = $('createOrderBtn');
    if (createBtn) createBtn.disabled = !canOrder;

    const statusBtn = $('statusBtn');
    if (statusBtn) statusBtn.disabled = !(state.suzActive && state.omsSaved);

    const listOrdersBtn = $('listOrdersBtn');
    if (listOrdersBtn) listOrdersBtn.disabled = !(state.suzActive && state.omsSaved);

    const downloadBtn = $('downloadCodesBtn');
    if (downloadBtn) {
        const orderInput = $('orderIdInput');
        const gtinInput = $('codeGtin');
        const hasOrderId = !!(state.lastOrderId || (orderInput && orderInput.value));
        const hasGtin = !!(gtinInput && gtinInput.value.trim());
        downloadBtn.disabled = !(state.suzActive && state.omsSaved && hasOrderId && hasGtin);
    }

    const utilBtn = $('sendUtilisationBtn');
    if (utilBtn) utilBtn.disabled = !(state.suzActive && state.currentCert && state.omsSaved);

    const authNkBtn = $('authNkBtn');
    if (authNkBtn) authNkBtn.disabled = !state.currentCert;

    const authSuzBtn = $('authSuzBtn');
    if (authSuzBtn) authSuzBtn.disabled = !state.currentCert || !state.omsSaved;

    if (state.lastOrderId) {
        const orderInput = $('orderIdInput');
        if (orderInput && !orderInput.value) {
            orderInput.value = state.lastOrderId;
        }
    }

    updateBufferOptions();
}

function updateClothingVisibility() {
    const block = $('lpAttributes');
    const select = $('productGroup');
    if (!block || !select) return;

    const isClothing = select.value === 'lp';
    block.style.display = isClothing ? 'block' : 'none';
}

['orderIdInput', 'codeGtin'].forEach(id => {
    const element = $(id);
    if (element) {
        element.addEventListener('input', () => updateStatus());
    }
});

const productGroupSelect = $('productGroup');
if (productGroupSelect) {
    productGroupSelect.addEventListener('change', () => {
        updateClothingVisibility();
    });
}

updateClothingVisibility();
renderOrderItems();
updateStatus();

async function req(url, options = {}) {
    const resp = await fetch(url, options);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);
    return data;
}

async function autoRestoreOmsSettingsFromStorage() {
    if (omsRestoreInProgress) return false;

    const stored = loadStoredOmsSettings();
    if (!stored.connection || !stored.id) {
        return false;
    }

    omsRestoreInProgress = true;
    try {
        log('🤖 Автовосстановление настроек OMS...');
        await req('auth.php?action=save-oms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({omsConnection: stored.connection, omsId: stored.id})
        });

        state.omsSaved = true;
        state.omsConnection = stored.connection;
        state.omsId = stored.id;
        applyOmsInputs(stored.connection, stored.id);
        persistOmsSettings(stored.connection, stored.id);
        updateStatus();
        log('🤖 ✅ Настройки OMS восстановлены автоматически');
        return true;
    } catch (e) {
        log('⚠️ Не удалось автоматически восстановить настройки OMS: ' + e.message);
        return false;
    } finally {
        omsRestoreInProgress = false;
    }
}

function setModalVisibility(visible) {
    const modal = $('settingsModal');
    if (!modal) return;

    if (visible) {
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');

        const connectionInput = $('omsConnection');
        if (connectionInput) {
            connectionInput.value = state.omsConnection || '';
            connectionInput.focus();
            connectionInput.select();
        }

        const idInput = $('omsId');
        if (idInput) {
            idInput.value = state.omsId || '';
        }
    } else {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        const trigger = $('openSettingsBtn');
        if (trigger) {
            trigger.focus();
        }
    }
}

const openSettingsBtn = $('openSettingsBtn');
if (openSettingsBtn) {
    openSettingsBtn.addEventListener('click', () => setModalVisibility(true));
}

['closeSettingsBtn', 'cancelSettingsBtn'].forEach(id => {
    const btn = $(id);
    if (btn) {
        btn.addEventListener('click', () => setModalVisibility(false));
    }
});

const settingsBackdrop = $('settingsModal');
if (settingsBackdrop) {
    settingsBackdrop.addEventListener('click', (event) => {
        if (event.target === settingsBackdrop) {
            setModalVisibility(false);
        }
    });
}

document.addEventListener('keydown', (event) => {
    const modal = $('settingsModal');
    if (event.key === 'Escape' && modal && modal.classList.contains('active')) {
        setModalVisibility(false);
    }
});

async function loadCertificates(isAuto = false) {
    try {
        log(isAuto ? '🔄 Автозагрузка сертификатов...' : '🔄 Обновление списка сертификатов...');

        await cadesplugin;
        const store = await cadesplugin.CreateObjectAsync('CAdESCOM.Store');
        await store.Open(2, 'My', 2);

        const certs = await store.Certificates;
        const count = await certs.Count;

        const select = $('certSelect');
        state.certs = [];
        state.currentCert = null;
        if (select) {
            select.innerHTML = '';
            select.disabled = true;
        }

        for (let i = 1; i <= count; i++) {
            const cert = await certs.Item(i);
            const validTo = new Date(await cert.ValidToDate);
            if (validTo < new Date()) continue;

            state.certs.push(cert);
            const option = document.createElement('option');
            option.value = state.certs.length - 1;
            option.textContent = await cert.SubjectName;
            if (select) {
                select.appendChild(option);
            }
        }

        await store.Close();

        if (state.certs.length) {
            if (select) {
                select.disabled = false;
                select.value = '0';
            }
            state.currentCert = state.certs[0];
            $('authNkBtn').disabled = false;
            $('authSuzBtn').disabled = false;
            log(`✅ Сертификаты ${isAuto ? 'загружены автоматически' : 'обновлены'}: ` + state.certs.length);
        } else {
            log('❌ Действующие сертификаты не найдены');
            $('authNkBtn').disabled = true;
            $('authSuzBtn').disabled = true;
            if (select) {
                const placeholder = document.createElement('option');
                placeholder.textContent = 'Сертификаты не найдены';
                placeholder.disabled = true;
                placeholder.selected = true;
                select.appendChild(placeholder);
            }
        }

        updateStatus();
        return state.certs.length;
    } catch (e) {
        state.certs = [];
        state.currentCert = null;
        updateStatus();
        log(`❌ ${isAuto ? 'Не удалось автоматически загрузить сертификаты' : 'Ошибка загрузки сертификатов'}: ` + e.message);
        return 0;
    }
}

$('loadCertsBtn').onclick = async () => {
    await loadCertificates(false);
};

$('certSelect').onchange = (e) => {
    state.currentCert = state.certs[e.target.value];
    updateStatus();
};

async function signAttached(data, cert) {
    const signer = await cadesplugin.CreateObjectAsync('CAdESCOM.CPSigner');
    await signer.propset_Certificate(cert);
    
    const sd = await cadesplugin.CreateObjectAsync('CAdESCOM.CadesSignedData');
    
    if (typeof sd.propset_ContentEncoding === 'function') {
        try {
            await sd.propset_ContentEncoding(cadesplugin.CADESCOM_STRING_TO_UCS2LE);
        } catch (e) {
            console.log('ContentEncoding не установлена');
        }
    }
    
    await sd.propset_Content(data);
    
    return sd.SignCades(signer, cadesplugin.CADESCOM_CADES_BES);
}

function encodeBase64Utf8(data) {
    const utf8 = new TextEncoder().encode(data);
    let binary = '';
    for (const byte of utf8) {
        binary += String.fromCharCode(byte);
    }
    return btoa(binary);
}

async function signDetached(data, cert) {
    const signer = await cadesplugin.CreateObjectAsync('CAdESCOM.CPSigner');
    await signer.propset_Certificate(cert);

    const sd = await cadesplugin.CreateObjectAsync('CAdESCOM.CadesSignedData');

    const base64Payload = encodeBase64Utf8(data);
    if (typeof sd.propset_ContentEncoding === 'function') {
        await sd.propset_ContentEncoding(cadesplugin.CADESCOM_BASE64_TO_BINARY);
    }
    await sd.propset_Content(base64Payload);

    const signature = await sd.SignCades(signer, cadesplugin.CADESCOM_CADES_BES, true);

    return signature.replace(/[\r\n\s]/g, '');
}

async function authorizeNk({auto = false} = {}) {
    if (nkAuthInProgress) return false;

    if (!state.currentCert) {
        if (auto) {
            log('ℹ️ Выберите сертификат для автоматического получения токена НК');
        } else {
            log('❌ Выберите сертификат');
        }
        return false;
    }

    if (auto && state.nkActive) {
        log('ℹ️ Токен НК уже активен, автоматическое обновление не требуется');
        return true;
    }

    nkAuthInProgress = true;
    const prefix = auto ? '🤖 ' : '';

    try {
        log(`${prefix}🔐 Запрос challenge НК...`);
        const challenge = await req('auth.php?action=nk-challenge');

        log(`${prefix}✍️ Подпись challenge...`);
        const signature = await signAttached(challenge.data, state.currentCert);

        log(`${prefix}📤 Обмен на токен...`);
        await req('auth.php?action=nk-signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: challenge.uuid, signature})
        });

        state.nkActive = true;
        updateStatus();
        log(`${prefix}✅ Токен НК ${auto ? 'получен автоматически' : 'получен'}`);
        return true;
    } catch (e) {
        log(`${auto ? '⚠️ Не удалось автоматически получить токен НК: ' : '❌ '}` + e.message);
        return false;
    } finally {
        nkAuthInProgress = false;
    }
}

async function authorizeSuz({auto = false} = {}) {
    if (suzAuthInProgress) return false;

    if (!state.currentCert) {
        if (auto) {
            log('ℹ️ Выберите сертификат для автоматического получения токена СУЗ');
        } else {
            log('❌ Выберите сертификат');
        }
        return false;
    }

    const omsConnection = state.omsConnection || $('omsConnection').value.trim();
    const omsId = state.omsId || $('omsId').value.trim();

    if (!omsConnection || !omsId) {
        if (auto) {
            log('ℹ️ Для автоматического получения токена СУЗ заполните и сохраните настройки OMS');
        } else {
            log('❌ Заполните идентификатор соединения и OMS ID');
            setModalVisibility(true);
        }
        return false;
    }

    suzAuthInProgress = true;
    const prefix = auto ? '🤖 ' : '';

    try {
        log(`${prefix}🔐 Запрос challenge СУЗ...`);
        const challenge = await req('auth.php?action=suz-challenge');

        log(`${prefix}✍️ Подпись challenge...`);
        const signature = await signAttached(challenge.data, state.currentCert);

        log(`${prefix}📤 Обмен на clientToken...`);
        await req('auth.php?action=suz-signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: challenge.uuid, signature, omsConnection, omsId})
        });

        state.suzActive = true;
        state.omsConnection = omsConnection;
        state.omsId = omsId;
        state.omsSaved = true;
        persistOmsSettings(omsConnection, omsId);
        applyOmsInputs(omsConnection, omsId);
        updateStatus();
        log(`${prefix}✅ Токен СУЗ ${auto ? 'получен автоматически' : 'получен'}`);
        return true;
    } catch (e) {
        log(`${auto ? '⚠️ Не удалось автоматически получить токен СУЗ: ' : '❌ '}` + e.message);
        return false;
    } finally {
        suzAuthInProgress = false;
    }
}

$('saveOmsBtn').onclick = async () => {
    const omsConnection = $('omsConnection').value.trim();
    const omsId = $('omsId').value.trim();

    if (!omsConnection || !omsId) {
        log('❌ Заполните идентификатор соединения и OMS ID');
        return;
    }

    try {
        await req('auth.php?action=save-oms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({omsConnection, omsId})
        });

        state.omsSaved = true;
        state.omsConnection = omsConnection;
        state.omsId = omsId;
        persistOmsSettings(omsConnection, omsId);
        applyOmsInputs(omsConnection, omsId);
        updateStatus();
        log('✅ Настройки OMS сохранены');
        setModalVisibility(false);

        await authorizeSuz({auto: true});
    } catch (e) {
        log('❌ ' + e.message);
    }
};

$('authNkBtn').onclick = async () => {
    await authorizeNk();
};

$('authSuzBtn').onclick = async () => {
    await authorizeSuz();
};

$('findCardBtn').onclick = async () => {
    const gtin = $('gtinInput').value.trim();
    if (!gtin) {
        log('❌ Укажите GTIN');
        return;
    }
    
    if (!state.nkActive) {
        log('❌ Сначала получите токен НК');
        return;
    }
    
    await findAndDisplayCard(gtin);
};

async function findAndDisplayCard(gtin) {
    try {
        log('🔍 Поиск карточки...');
        const card = await req('card.php?gtin=' + encodeURIComponent(gtin));
        
        state.card = card;
        
        $('cardInfo').style.display = 'block';
        $('cardName').textContent = card.name || 'Без названия';
        
        const pills = [];
        if (card.goodId) pills.push(`<span class="pill">ID: ${card.goodId}</span>`);
        if (card.gtin) pills.push(`<span class="pill">GTIN: ${card.gtin}</span>`);
        $('cardPills').innerHTML = pills.join('');
        
        $('cardDetails').textContent =
            (card.tnved ? `ТН ВЭД: ${card.tnved}` : '') +
            (card.productGroup ? ` • Группа: ${card.productGroup}` : '');

        const cardQuantityInput = $('cardQuantity');
        if (cardQuantityInput) {
            cardQuantityInput.value = '1';
        }

        if (card.productGroup) {
            $('productGroup').value = card.productGroup;
            updateClothingVisibility();
        }

        const codeGtinInput = $('codeGtin');
        if (codeGtinInput && card.gtin) {
            let normalized = String(card.gtin).replace(/\s+/g, '');
            if (/^\d+$/.test(normalized)) {
                if (normalized.length < 14) {
                    normalized = normalized.padStart(14, '0');
                }
                if (normalized.length === 14) {
                    codeGtinInput.value = normalized;
                } else {
                    codeGtinInput.value = card.gtin;
                }
            } else {
                codeGtinInput.value = card.gtin;
            }
        }

        updateStatus();
        log('✅ Карточка найдена');
        return card;
    } catch (e) {
        log('❌ ' + e.message);
        state.card = null;
        $('cardInfo').style.display = 'none';
        updateStatus();
        return null;
    }
}



// Загружаем библиотеку SheetJS один раз
let XLSX = null;
async function loadXLSX() {
    if (XLSX) return XLSX;
    
    return new Promise((resolve, reject) => {
        if (typeof window.XLSX !== 'undefined') {
            XLSX = window.XLSX;
            resolve(XLSX);
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
        script.onload = () => {
            // Даем библиотеке время на инициализацию
            setTimeout(() => {
                if (typeof window.XLSX !== 'undefined') {
                    XLSX = window.XLSX;
                    console.log('[XLSX] Библиотека загружена успешно');
                    resolve(XLSX);
                } else {
                    console.error('[XLSX] window.XLSX не определен после загрузки');
                    reject(new Error('Библиотека загружена, но window.XLSX не определен'));
                }
            }, 100);
        };
        script.onerror = () => {
            console.warn('[XLSX] Основной CDN недоступен, пробуем запасной');
            // Fallback на другой CDN
            const scriptFallback = document.createElement('script');
            scriptFallback.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
            scriptFallback.onload = () => {
                setTimeout(() => {
                    if (typeof window.XLSX !== 'undefined') {
                        XLSX = window.XLSX;
                        console.log('[XLSX] Библиотека загружена с запасного CDN');
                        resolve(XLSX);
                    } else {
                        reject(new Error('Библиотека загружена, но window.XLSX не определен'));
                    }
                }, 100);
            };
            scriptFallback.onerror = () => {
                reject(new Error('Не удалось загрузить библиотеку для работы с Excel. Проверьте подключение к интернету.'));
            };
            document.head.appendChild(scriptFallback);
        };
        document.head.appendChild(script);
    });
}

$('excelFileInput').onchange = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    if (!state.nkActive) {
        log('❌ Сначала получите токен НК');
        event.target.value = '';
        return;
    }

    const progressBlock = $('excelProgress');
    const progressBar = $('excelProgressBar');
    const progressText = $('excelProgressText');
    
    progressBlock.style.display = 'block';
    progressText.textContent = 'Загрузка библиотеки Excel...';
    progressBar.style.width = '5%';

    try {
        log('📂 Загрузка Excel файла: ' + file.name);

        // Загружаем библиотеку
        const XLSXLib = await loadXLSX();
        log('✅ Библиотека Excel загружена');
        
        progressText.textContent = 'Чтение файла...';
        progressBar.style.width = '10%';

        const arrayBuffer = await file.arrayBuffer();
        
        progressText.textContent = 'Парсинг Excel...';
        progressBar.style.width = '20%';

        // Парсим Excel
        const workbook = XLSXLib.read(arrayBuffer);
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSXLib.utils.sheet_to_json(firstSheet, { header: 1 });

        if (!data || data.length === 0) {
            throw new Error('Файл пуст');
        }

        const headers = data[0];
        const gtinColumnIndex = headers.findIndex(h => 
            String(h).toLowerCase().includes('gtin')
        );

        if (gtinColumnIndex === -1) {
            throw new Error('Колонка GTIN не найдена. Убедитесь, что в первой строке есть заголовок содержащий "GTIN"');
        }

        const gtins = [];
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const gtin = row[gtinColumnIndex];
            if (gtin && String(gtin).trim()) {
                gtins.push(String(gtin).trim());
            }
        }

        if (gtins.length === 0) {
            throw new Error('В файле не найдено ни одного GTIN');
        }

        log(`📊 Найдено ${gtins.length} GTIN в файле`);
        progressText.textContent = `Обработка 0/${gtins.length} карточек...`;
        
        let processed = 0;
        let successful = 0;
        let failed = 0;

        for (const gtin of gtins) {
            try {
                progressText.textContent = `Обработка ${processed + 1}/${gtins.length}: ${gtin}`;
                progressBar.style.width = `${20 + (processed / gtins.length) * 70}%`;

                const card = await findAndDisplayCard(gtin);
                
                if (card) {
                    const normalized = normalizeGtin(card.gtin);
                    if (normalized) {
                        const existing = state.orderItems.find(item => item.gtin === normalized);
                        if (existing) {
                            existing.quantity = parseInt(existing.quantity, 10) + 1;
                            log(`➕ Количество для GTIN ${normalized} увеличено до ${existing.quantity}`);
                        } else {
                            state.orderItems.push({
                                gtin: normalized,
                                quantity: 1,
                                name: card.name || 'Без названия',
                                templateId: card.templateId || 10,
                                productGroup: card.productGroup || '',
                                goodId: card.goodId || ''
                            });
                            log(`✅ Добавлена карточка ${normalized}`);
                        }
                        successful++;
                    }
                } else {
                    failed++;
                }
            } catch (e) {
                log(`⚠️ Не удалось обработать ${gtin}: ${e.message}`);
                failed++;
            }
            
            processed++;
            
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        progressBar.style.width = '100%';
        progressText.textContent = `Готово! Успешно: ${successful}, Ошибок: ${failed}`;
        
        renderOrderItems();
        updateStatus();
        
        log(`\n📊 Итого обработано ${processed} GTIN:`);
        log(`   ✅ Успешно добавлено: ${successful}`);
        log(`   ❌ Ошибок: ${failed}`);

        setTimeout(() => {
            progressBlock.style.display = 'none';
        }, 3000);

    } catch (e) {
        log('❌ Ошибка обработки файла: ' + e.message);
        progressText.textContent = 'Ошибка: ' + e.message;
        progressBar.style.width = '100%';
        progressBar.style.background = '#c53030';
        
        // Даем пользователю больше времени прочитать ошибку
        setTimeout(() => {
            progressBlock.style.display = 'none';
            progressBar.style.background = '#667eea'; // Возвращаем цвет
        }, 10000);
    }

    event.target.value = '';
};

$('addCardBtn').onclick = () => {
    if (!state.card) {
        log('❌ Сначала найдите карточку');
        return;
    }

    const quantityInput = $('cardQuantity');
    let quantity = parseInt(quantityInput ? quantityInput.value : '0', 10);
    if (!Number.isFinite(quantity) || quantity <= 0) {
        log('❌ Количество должно быть положительным числом');
        if (quantityInput) {
            quantityInput.focus();
        }
        return;
    }

    const gtin = normalizeGtin(state.card.gtin);
    if (!gtin) {
        log('❌ У карточки отсутствует корректный GTIN для заказа');
        return;
    }

    const productGroupSelect = $('productGroup');
    const selectedGroup = productGroupSelect ? productGroupSelect.value : '';
    const cardGroup = state.card.productGroup || '';

    if (selectedGroup && cardGroup && selectedGroup !== cardGroup) {
        log('❌ Товарная группа карточки не совпадает с выбранной в заказе');
        return;
    }

    const groupToUse = selectedGroup || cardGroup || '';

    if (!selectedGroup && productGroupSelect && groupToUse) {
        productGroupSelect.value = groupToUse;
        updateClothingVisibility();
    }

    const existing = state.orderItems.find(item => item.gtin === gtin);
    if (existing) {
        const baseQuantity = parseInt(existing.quantity, 10) || 0;
        existing.quantity = baseQuantity + quantity;
        existing.name = state.card.name || existing.name;
        existing.templateId = state.card.templateId || existing.templateId;
        existing.productGroup = groupToUse || existing.productGroup;
        existing.goodId = state.card.goodId || existing.goodId;
        log(`➕ Количество для GTIN ${gtin} увеличено до ${existing.quantity}`);
    } else {
        state.orderItems.push({
            gtin,
            quantity,
            name: state.card.name || 'Без названия',
            templateId: state.card.templateId || 10,
            productGroup: groupToUse,
            goodId: state.card.goodId || ''
        });
        log(`➕ Карточка с GTIN ${gtin} добавлена в заказ (количество ${quantity})`);
    }

    if (quantityInput) {
        quantityInput.value = '1';
        quantityInput.focus();
    }

    renderOrderItems();
    updateStatus();
};

$('createOrderBtn').onclick = async () => {
    if (!state.currentCert) {
        log('❌ Выберите сертификат');
        return;
    }

    if (!state.orderItems.length) {
        log('❌ Добавьте хотя бы одну карточку в заказ');
        return;
    }

    const productGroupSelect = $('productGroup');
    let productGroup = productGroupSelect ? productGroupSelect.value : '';
    if (!productGroup) {
        const firstWithGroup = state.orderItems.find(item => item.productGroup);
        if (firstWithGroup) {
            productGroup = firstWithGroup.productGroup;
            if (productGroupSelect) {
                productGroupSelect.value = productGroup;
                updateClothingVisibility();
            }
        }
    }

    if (!productGroup) {
        log('❌ Укажите товарную группу');
        return;
    }

    const inconsistentItem = state.orderItems.find(item => item.productGroup && item.productGroup !== productGroup);
    if (inconsistentItem) {
        log(`❌ Карточка с GTIN ${inconsistentItem.gtin} относится к другой товарной группе`);
        return;
    }

    const releaseMethodSelect = $('releaseMethod');
    const releaseMethod = releaseMethodSelect ? releaseMethodSelect.value : '';

    if (!releaseMethod) {
        log('❌ Укажите способ выпуска');
        return;
    }

    const invalidQuantityItem = state.orderItems.find(item => {
        const value = parseInt(item.quantity, 10);
        return !Number.isFinite(value) || value <= 0;
    });
    if (invalidQuantityItem) {
        log(`❌ Укажите корректное количество для GTIN ${invalidQuantityItem.gtin}`);
        return;
    }

    const technicalGtinItem = state.orderItems.find(item => {
        const gtin = String(item.gtin);
        return gtin.startsWith('029') && gtin.length === 14;
    });
    
    if (technicalGtinItem) {
        log(`⚠️ Обнаружен технический GTIN ${technicalGtinItem.gtin}`);
        log(`⚠️ Технические GTIN (диапазон 029...) больше не принимаются для товарной группы "${productGroup}"`);
        log(`💡 Удалите этот GTIN из заказа и используйте настоящий GTIN товара`);
        return;
    }

    try {
        const products = state.orderItems.map(item => ({
            gtin: item.gtin,
            quantity: parseInt(item.quantity, 10),
            serialNumberType: "OPERATOR",
            cisType: "UNIT",
            templateId: item.templateId || 10
        }));

        const totalQuantity = products.reduce((sum, item) => sum + (Number.isFinite(item.quantity) ? item.quantity : 0), 0);

        const order = {
            productGroup,
            products,
            attributes: {
                releaseMethodType: releaseMethod,
                createMethodType: "SELF_MADE"
            }
        };

        if (productGroup === 'lp') {
            const paymentTypeInput = $('lpPaymentType');
            const paymentTypeValue = paymentTypeInput ? parseInt(paymentTypeInput.value, 10) : 2;
            const paymentType = Number.isFinite(paymentTypeValue) ? paymentTypeValue : 2;

            order.attributes.freeCode = $('lpFreeCode').checked;
            order.attributes.paymentType = paymentType;
        }

        const payload = JSON.stringify(order);

        log(`📦 Подготовка заказа:`);
        log(`   Товарная группа: ${productGroup}`);
        log(`   Способ выпуска: ${releaseMethod}`);
        log(`   Карточек: ${products.length}`);
        log(`   Всего КМ: ${totalQuantity}`);
        
        products.forEach((p, i) => {
            log(`   ${i + 1}. GTIN: ${p.gtin}, количество: ${p.quantity}, template: ${p.templateId}`);
        });

        console.log('=== ORDER PAYLOAD ===');
        console.log('Length:', payload.length);
        console.log('Content:', payload);

        log('✍️ Подпись заказа...');
        const rawSignature = await signDetached(payload, state.currentCert);
        
        console.log('=== SIGNATURE ===');
        console.log('Raw length:', rawSignature.length);
        
        const signature = rawSignature.replace(/[\r\n\s]/g, '');
        
        console.log('Cleaned length:', signature.length);
        log('🔑 Длина подписи: ' + signature.length + ' символов');
        
        log('📤 Отправка в СУЗ...');
        const result = await req('order.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload, signature})
        });

        log('✅ Заказ создан! Ответ СУЗ:');
        log(JSON.stringify(result.response, null, 2));

        const createdOrder = result.response || {};
        const orderId = createdOrder.orderId || createdOrder.id || createdOrder.uuid || createdOrder.order_id || '';
        if (orderId) {
            state.lastOrderId = orderId;
            const orderInput = $('orderIdInput');
            if (orderInput) orderInput.value = orderId;
            log('🆔 ID заказа: ' + orderId);
        }

        clearErrorState();
        
        state.buffers = [];
        updateBufferOptions();
        updateStatus();
    } catch (e) {
        console.error('Full error:', e);
        
        let errorMsg = e.message;
        
        try {
            const errorMatch = errorMsg.match(/HTTP \d+: (.+)/);
            if (errorMatch) {
                const errorJson = JSON.parse(errorMatch[1]);
                if (errorJson.globalErrors && Array.isArray(errorJson.globalErrors)) {
                    log('❌ Ошибки валидации:');
                    errorJson.globalErrors.forEach(err => {
                        log(`   • [${err.errorCode}] ${err.error}`);
                    });
                    
                    const techGtinError = errorJson.globalErrors.find(err => 
                        err.error && err.error.includes('технического диапазона')
                    );
                    
                    if (techGtinError) {
                        log('\n💡 Рекомендация: Проверьте список карточек в заказе.');
                        log('   Удалите все карточки с техническими GTIN (начинаются с 029).');
                        log('   Используйте только настоящие GTIN товаров.');
                    }
                } else {
                    log('❌ ' + errorMsg);
                }
            } else {
                log('❌ ' + errorMsg);
            }
        } catch (parseError) {
            log('❌ ' + errorMsg);
        }
        
        clearErrorState();
    }
};

function extractOrderInfos(payload) {
    if (!payload) return [];
    if (Array.isArray(payload)) return payload;
    if (Array.isArray(payload.orderInfos)) return payload.orderInfos;
    if (Array.isArray(payload.orders)) return payload.orders;
    return [];
}

function applyOrderInfo(orderPayload, fallbackId) {
    const infos = extractOrderInfos(orderPayload);
    const buffers = [];
    infos.forEach(info => {
        const orderId = info.orderId || info.id || info.uuid || fallbackId || '';
        if (!state.lastOrderId && orderId) {
            state.lastOrderId = orderId;
            const orderInput = $('orderIdInput');
            if (orderInput) orderInput.value = orderId;
        }

        (info.buffers || []).forEach(buffer => {
            buffers.push({
                ...buffer,
                orderId,
                bufferId: buffer.bufferId || buffer.id || buffer.buffer_id || buffer.uuid || '',
            });
        });
    });

    state.buffers = buffers;
    updateBufferOptions();

    const gtinInput = $('codeGtin');
    if (gtinInput && !gtinInput.value) {
        const bufferWithGtin = buffers.find(buffer => buffer.gtin);
        if (bufferWithGtin && bufferWithGtin.gtin) {
            let normalized = String(bufferWithGtin.gtin).replace(/\s+/g, '');
            if (/^\d+$/.test(normalized)) {
                if (normalized.length < 14) {
                    normalized = normalized.padStart(14, '0');
                }
                if (normalized.length === 14) {
                    gtinInput.value = normalized;
                }
            }
        }
    }
    updateStatus();
}

$('statusBtn').onclick = async () => {
    const orderInput = $('orderIdInput');
    const orderId = (orderInput ? orderInput.value.trim() : '') || state.lastOrderId;

    if (!orderId) {
        log('❌ Укажите ID заказа');
        return;
    }

    try {
        log('🔄 Запрос статуса заказа...');
        const data = await req('order_status.php?orderId=' + encodeURIComponent(orderId));
        const ordersPayload = data.orders || {};
        const output = $('statusOutput');
        if (output) output.textContent = JSON.stringify(ordersPayload, null, 2);

        state.lastOrderId = orderId;
        applyOrderInfo(ordersPayload, orderId);
        log('✅ Статус заказа обновлён');
    } catch (e) {
        log('❌ ' + e.message);
    }
};

$('listOrdersBtn').onclick = async () => {
    try {
        log('📋 Запрос списка заказов...');
        const data = await req('order_status.php?limit=5');
        const ordersPayload = data.orders || {};
        const output = $('statusOutput');
        if (output) output.textContent = JSON.stringify(ordersPayload, null, 2);

        const infos = extractOrderInfos(ordersPayload);
        if (infos.length) {
            const firstId = infos[0].orderId || infos[0].id || infos[0].uuid || '';
            if (firstId) {
                state.lastOrderId = firstId;
                const orderInput = $('orderIdInput');
                if (orderInput) orderInput.value = firstId;
            }
        }

        applyOrderInfo(ordersPayload);
        log('✅ Получены последние заказы');
    } catch (e) {
        log('❌ ' + e.message);
    }
};

$('downloadCodesBtn').onclick = async () => {
    const orderInput = $('orderIdInput');
    const orderId = (orderInput ? orderInput.value.trim() : '') || state.lastOrderId;

    if (!orderId) {
        log('❌ Укажите ID заказа');
        return;
    }

    const bufferSelect = $('bufferSelect');
    let effectiveOrderId = orderId;
    if (bufferSelect && bufferSelect.value !== '') {
        const option = bufferSelect.options[bufferSelect.selectedIndex];
        if (option && option.dataset.orderId) {
            effectiveOrderId = option.dataset.orderId;
        }
    }

    const formatSelect = $('codeFormat');
    const format = formatSelect ? formatSelect.value : 'CSV';

    const quantityInput = $('codeQuantity');
    let quantity = parseInt(quantityInput ? quantityInput.value : '1000', 10);
    if (!Number.isFinite(quantity) || quantity <= 0) {
        log('❌ Количество КМ должно быть положительным числом');
        return;
    }
    if (quantity > 150000) {
        quantity = 150000;
        if (quantityInput) {
            quantityInput.value = '150000';
        }
        log('ℹ️ Количество ограничено значением 150 000 КМ');
    }

    const gtinInput = $('codeGtin');
    let gtin = gtinInput ? gtinInput.value.trim() : '';
    if (!gtin) {
        if (state.orderItems.length) {
            gtin = String(state.orderItems[0].gtin || '');
        } else if (state.card && state.card.gtin) {
            gtin = String(state.card.gtin);
        }
    }
    gtin = gtin.replace(/\s+/g, '');

    if (!gtin) {
        log('❌ Укажите GTIN товара');
        return;
    }

    if (!/^\d+$/.test(gtin)) {
        log('❌ GTIN должен состоять только из цифр');
        return;
    }

    if (gtin.length < 14) {
        gtin = gtin.padStart(14, '0');
    }

    if (gtin.length !== 14) {
        log('❌ GTIN должен содержать 14 цифр');
        return;
    }

    if (gtinInput) {
        gtinInput.value = gtin;
    }

    try {
        log('📦 Запрос кодов маркировки...');
        const params = new URLSearchParams({
            orderId: effectiveOrderId,
            gtin,
            quantity: String(quantity),
        });

        const result = await req('codes.php?' + params.toString());
        const payload = result.data || {};

        const codes = Array.isArray(payload.codes) ? payload.codes : [];
        if (!codes.length) {
            throw new Error('Сервис вернул пустой массив КМ');
        }

        if (state.downloadUrl) {
            URL.revokeObjectURL(state.downloadUrl);
        }

        let blobContent = '';
        let contentType = 'text/plain';
        let ext = 'txt';

        if ((format || '').toUpperCase() === 'JSON') {
            blobContent = JSON.stringify(codes, null, 2);
            contentType = 'application/json';
            ext = 'json';
        } else {
            blobContent = codes.join('\n');
            contentType = 'text/csv';
            ext = 'csv';
        }

        const blob = new Blob([blobContent], {type: contentType});
        const url = URL.createObjectURL(blob);
        state.downloadUrl = url;

        const link = $('downloadLink');
        if (link) {
            link.href = url;
            const blockSuffix = payload.blockId ? `_block_${payload.blockId}` : '';
            link.download = `codes_${orderId}${blockSuffix}.${ext}`;
            link.style.display = 'inline-block';
            link.textContent = 'Скачать файл';
        }

        const received = typeof payload.receivedQuantity === 'number' ? payload.receivedQuantity : codes.length;
        const infoParts = [`${received} КМ`];
        if (payload.blockId) {
            infoParts.push(`blockId ${payload.blockId}`);
        }

        log('✅ Получено ' + infoParts.join(', '));
    } catch (e) {
        log('❌ ' + e.message);
    }
};

$('sendUtilisationBtn').onclick = async () => {
    if (!state.currentCert) {
        log('❌ Выберите сертификат');
        return;
    }

    const textarea = $('utilisationPayload');
    if (!textarea || !textarea.value.trim()) {
        log('❌ Заполните тело отчёта о нанесении');
        return;
    }

    try {
        const parsed = JSON.parse(textarea.value);
        const payload = JSON.stringify(parsed);

        log('✍️ Подпись отчёта...');
        const signature = await signDetached(payload, state.currentCert);

        log('📤 Отправка отчёта...');
        const result = await req('utilisation.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload, signature})
        });

        log('✅ Отчёт принят:');
        log(JSON.stringify(result.response, null, 2));
    } catch (e) {
        if (e instanceof SyntaxError) {
            log('❌ Некорректный JSON отчёта: ' + e.message);
        } else {
            log('❌ ' + e.message);
        }
    }
};

(async () => {
    try {
        const status = await req('auth.php?action=status');
        state.nkActive = status.nk.active;
        state.suzActive = status.suz.active;

        const oms = status.oms || {};

        if (oms.connection && oms.id) {
            state.omsConnection = oms.connection;
            state.omsId = oms.id;
            state.omsSaved = true;
            applyOmsInputs(oms.connection, oms.id);
            persistOmsSettings(oms.connection, oms.id);
        } else {
            state.omsSaved = false;
            if (state.omsConnection || state.omsId) {
                applyOmsInputs(state.omsConnection, state.omsId);
            }
        }

        updateStatus();
        if (state.nkActive || state.suzActive || state.omsSaved) {
            log('ℹ️ Данные восстановлены из сессии');
        } else if (state.omsConnection && state.omsId) {
            await autoRestoreOmsSettingsFromStorage();
        }
    } catch (e) {
        console.error(e);
    }
})();

window.addEventListener('beforeunload', () => {
    if (state.downloadUrl) {
        URL.revokeObjectURL(state.downloadUrl);
    }
});

window.addEventListener('load', async () => {
    const certCount = await loadCertificates(true);
    if (certCount > 0) {
        await authorizeNk({auto: true});
    }
});
</script>

</body>
</html>