<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ó–∞–∫–∞–∑ –ö–ú</title>
    <script src="cadesplugin_api.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        h1 {
            font-size: 2rem;
            color: #1a202c;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .connection-toolbar {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: flex-start;
            flex-wrap: wrap;
            margin-bottom: 0;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .connection-status .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem;
            height: 1.8rem;
            border-radius: 999px;
            border: 2px solid currentColor;
            font-size: 1rem;
        }

        .connection-status.connected {
            color: #2f855a;
        }

        .connection-status.disconnected {
            color: #c53030;
        }
        
        .step {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .step h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #2d3748;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .status.inactive {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status.active {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        input[type="checkbox"] {
            width: auto;
            height: auto;
            margin: 0;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn-secondary {
            background: #edf2f7;
            color: #2d3748;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #e2e8f0;
        }
        
        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .card-info {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .card-info h3 {
            margin-bottom: 0.5rem;
            color: #2d3748;
        }

        .card-info .pill {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
        }

        .card-actions {
            margin-top: 1rem;
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .card-actions .form-group {
            margin-bottom: 0;
            min-width: 160px;
        }

        #cardQuantity {
            max-width: 160px;
        }

        .order-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .order-item {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: space-between;
            align-items: flex-start;
            background: #ffffff;
        }

        .order-item-info {
            flex: 1 1 220px;
        }

        .order-item-title {
            font-weight: 600;
            margin-bottom: 0.35rem;
            color: #2d3748;
        }

        .order-item-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .order-item-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .order-item-quantity-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 120px;
        }

        .order-item-quantity-wrapper label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #4a5568;
        }

        .order-item-quantity {
            width: 120px;
        }

        .order-item-remove {
            white-space: nowrap;
        }

        .order-items-summary {
            margin-top: 0.5rem;
            display: none;
            justify-content: flex-end;
            font-weight: 600;
            color: #2d3748;
        }

        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .mini-log {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-x: auto;
            min-height: 160px;
        }

        .hint {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-top: 0.25rem;
        }

        body.modal-open {
            overflow: hidden;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 1000;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: #ffffff;
            border-radius: 16px;
            width: 100%;
            max-width: 520px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.45);
            transform: translateY(20px);
            transition: transform 0.2s ease;
        }

        .modal-backdrop.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin-bottom: 0;
            font-size: 1.4rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #4a5568;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .modal-section h3 {
            font-size: 1rem;
            color: #2d3748;
        }

        .modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .grid.grid-small {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        label.checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 0;
            color: #4a5568;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="page-header">
        <h1>üéØ –ó–∞–∫–∞–∑ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏</h1>
        <div class="connection-toolbar">
            <button class="btn btn-primary" id="openSettingsBtn" type="button">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
            <div class="connection-status disconnected" id="connectionStatus">
                <span class="status-icon" id="connectionStatusIcon">‚úñ</span>
                <span id="connectionStatusText">–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>
            </div>
        </div>
    </div>
    <p class="subtitle">–ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ –°–£–ó —á–µ—Ä–µ–∑ True API</p>
    <p class="hint" style="margin-bottom: 1.5rem;">
        –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏, –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ OMS –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É
        ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è¬ª.
    </p>

    <!-- –®–∞–≥ 1: –ö–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="step">
        <h2>–®–∞–≥ 1: –ù–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞</h2>

        <div class="form-group">
            <label>GTIN —Ç–æ–≤–∞—Ä–∞</label>
            <input type="text" id="gtinInput" placeholder="04601234567890">
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" id="findCardBtn">–ù–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É</button>
            <label class="btn btn-secondary" style="cursor: pointer; margin: 0;">
                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel —Å GTIN
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
            </label>
        </div>

        <div class="card-info" id="excelProgress" style="display: none; margin-top: 1rem;">
            <h3>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞</h3>
            <div style="margin-top: 0.5rem;">
                <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="excelProgressBar" style="background: #667eea; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="excelProgressText" style="margin-top: 0.5rem; color: #4a5568; font-size: 0.9rem;"></p>
            </div>
        </div>
        
        <div class="card-info" id="cardInfo" style="display: none;">
            <h3 id="cardName"></h3>
            <div id="cardPills"></div>
            <p id="cardDetails" style="margin-top: 0.5rem; color: #718096;"></p>
            <div class="card-actions">
                <div class="form-group">
                    <label for="cardQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ú –¥–ª—è –∑–∞–∫–∞–∑–∞</label>
                    <input type="number" id="cardQuantity" value="1" min="1">
                </div>
                <button class="btn btn-secondary" id="addCardBtn" type="button">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>

    <!-- –®–∞–≥ 2: –ó–∞–∫–∞–∑ -->
    <div class="step">
        <h2>–®–∞–≥ 2: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–∫–∞–∑–∞</h2>

        <div class="form-group">
            <label>–ö–∞—Ä—Ç–æ—á–∫–∏ –≤ –∑–∞–∫–∞–∑–µ</label>
            <p class="hint" id="orderItemsEmpty">–î–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –®–∞–≥–µ 1 –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞.</p>
            <div class="order-items" id="orderItemsList"></div>
            <div class="order-items-summary" id="orderItemsSummary">
                <span id="orderItemsTotal">–í—Å–µ–≥–æ –ö–ú: 0</span>
            </div>
        </div>

        <div class="grid">
            <div class="form-group">
                <label>–¢–æ–≤–∞—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞</label>
                <select id="productGroup">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    <option value="lp">–õ–µ–≥–∫–∞—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å</option>
                    <option value="shoes">–û–±—É–≤—å</option>
                    <option value="tobacco">–¢–∞–±–∞–∫</option>
                    <option value="pharma">–õ–µ–∫–∞—Ä—Å—Ç–≤–∞</option>
                </select>
            </div>

            <div class="form-group">
                <label>–°–ø–æ—Å–æ–± –≤—ã–ø—É—Å–∫–∞</label>
                <select id="releaseMethod">
                    <option value="PRODUCTION">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ –≤ –†–§</option>
                    <option value="IMPORT">–ò–º–ø–æ—Ä—Ç</option>
                    <option value="REMAINS">–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤</option>
                </select>
            </div>
        </div>

        <div class="form-group" id="lpAttributes" style="display: none;">
            <label>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø–ª–∞—Ç—ã –¥–ª—è –æ–¥–µ–∂–¥—ã</label>
            <div class="grid grid-small">
                <label class="checkbox">
                    <input type="checkbox" id="lpFreeCode">
                    –ö–ú –Ω–µ –ø–æ–¥–ª–µ–∂–∏—Ç –æ–ø–ª–∞—Ç–µ (freeCode)
                </label>
                <div>
                    <label for="lpPaymentType">–¢–∏–ø –æ–ø–ª–∞—Ç—ã</label>
                    <select id="lpPaymentType">
                        <option value="1">–û–ø–ª–∞—Ç–∞ –ø–æ —ç–º–∏—Å—Å–∏–∏</option>
                        <option value="2" selected>–û–ø–ª–∞—Ç–∞ –ø–æ –Ω–∞–Ω–µ—Å–µ–Ω–∏—é</option>
                    </select>
                    <p class="hint">–ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ç–æ–≤–∞—Ä–Ω–æ–π –≥—Ä—É–ø–ø—ã –æ–¥–µ–∂–¥—ã.</p>
                </div>
            </div>
        </div>

        <button class="btn btn-primary" id="createOrderBtn" disabled>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <!-- –®–∞–≥ 3: –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ -->
    <div class="step">
        <h2>–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h2>

        <div class="form-group">
            <label>ID –∑–∞–∫–∞–∑–∞</label>
            <input type="text" id="orderIdInput" placeholder="UUID –∑–∞–∫–∞–∑–∞">
            <p class="hint">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" id="statusBtn" disabled>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            <button class="btn btn-secondary" id="listOrdersBtn" disabled>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</button>
        </div>

        <div class="card-info" style="margin-top: 1rem;">
            <h3>–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤</h3>
            <pre class="mini-log" id="statusOutput">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞.</pre>
        </div>
    </div>

    <!-- –®–∞–≥ 4: –ü–æ–ª—É—á–∏—Ç—å –ö–ú -->
    <div class="step">
        <h2>–®–∞–≥ 4: –ü–æ–ª—É—á–∏—Ç—å –º–∞—Å—Å–∏–≤—ã –ö–ú</h2>

        <div class="form-group">
            <label>–ë—É—Ñ–µ—Ä</label>
            <select id="bufferSelect" disabled>
                <option>–ë—É—Ñ–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>
            </select>
            <p class="hint">–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–∞.</p>
        </div>

        <div class="grid">
            <div class="form-group">
                <label>GTIN –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ö–ú</label>
                <input type="text" id="codeGtin" placeholder="04601234567890" maxlength="14">
                <p class="hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GTIN –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞. –§–æ—Ä–º–∞—Ç ‚Äî 14 —Ü–∏—Ñ—Ä.</p>
            </div>

            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ú –∑–∞ –∑–∞–ø—Ä–æ—Å</label>
                <input type="number" id="codeQuantity" value="1000" min="1" max="150000">
                <p class="hint">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 150 000 –ö–ú.</p>
            </div>

            <div class="form-group">
                <label>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞</label>
                <select id="codeFormat">
                    <option value="CSV">CSV</option>
                    <option value="JSON">JSON</option>
                </select>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" id="downloadCodesBtn" disabled>–°–∫–∞—á–∞—Ç—å –ö–ú</button>
            <a class="btn btn-secondary" id="downloadLink" style="display: none;" download>–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>
        </div>
    </div>

    <!-- –®–∞–≥ 5: –í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç -->
    <div class="step">
        <h2>–®–∞–≥ 5: –û—Ç—á—ë—Ç –æ –Ω–∞–Ω–µ—Å–µ–Ω–∏–∏ (–≤–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç)</h2>
        <p class="hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–Ω—ã–µ –ö–ú (sntins) –∏–∑ –±—É—Ñ–µ—Ä–∞. –ú–∞–∫—Å–∏–º—É–º 30 000 –ö–ú –∑–∞ –∑–∞–ø—Ä–æ—Å.</p>

        <textarea id="utilisationPayload">{
  "productGroup": "",
  "utilisationType": "UTILISATION",
  "sntins": [
    ""
  ],
  "attributes": {}
}</textarea>

        <div class="btn-group" style="margin-top: 1rem;">
            <button class="btn btn-primary" id="sendUtilisationBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
        </div>
    </div>

    <!-- –õ–æ–≥ -->
    <div class="log" id="log">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</div>
</div>

<div class="modal-backdrop" id="settingsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal-header">
            <h2 id="settingsTitle">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OMS</h2>
            <button class="modal-close" id="closeSettingsBtn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <h3>–°—Ç–∞—Ç—É—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                <div class="status inactive" id="nkStatus">
                    <span>üî¥</span>
                    <span>–¢–æ–∫–µ–Ω –ù–ö: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>
                </div>
                <div class="status inactive" id="suzStatus">
                    <span>üî¥</span>
                    <span>–¢–æ–∫–µ–Ω –°–£–ó: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>
                </div>
                <div class="status inactive" id="omsStatus">
                    <span>üî¥</span>
                    <span>OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</span>
                </div>
            </div>

            <div class="modal-section">
                <h3>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ —Ç–æ–∫–µ–Ω—ã</h3>
                <div class="form-group">
                    <label for="certSelect">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –£–ö–≠–ü</label>
                    <select id="certSelect" disabled>
                        <option>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã...</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="loadCertsBtn" type="button">–û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</button>
                    <button class="btn btn-primary" id="authNkBtn" type="button" disabled>–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –ù–ö</button>
                    <button class="btn btn-primary" id="authSuzBtn" type="button" disabled>–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –°–£–ó</button>
                </div>
            </div>

            <div class="modal-section">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ OMS</h3>
                <div class="form-group">
                    <label for="omsConnection">–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</label>
                    <input type="text" id="omsConnection" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
                    <p class="hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GUID –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –û–ú–°.</p>
                </div>
                <div class="form-group">
                    <label for="omsId">OMS ID (UUID –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)</label>
                    <input type="text" id="omsId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancelSettingsBtn" type="button">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="saveOmsBtn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
const state = {
    certs: [],
    currentCert: null,
    card: null,
    orderItems: [],
    nkActive: false,
    suzActive: false,
    omsSaved: false,
    omsConnection: '',
    omsId: '',
    lastOrderId: '',
    buffers: [],
    downloadUrl: null
};

const $ = id => document.getElementById(id);

const STORAGE_KEYS = {
    omsConnection: 'ms_chz_oms_connection',
    omsId: 'ms_chz_oms_id'
};

function loadStoredOmsSettings() {
    try {
        return {
            connection: localStorage.getItem(STORAGE_KEYS.omsConnection) || '',
            id: localStorage.getItem(STORAGE_KEYS.omsId) || ''
        };
    } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å OMS –∏–∑ localStorage', e);
        return {connection: '', id: ''};
    }
}

function persistOmsSettings(connection, id) {
    try {
        if (connection) {
            localStorage.setItem(STORAGE_KEYS.omsConnection, connection);
        } else {
            localStorage.removeItem(STORAGE_KEYS.omsConnection);
        }

        if (id) {
            localStorage.setItem(STORAGE_KEYS.omsId, id);
        } else {
            localStorage.removeItem(STORAGE_KEYS.omsId);
        }
    } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å OMS –≤ localStorage', e);
    }
}

function applyOmsInputs(connection, id) {
    const connectionInput = $('omsConnection');
    if (connectionInput) {
        connectionInput.value = connection || '';
    }

    const idInput = $('omsId');
    if (idInput) {
        idInput.value = id || '';
    }
}

const storedOms = loadStoredOmsSettings();
if (storedOms.connection || storedOms.id) {
    state.omsConnection = storedOms.connection || state.omsConnection;
    state.omsId = storedOms.id || state.omsId;
    applyOmsInputs(state.omsConnection, state.omsId);
}

let nkAuthInProgress = false;
let suzAuthInProgress = false;
let omsRestoreInProgress = false;

function log(msg) {
    $('log').textContent += '\n' + msg;
    $('log').scrollTop = $('log').scrollHeight;
    console.log('[MS_CHZ]', msg);
}

function clearErrorState() {
    console.log('[MS_CHZ] Clearing error state');
}

function normalizeGtin(rawGtin) {
    if (!rawGtin && rawGtin !== 0) return '';
    const digits = String(rawGtin).replace(/\D+/g, '');
    if (!digits) return '';
    if (digits.length < 14) {
        return digits.padStart(14, '0');
    }
    if (digits.length === 14) {
        return digits;
    }
    return '';
}

function updateOrderItemsSummary() {
    const summary = $('orderItemsSummary');
    const totalEl = $('orderItemsTotal');
    if (!summary || !totalEl) return;

    const total = (state.orderItems || []).reduce((acc, item) => {
        const value = parseInt(item.quantity, 10);
        return acc + (Number.isFinite(value) ? value : 0);
    }, 0);

    totalEl.textContent = '–í—Å–µ–≥–æ –ö–ú: ' + total;
    summary.style.display = state.orderItems.length ? 'flex' : 'none';
}

function renderOrderItems() {
    const list = $('orderItemsList');
    const emptyHint = $('orderItemsEmpty');
    if (!list || !emptyHint) return;

    list.innerHTML = '';

    if (!state.orderItems.length) {
        emptyHint.style.display = 'block';
        updateOrderItemsSummary();
        return;
    }

    emptyHint.style.display = 'none';

    state.orderItems.forEach((item, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'order-item';

        const info = document.createElement('div');
        info.className = 'order-item-info';

        const title = document.createElement('div');
        title.className = 'order-item-title';
        title.textContent = item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        info.appendChild(title);

        const pills = document.createElement('div');
        pills.className = 'order-item-pills';

        const gtinPill = document.createElement('span');
        gtinPill.className = 'pill';
        gtinPill.textContent = 'GTIN: ' + item.gtin;
        pills.appendChild(gtinPill);

        if (item.goodId) {
            const goodPill = document.createElement('span');
            goodPill.className = 'pill';
            goodPill.textContent = 'ID: ' + item.goodId;
            pills.appendChild(goodPill);
        }

        if (item.templateId) {
            const templatePill = document.createElement('span');
            templatePill.className = 'pill';
            templatePill.textContent = 'template ' + item.templateId;
            pills.appendChild(templatePill);
        }

        if (item.productGroup) {
            const groupPill = document.createElement('span');
            groupPill.className = 'pill';
            groupPill.textContent = '–≥—Ä—É–ø–ø–∞ ' + item.productGroup;
            pills.appendChild(groupPill);
        }

        info.appendChild(pills);
        wrapper.appendChild(info);

        const controls = document.createElement('div');
        controls.className = 'order-item-controls';

        const quantityWrapper = document.createElement('div');
        quantityWrapper.className = 'order-item-quantity-wrapper';

        const quantityId = `orderItemQuantity${index}`;
        const quantityLabel = document.createElement('label');
        quantityLabel.className = 'order-item-quantity-label';
        quantityLabel.setAttribute('for', quantityId);
        quantityLabel.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ';

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.min = '1';
        quantityInput.id = quantityId;
        quantityInput.value = String(item.quantity || 1);
        quantityInput.className = 'order-item-quantity';
        quantityInput.addEventListener('input', () => {
            const value = parseInt(quantityInput.value, 10);
            if (!Number.isFinite(value) || value <= 0) {
                state.orderItems[index].quantity = 0;
            } else {
                state.orderItems[index].quantity = value;
            }
            updateOrderItemsSummary();
            updateStatus();
        });
        quantityInput.addEventListener('blur', () => {
            let value = parseInt(quantityInput.value, 10);
            if (!Number.isFinite(value) || value <= 0) {
                value = 1;
            }
            quantityInput.value = String(value);
            state.orderItems[index].quantity = value;
            updateOrderItemsSummary();
            updateStatus();
        });

        quantityWrapper.appendChild(quantityLabel);
        quantityWrapper.appendChild(quantityInput);
        controls.appendChild(quantityWrapper);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-secondary order-item-remove';
        removeBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
        removeBtn.addEventListener('click', () => {
            const removed = state.orderItems.splice(index, 1)[0];
            renderOrderItems();
            updateStatus();
            if (removed) {
                log(`‚ûñ –ö–∞—Ä—Ç–æ—á–∫–∞ ${removed.gtin} —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∑–∞–∫–∞–∑–∞`);
            }
        });
        controls.appendChild(removeBtn);

        wrapper.appendChild(controls);
        list.appendChild(wrapper);
    });

    updateOrderItemsSummary();
}

function updateBufferOptions() {
    const select = $('bufferSelect');
    if (!select) return;

    const previous = select.value;
    select.innerHTML = '';

    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = state.buffers.length ? '–ê–≤—Ç–æ–≤—ã–±–æ—Ä –±—É—Ñ–µ—Ä–∞' : '–ë—É—Ñ–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
    select.appendChild(placeholder);

    state.buffers.forEach((buffer, index) => {
        const option = document.createElement('option');
        option.value = String(index);
        option.dataset.key = buffer.bufferId || buffer.id || buffer.buffer_id || buffer.uuid || '';
        option.dataset.orderId = buffer.orderId || state.lastOrderId;

        const pieces = [];
        if (buffer.gtin) pieces.push(`GTIN ${buffer.gtin}`);
        if (buffer.templateId) pieces.push(`template ${buffer.templateId}`);
        const left = buffer.leftInBuffer ?? buffer.left ?? buffer.totalCodes ?? null;
        if (left !== null) pieces.push(`–¥–æ—Å—Ç—É–ø–Ω–æ ${left}`);

        const label = pieces.length ? pieces.join(' ‚Ä¢ ') : '–±–µ–∑ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π';
        option.textContent = `${option.dataset.key || '–ë—É—Ñ–µ—Ä ' + (index + 1)} ‚Ä¢ ${label}`;
        select.appendChild(option);
    });

    select.disabled = state.buffers.length === 0;

    if (previous && [...select.options].some(opt => opt.value === previous)) {
        select.value = previous;
    } else {
        select.value = '';
    }
}

function updateStatus() {
    const nkStatus = $('nkStatus');
    if (nkStatus) {
        nkStatus.className = 'status ' + (state.nkActive ? 'active' : 'inactive');
        nkStatus.innerHTML = state.nkActive
            ? '<span>‚úÖ</span><span>–¢–æ–∫–µ–Ω –ù–ö: –∞–∫—Ç–∏–≤–µ–Ω</span>'
            : '<span>üî¥</span><span>–¢–æ–∫–µ–Ω –ù–ö: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>';
    }

    const suzStatus = $('suzStatus');
    if (suzStatus) {
        suzStatus.className = 'status ' + (state.suzActive ? 'active' : 'inactive');
        suzStatus.innerHTML = state.suzActive
            ? '<span>‚úÖ</span><span>–¢–æ–∫–µ–Ω –°–£–ó: –∞–∫—Ç–∏–≤–µ–Ω</span>'
            : '<span>üî¥</span><span>–¢–æ–∫–µ–Ω –°–£–ó: –Ω–µ –ø–æ–ª—É—á–µ–Ω</span>';
    }

    const omsStatus = $('omsStatus');
    const shortConnection = state.omsConnection
        ? `${state.omsConnection.slice(0, 8)}‚Ä¶${state.omsConnection.slice(-4)}`
        : '';
    const omsDescription = state.omsSaved
        ? shortConnection
            ? `OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (${shortConnection})`
            : 'OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'
        : 'OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';

    if (omsStatus) {
        omsStatus.className = 'status ' + (state.omsSaved ? 'active' : 'inactive');
        omsStatus.innerHTML = state.omsSaved
            ? `<span>‚úÖ</span><span>${omsDescription}</span>`
            : '<span>üî¥</span><span>OMS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</span>';
    }

    const connectionIndicator = $('connectionStatus');
    const connectionIcon = $('connectionStatusIcon');
    const connectionText = $('connectionStatusText');
    if (connectionIndicator && connectionIcon && connectionText) {
        const connected = state.nkActive && state.suzActive && state.omsSaved;
        connectionIndicator.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
        connectionIcon.textContent = connected ? '‚úî' : '‚úñ';
        connectionText.textContent = connected ? '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ' : '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
    }

    const hasValidItems = Array.isArray(state.orderItems)
        && state.orderItems.some(item => {
            const value = parseInt(item.quantity, 10);
            return Number.isFinite(value) && value > 0;
        });
    const canOrder = state.nkActive && state.suzActive && state.omsSaved && hasValidItems;
    const createBtn = $('createOrderBtn');
    if (createBtn) createBtn.disabled = !canOrder;

    const statusBtn = $('statusBtn');
    if (statusBtn) statusBtn.disabled = !(state.suzActive && state.omsSaved);

    const listOrdersBtn = $('listOrdersBtn');
    if (listOrdersBtn) listOrdersBtn.disabled = !(state.suzActive && state.omsSaved);

    const downloadBtn = $('downloadCodesBtn');
    if (downloadBtn) {
        const orderInput = $('orderIdInput');
        const gtinInput = $('codeGtin');
        const hasOrderId = !!(state.lastOrderId || (orderInput && orderInput.value));
        const hasGtin = !!(gtinInput && gtinInput.value.trim());
        downloadBtn.disabled = !(state.suzActive && state.omsSaved && hasOrderId && hasGtin);
    }

    const utilBtn = $('sendUtilisationBtn');
    if (utilBtn) utilBtn.disabled = !(state.suzActive && state.currentCert && state.omsSaved);

    const authNkBtn = $('authNkBtn');
    if (authNkBtn) authNkBtn.disabled = !state.currentCert;

    const authSuzBtn = $('authSuzBtn');
    if (authSuzBtn) authSuzBtn.disabled = !state.currentCert || !state.omsSaved;

    if (state.lastOrderId) {
        const orderInput = $('orderIdInput');
        if (orderInput && !orderInput.value) {
            orderInput.value = state.lastOrderId;
        }
    }

    updateBufferOptions();
}

function updateClothingVisibility() {
    const block = $('lpAttributes');
    const select = $('productGroup');
    if (!block || !select) return;

    const isClothing = select.value === 'lp';
    block.style.display = isClothing ? 'block' : 'none';
}

['orderIdInput', 'codeGtin'].forEach(id => {
    const element = $(id);
    if (element) {
        element.addEventListener('input', () => updateStatus());
    }
});

const productGroupSelect = $('productGroup');
if (productGroupSelect) {
    productGroupSelect.addEventListener('change', () => {
        updateClothingVisibility();
    });
}

updateClothingVisibility();
renderOrderItems();
updateStatus();

async function req(url, options = {}) {
    const resp = await fetch(url, options);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);
    return data;
}

async function autoRestoreOmsSettingsFromStorage() {
    if (omsRestoreInProgress) return false;

    const stored = loadStoredOmsSettings();
    if (!stored.connection || !stored.id) {
        return false;
    }

    omsRestoreInProgress = true;
    try {
        log('ü§ñ –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ OMS...');
        await req('auth.php?action=save-oms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({omsConnection: stored.connection, omsId: stored.id})
        });

        state.omsSaved = true;
        state.omsConnection = stored.connection;
        state.omsId = stored.id;
        applyOmsInputs(stored.connection, stored.id);
        persistOmsSettings(stored.connection, stored.id);
        updateStatus();
        log('ü§ñ ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OMS –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
        return true;
    } catch (e) {
        log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OMS: ' + e.message);
        return false;
    } finally {
        omsRestoreInProgress = false;
    }
}

function setModalVisibility(visible) {
    const modal = $('settingsModal');
    if (!modal) return;

    if (visible) {
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');

        const connectionInput = $('omsConnection');
        if (connectionInput) {
            connectionInput.value = state.omsConnection || '';
            connectionInput.focus();
            connectionInput.select();
        }

        const idInput = $('omsId');
        if (idInput) {
            idInput.value = state.omsId || '';
        }
    } else {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        const trigger = $('openSettingsBtn');
        if (trigger) {
            trigger.focus();
        }
    }
}

const openSettingsBtn = $('openSettingsBtn');
if (openSettingsBtn) {
    openSettingsBtn.addEventListener('click', () => setModalVisibility(true));
}

['closeSettingsBtn', 'cancelSettingsBtn'].forEach(id => {
    const btn = $(id);
    if (btn) {
        btn.addEventListener('click', () => setModalVisibility(false));
    }
});

const settingsBackdrop = $('settingsModal');
if (settingsBackdrop) {
    settingsBackdrop.addEventListener('click', (event) => {
        if (event.target === settingsBackdrop) {
            setModalVisibility(false);
        }
    });
}

document.addEventListener('keydown', (event) => {
    const modal = $('settingsModal');
    if (event.key === 'Escape' && modal && modal.classList.contains('active')) {
        setModalVisibility(false);
    }
});

async function loadCertificates(isAuto = false) {
    try {
        log(isAuto ? 'üîÑ –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...' : 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...');

        await cadesplugin;
        const store = await cadesplugin.CreateObjectAsync('CAdESCOM.Store');
        await store.Open(2, 'My', 2);

        const certs = await store.Certificates;
        const count = await certs.Count;

        const select = $('certSelect');
        state.certs = [];
        state.currentCert = null;
        if (select) {
            select.innerHTML = '';
            select.disabled = true;
        }

        for (let i = 1; i <= count; i++) {
            const cert = await certs.Item(i);
            const validTo = new Date(await cert.ValidToDate);
            if (validTo < new Date()) continue;

            state.certs.push(cert);
            const option = document.createElement('option');
            option.value = state.certs.length - 1;
            option.textContent = await cert.SubjectName;
            if (select) {
                select.appendChild(option);
            }
        }

        await store.Close();

        if (state.certs.length) {
            if (select) {
                select.disabled = false;
                select.value = '0';
            }
            state.currentCert = state.certs[0];
            $('authNkBtn').disabled = false;
            $('authSuzBtn').disabled = false;
            log(`‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã ${isAuto ? '–∑–∞–≥—Ä—É–∂–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' : '–æ–±–Ω–æ–≤–ª–µ–Ω—ã'}: ` + state.certs.length);
        } else {
            log('‚ùå –î–µ–π—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            $('authNkBtn').disabled = true;
            $('authSuzBtn').disabled = true;
            if (select) {
                const placeholder = document.createElement('option');
                placeholder.textContent = '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                placeholder.disabled = true;
                placeholder.selected = true;
                select.appendChild(placeholder);
            }
        }

        updateStatus();
        return state.certs.length;
    } catch (e) {
        state.certs = [];
        state.currentCert = null;
        updateStatus();
        log(`‚ùå ${isAuto ? '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã' : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤'}: ` + e.message);
        return 0;
    }
}

$('loadCertsBtn').onclick = async () => {
    await loadCertificates(false);
};

$('certSelect').onchange = (e) => {
    state.currentCert = state.certs[e.target.value];
    updateStatus();
};

async function signAttached(data, cert) {
    const signer = await cadesplugin.CreateObjectAsync('CAdESCOM.CPSigner');
    await signer.propset_Certificate(cert);
    
    const sd = await cadesplugin.CreateObjectAsync('CAdESCOM.CadesSignedData');
    
    if (typeof sd.propset_ContentEncoding === 'function') {
        try {
            await sd.propset_ContentEncoding(cadesplugin.CADESCOM_STRING_TO_UCS2LE);
        } catch (e) {
            console.log('ContentEncoding –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }
    }
    
    await sd.propset_Content(data);
    
    return sd.SignCades(signer, cadesplugin.CADESCOM_CADES_BES);
}

function encodeBase64Utf8(data) {
    const utf8 = new TextEncoder().encode(data);
    let binary = '';
    for (const byte of utf8) {
        binary += String.fromCharCode(byte);
    }
    return btoa(binary);
}

async function signDetached(data, cert) {
    const signer = await cadesplugin.CreateObjectAsync('CAdESCOM.CPSigner');
    await signer.propset_Certificate(cert);

    const sd = await cadesplugin.CreateObjectAsync('CAdESCOM.CadesSignedData');

    const base64Payload = encodeBase64Utf8(data);
    if (typeof sd.propset_ContentEncoding === 'function') {
        await sd.propset_ContentEncoding(cadesplugin.CADESCOM_BASE64_TO_BINARY);
    }
    await sd.propset_Content(base64Payload);

    const signature = await sd.SignCades(signer, cadesplugin.CADESCOM_CADES_BES, true);

    return signature.replace(/[\r\n\s]/g, '');
}

async function authorizeNk({auto = false} = {}) {
    if (nkAuthInProgress) return false;

    if (!state.currentCert) {
        if (auto) {
            log('‚ÑπÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –ù–ö');
        } else {
            log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        }
        return false;
    }

    if (auto && state.nkActive) {
        log('‚ÑπÔ∏è –¢–æ–∫–µ–Ω –ù–ö —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è');
        return true;
    }

    nkAuthInProgress = true;
    const prefix = auto ? 'ü§ñ ' : '';

    try {
        log(`${prefix}üîê –ó–∞–ø—Ä–æ—Å challenge –ù–ö...`);
        const challenge = await req('auth.php?action=nk-challenge');

        log(`${prefix}‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å challenge...`);
        const signature = await signAttached(challenge.data, state.currentCert);

        log(`${prefix}üì§ –û–±–º–µ–Ω –Ω–∞ —Ç–æ–∫–µ–Ω...`);
        await req('auth.php?action=nk-signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: challenge.uuid, signature})
        });

        state.nkActive = true;
        updateStatus();
        log(`${prefix}‚úÖ –¢–æ–∫–µ–Ω –ù–ö ${auto ? '–ø–æ–ª—É—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' : '–ø–æ–ª—É—á–µ–Ω'}`);
        return true;
    } catch (e) {
        log(`${auto ? '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –ù–ö: ' : '‚ùå '}` + e.message);
        return false;
    } finally {
        nkAuthInProgress = false;
    }
}

async function authorizeSuz({auto = false} = {}) {
    if (suzAuthInProgress) return false;

    if (!state.currentCert) {
        if (auto) {
            log('‚ÑπÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –°–£–ó');
        } else {
            log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        }
        return false;
    }

    const omsConnection = state.omsConnection || $('omsConnection').value.trim();
    const omsId = state.omsId || $('omsId').value.trim();

    if (!omsConnection || !omsId) {
        if (auto) {
            log('‚ÑπÔ∏è –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –°–£–ó –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OMS');
        } else {
            log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ OMS ID');
            setModalVisibility(true);
        }
        return false;
    }

    suzAuthInProgress = true;
    const prefix = auto ? 'ü§ñ ' : '';

    try {
        log(`${prefix}üîê –ó–∞–ø—Ä–æ—Å challenge –°–£–ó...`);
        const challenge = await req('auth.php?action=suz-challenge');

        log(`${prefix}‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å challenge...`);
        const signature = await signAttached(challenge.data, state.currentCert);

        log(`${prefix}üì§ –û–±–º–µ–Ω –Ω–∞ clientToken...`);
        await req('auth.php?action=suz-signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: challenge.uuid, signature, omsConnection, omsId})
        });

        state.suzActive = true;
        state.omsConnection = omsConnection;
        state.omsId = omsId;
        state.omsSaved = true;
        persistOmsSettings(omsConnection, omsId);
        applyOmsInputs(omsConnection, omsId);
        updateStatus();
        log(`${prefix}‚úÖ –¢–æ–∫–µ–Ω –°–£–ó ${auto ? '–ø–æ–ª—É—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' : '–ø–æ–ª—É—á–µ–Ω'}`);
        return true;
    } catch (e) {
        log(`${auto ? '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –°–£–ó: ' : '‚ùå '}` + e.message);
        return false;
    } finally {
        suzAuthInProgress = false;
    }
}

$('saveOmsBtn').onclick = async () => {
    const omsConnection = $('omsConnection').value.trim();
    const omsId = $('omsId').value.trim();

    if (!omsConnection || !omsId) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ OMS ID');
        return;
    }

    try {
        await req('auth.php?action=save-oms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({omsConnection, omsId})
        });

        state.omsSaved = true;
        state.omsConnection = omsConnection;
        state.omsId = omsId;
        persistOmsSettings(omsConnection, omsId);
        applyOmsInputs(omsConnection, omsId);
        updateStatus();
        log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OMS —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        setModalVisibility(false);

        await authorizeSuz({auto: true});
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('authNkBtn').onclick = async () => {
    await authorizeNk();
};

$('authSuzBtn').onclick = async () => {
    await authorizeSuz();
};

$('findCardBtn').onclick = async () => {
    const gtin = $('gtinInput').value.trim();
    if (!gtin) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ GTIN');
        return;
    }
    
    if (!state.nkActive) {
        log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –ù–ö');
        return;
    }
    
    await findAndDisplayCard(gtin);
};

async function findAndDisplayCard(gtin) {
    try {
        log('üîç –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–∫–∏...');
        const card = await req('card.php?gtin=' + encodeURIComponent(gtin));
        
        state.card = card;
        
        $('cardInfo').style.display = 'block';
        $('cardName').textContent = card.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        
        const pills = [];
        if (card.goodId) pills.push(`<span class="pill">ID: ${card.goodId}</span>`);
        if (card.gtin) pills.push(`<span class="pill">GTIN: ${card.gtin}</span>`);
        $('cardPills').innerHTML = pills.join('');
        
        $('cardDetails').textContent =
            (card.tnved ? `–¢–ù –í–≠–î: ${card.tnved}` : '') +
            (card.productGroup ? ` ‚Ä¢ –ì—Ä—É–ø–ø–∞: ${card.productGroup}` : '');

        const cardQuantityInput = $('cardQuantity');
        if (cardQuantityInput) {
            cardQuantityInput.value = '1';
        }

        if (card.productGroup) {
            $('productGroup').value = card.productGroup;
            updateClothingVisibility();
        }

        const codeGtinInput = $('codeGtin');
        if (codeGtinInput && card.gtin) {
            let normalized = String(card.gtin).replace(/\s+/g, '');
            if (/^\d+$/.test(normalized)) {
                if (normalized.length < 14) {
                    normalized = normalized.padStart(14, '0');
                }
                if (normalized.length === 14) {
                    codeGtinInput.value = normalized;
                } else {
                    codeGtinInput.value = card.gtin;
                }
            } else {
                codeGtinInput.value = card.gtin;
            }
        }

        updateStatus();
        log('‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞');
        return card;
    } catch (e) {
        log('‚ùå ' + e.message);
        state.card = null;
        $('cardInfo').style.display = 'none';
        updateStatus();
        return null;
    }
}



// –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É SheetJS –æ–¥–∏–Ω —Ä–∞–∑
let XLSX = null;
async function loadXLSX() {
    if (XLSX) return XLSX;
    
    return new Promise((resolve, reject) => {
        if (typeof window.XLSX !== 'undefined') {
            XLSX = window.XLSX;
            resolve(XLSX);
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
        script.onload = () => {
            // –î–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
            setTimeout(() => {
                if (typeof window.XLSX !== 'undefined') {
                    XLSX = window.XLSX;
                    console.log('[XLSX] –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                    resolve(XLSX);
                } else {
                    console.error('[XLSX] window.XLSX –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏');
                    reject(new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–æ window.XLSX –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'));
                }
            }, 100);
        };
        script.onerror = () => {
            console.warn('[XLSX] –û—Å–Ω–æ–≤–Ω–æ–π CDN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π');
            // Fallback –Ω–∞ –¥—Ä—É–≥–æ–π CDN
            const scriptFallback = document.createElement('script');
            scriptFallback.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
            scriptFallback.onload = () => {
                setTimeout(() => {
                    if (typeof window.XLSX !== 'undefined') {
                        XLSX = window.XLSX;
                        console.log('[XLSX] –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å –∑–∞–ø–∞—Å–Ω–æ–≥–æ CDN');
                        resolve(XLSX);
                    } else {
                        reject(new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–æ window.XLSX –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'));
                    }
                }, 100);
            };
            scriptFallback.onerror = () => {
                reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.'));
            };
            document.head.appendChild(scriptFallback);
        };
        document.head.appendChild(script);
    });
}

$('excelFileInput').onchange = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    if (!state.nkActive) {
        log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –ù–ö');
        event.target.value = '';
        return;
    }

    const progressBlock = $('excelProgress');
    const progressBar = $('excelProgressBar');
    const progressText = $('excelProgressText');
    
    progressBlock.style.display = 'block';
    progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Excel...';
    progressBar.style.width = '5%';

    try {
        log('üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ Excel —Ñ–∞–π–ª–∞: ' + file.name);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É
        const XLSXLib = await loadXLSX();
        log('‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Excel –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        
        progressText.textContent = '–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞...';
        progressBar.style.width = '10%';

        const arrayBuffer = await file.arrayBuffer();
        
        progressText.textContent = '–ü–∞—Ä—Å–∏–Ω–≥ Excel...';
        progressBar.style.width = '20%';

        // –ü–∞—Ä—Å–∏–º Excel
        const workbook = XLSXLib.read(arrayBuffer);
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSXLib.utils.sheet_to_json(firstSheet, { header: 1 });

        if (!data || data.length === 0) {
            throw new Error('–§–∞–π–ª –ø—É—Å—Ç');
        }

        const headers = data[0];
        const gtinColumnIndex = headers.findIndex(h => 
            String(h).toLowerCase().includes('gtin')
        );

        if (gtinColumnIndex === -1) {
            throw new Error('–ö–æ–ª–æ–Ω–∫–∞ GTIN –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –µ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–¥–µ—Ä–∂–∞—â–∏–π "GTIN"');
        }

        const gtins = [];
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const gtin = row[gtinColumnIndex];
            if (gtin && String(gtin).trim()) {
                gtins.push(String(gtin).trim());
            }
        }

        if (gtins.length === 0) {
            throw new Error('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ GTIN');
        }

        log(`üìä –ù–∞–π–¥–µ–Ω–æ ${gtins.length} GTIN –≤ —Ñ–∞–π–ª–µ`);
        progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ 0/${gtins.length} –∫–∞—Ä—Ç–æ—á–µ–∫...`;
        
        let processed = 0;
        let successful = 0;
        let failed = 0;

        for (const gtin of gtins) {
            try {
                progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ ${processed + 1}/${gtins.length}: ${gtin}`;
                progressBar.style.width = `${20 + (processed / gtins.length) * 70}%`;

                const card = await findAndDisplayCard(gtin);
                
                if (card) {
                    const normalized = normalizeGtin(card.gtin);
                    if (normalized) {
                        const existing = state.orderItems.find(item => item.gtin === normalized);
                        if (existing) {
                            existing.quantity = parseInt(existing.quantity, 10) + 1;
                            log(`‚ûï –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è GTIN ${normalized} —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ ${existing.quantity}`);
                        } else {
                            state.orderItems.push({
                                gtin: normalized,
                                quantity: 1,
                                name: card.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                                templateId: card.templateId || 10,
                                productGroup: card.productGroup || '',
                                goodId: card.goodId || ''
                            });
                            log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ ${normalized}`);
                        }
                        successful++;
                    }
                } else {
                    failed++;
                }
            } catch (e) {
                log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å ${gtin}: ${e.message}`);
                failed++;
            }
            
            processed++;
            
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        progressBar.style.width = '100%';
        progressText.textContent = `–ì–æ—Ç–æ–≤–æ! –£—Å–ø–µ—à–Ω–æ: ${successful}, –û—à–∏–±–æ–∫: ${failed}`;
        
        renderOrderItems();
        updateStatus();
        
        log(`\nüìä –ò—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processed} GTIN:`);
        log(`   ‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ${successful}`);
        log(`   ‚ùå –û—à–∏–±–æ–∫: ${failed}`);

        setTimeout(() => {
            progressBlock.style.display = 'none';
        }, 3000);

    } catch (e) {
        log('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: ' + e.message);
        progressText.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
        progressBar.style.width = '100%';
        progressBar.style.background = '#c53030';
        
        // –î–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—à–∏–±–∫—É
        setTimeout(() => {
            progressBlock.style.display = 'none';
            progressBar.style.background = '#667eea'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–≤–µ—Ç
        }, 10000);
    }

    event.target.value = '';
};

$('addCardBtn').onclick = () => {
    if (!state.card) {
        log('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É');
        return;
    }

    const quantityInput = $('cardQuantity');
    let quantity = parseInt(quantityInput ? quantityInput.value : '0', 10);
    if (!Number.isFinite(quantity) || quantity <= 0) {
        log('‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
        if (quantityInput) {
            quantityInput.focus();
        }
        return;
    }

    const gtin = normalizeGtin(state.card.gtin);
    if (!gtin) {
        log('‚ùå –£ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π GTIN –¥–ª—è –∑–∞–∫–∞–∑–∞');
        return;
    }

    const productGroupSelect = $('productGroup');
    const selectedGroup = productGroupSelect ? productGroupSelect.value : '';
    const cardGroup = state.card.productGroup || '';

    if (selectedGroup && cardGroup && selectedGroup !== cardGroup) {
        log('‚ùå –¢–æ–≤–∞—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤ –∑–∞–∫–∞–∑–µ');
        return;
    }

    const groupToUse = selectedGroup || cardGroup || '';

    if (!selectedGroup && productGroupSelect && groupToUse) {
        productGroupSelect.value = groupToUse;
        updateClothingVisibility();
    }

    const existing = state.orderItems.find(item => item.gtin === gtin);
    if (existing) {
        const baseQuantity = parseInt(existing.quantity, 10) || 0;
        existing.quantity = baseQuantity + quantity;
        existing.name = state.card.name || existing.name;
        existing.templateId = state.card.templateId || existing.templateId;
        existing.productGroup = groupToUse || existing.productGroup;
        existing.goodId = state.card.goodId || existing.goodId;
        log(`‚ûï –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è GTIN ${gtin} —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ ${existing.quantity}`);
    } else {
        state.orderItems.push({
            gtin,
            quantity,
            name: state.card.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
            templateId: state.card.templateId || 10,
            productGroup: groupToUse,
            goodId: state.card.goodId || ''
        });
        log(`‚ûï –ö–∞—Ä—Ç–æ—á–∫–∞ —Å GTIN ${gtin} –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∑–∞–∫–∞–∑ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ${quantity})`);
    }

    if (quantityInput) {
        quantityInput.value = '1';
        quantityInput.focus();
    }

    renderOrderItems();
    updateStatus();
};

$('createOrderBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }

    if (!state.orderItems.length) {
        log('‚ùå –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∑–∞–∫–∞–∑');
        return;
    }

    const productGroupSelect = $('productGroup');
    let productGroup = productGroupSelect ? productGroupSelect.value : '';
    if (!productGroup) {
        const firstWithGroup = state.orderItems.find(item => item.productGroup);
        if (firstWithGroup) {
            productGroup = firstWithGroup.productGroup;
            if (productGroupSelect) {
                productGroupSelect.value = productGroup;
                updateClothingVisibility();
            }
        }
    }

    if (!productGroup) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–æ–≤–∞—Ä–Ω—É—é –≥—Ä—É–ø–ø—É');
        return;
    }

    const inconsistentItem = state.orderItems.find(item => item.productGroup && item.productGroup !== productGroup);
    if (inconsistentItem) {
        log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ —Å GTIN ${inconsistentItem.gtin} –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –¥—Ä—É–≥–æ–π —Ç–æ–≤–∞—Ä–Ω–æ–π –≥—Ä—É–ø–ø–µ`);
        return;
    }

    const releaseMethodSelect = $('releaseMethod');
    const releaseMethod = releaseMethodSelect ? releaseMethodSelect.value : '';

    if (!releaseMethod) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—ã–ø—É—Å–∫–∞');
        return;
    }

    const invalidQuantityItem = state.orderItems.find(item => {
        const value = parseInt(item.quantity, 10);
        return !Number.isFinite(value) || value <= 0;
    });
    if (invalidQuantityItem) {
        log(`‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è GTIN ${invalidQuantityItem.gtin}`);
        return;
    }

    const technicalGtinItem = state.orderItems.find(item => {
        const gtin = String(item.gtin);
        return gtin.startsWith('029') && gtin.length === 14;
    });
    
    if (technicalGtinItem) {
        log(`‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π GTIN ${technicalGtinItem.gtin}`);
        log(`‚ö†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ GTIN (–¥–∏–∞–ø–∞–∑–æ–Ω 029...) –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –¥–ª—è —Ç–æ–≤–∞—Ä–Ω–æ–π –≥—Ä—É–ø–ø—ã "${productGroup}"`);
        log(`üí° –£–¥–∞–ª–∏—Ç–µ —ç—Ç–æ—Ç GTIN –∏–∑ –∑–∞–∫–∞–∑–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—Å—Ç–æ—è—â–∏–π GTIN —Ç–æ–≤–∞—Ä–∞`);
        return;
    }

    try {
        const products = state.orderItems.map(item => ({
            gtin: item.gtin,
            quantity: parseInt(item.quantity, 10),
            serialNumberType: "OPERATOR",
            cisType: "UNIT",
            templateId: item.templateId || 10
        }));

        const totalQuantity = products.reduce((sum, item) => sum + (Number.isFinite(item.quantity) ? item.quantity : 0), 0);

        const order = {
            productGroup,
            products,
            attributes: {
                releaseMethodType: releaseMethod,
                createMethodType: "SELF_MADE"
            }
        };

        if (productGroup === 'lp') {
            const paymentTypeInput = $('lpPaymentType');
            const paymentTypeValue = paymentTypeInput ? parseInt(paymentTypeInput.value, 10) : 2;
            const paymentType = Number.isFinite(paymentTypeValue) ? paymentTypeValue : 2;

            order.attributes.freeCode = $('lpFreeCode').checked;
            order.attributes.paymentType = paymentType;
        }

        const payload = JSON.stringify(order);

        log(`üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞:`);
        log(`   –¢–æ–≤–∞—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞: ${productGroup}`);
        log(`   –°–ø–æ—Å–æ–± –≤—ã–ø—É—Å–∫–∞: ${releaseMethod}`);
        log(`   –ö–∞—Ä—Ç–æ—á–µ–∫: ${products.length}`);
        log(`   –í—Å–µ–≥–æ –ö–ú: ${totalQuantity}`);
        
        products.forEach((p, i) => {
            log(`   ${i + 1}. GTIN: ${p.gtin}, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${p.quantity}, template: ${p.templateId}`);
        });

        console.log('=== ORDER PAYLOAD ===');
        console.log('Length:', payload.length);
        console.log('Content:', payload);

        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å –∑–∞–∫–∞–∑–∞...');
        const rawSignature = await signDetached(payload, state.currentCert);
        
        console.log('=== SIGNATURE ===');
        console.log('Raw length:', rawSignature.length);
        
        const signature = rawSignature.replace(/[\r\n\s]/g, '');
        
        console.log('Cleaned length:', signature.length);
        log('üîë –î–ª–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∏: ' + signature.length + ' —Å–∏–º–≤–æ–ª–æ–≤');
        
        log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –°–£–ó...');
        const result = await req('order.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload, signature})
        });

        log('‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –û—Ç–≤–µ—Ç –°–£–ó:');
        log(JSON.stringify(result.response, null, 2));

        const createdOrder = result.response || {};
        const orderId = createdOrder.orderId || createdOrder.id || createdOrder.uuid || createdOrder.order_id || '';
        if (orderId) {
            state.lastOrderId = orderId;
            const orderInput = $('orderIdInput');
            if (orderInput) orderInput.value = orderId;
            log('üÜî ID –∑–∞–∫–∞–∑–∞: ' + orderId);
        }

        clearErrorState();
        
        state.buffers = [];
        updateBufferOptions();
        updateStatus();
    } catch (e) {
        console.error('Full error:', e);
        
        let errorMsg = e.message;
        
        try {
            const errorMatch = errorMsg.match(/HTTP \d+: (.+)/);
            if (errorMatch) {
                const errorJson = JSON.parse(errorMatch[1]);
                if (errorJson.globalErrors && Array.isArray(errorJson.globalErrors)) {
                    log('‚ùå –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:');
                    errorJson.globalErrors.forEach(err => {
                        log(`   ‚Ä¢ [${err.errorCode}] ${err.error}`);
                    });
                    
                    const techGtinError = errorJson.globalErrors.find(err => 
                        err.error && err.error.includes('—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞')
                    );
                    
                    if (techGtinError) {
                        log('\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∑–∞–∫–∞–∑–µ.');
                        log('   –£–¥–∞–ª–∏—Ç–µ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ GTIN (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 029).');
                        log('   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç–æ—è—â–∏–µ GTIN —Ç–æ–≤–∞—Ä–æ–≤.');
                    }
                } else {
                    log('‚ùå ' + errorMsg);
                }
            } else {
                log('‚ùå ' + errorMsg);
            }
        } catch (parseError) {
            log('‚ùå ' + errorMsg);
        }
        
        clearErrorState();
    }
};

function extractOrderInfos(payload) {
    if (!payload) return [];
    if (Array.isArray(payload)) return payload;
    if (Array.isArray(payload.orderInfos)) return payload.orderInfos;
    if (Array.isArray(payload.orders)) return payload.orders;
    return [];
}

function applyOrderInfo(orderPayload, fallbackId) {
    const infos = extractOrderInfos(orderPayload);
    const buffers = [];
    infos.forEach(info => {
        const orderId = info.orderId || info.id || info.uuid || fallbackId || '';
        if (!state.lastOrderId && orderId) {
            state.lastOrderId = orderId;
            const orderInput = $('orderIdInput');
            if (orderInput) orderInput.value = orderId;
        }

        (info.buffers || []).forEach(buffer => {
            buffers.push({
                ...buffer,
                orderId,
                bufferId: buffer.bufferId || buffer.id || buffer.buffer_id || buffer.uuid || '',
            });
        });
    });

    state.buffers = buffers;
    updateBufferOptions();

    const gtinInput = $('codeGtin');
    if (gtinInput && !gtinInput.value) {
        const bufferWithGtin = buffers.find(buffer => buffer.gtin);
        if (bufferWithGtin && bufferWithGtin.gtin) {
            let normalized = String(bufferWithGtin.gtin).replace(/\s+/g, '');
            if (/^\d+$/.test(normalized)) {
                if (normalized.length < 14) {
                    normalized = normalized.padStart(14, '0');
                }
                if (normalized.length === 14) {
                    gtinInput.value = normalized;
                }
            }
        }
    }
    updateStatus();
}

$('statusBtn').onclick = async () => {
    const orderInput = $('orderIdInput');
    const orderId = (orderInput ? orderInput.value.trim() : '') || state.lastOrderId;

    if (!orderId) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞');
        return;
    }

    try {
        log('üîÑ –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞...');
        const data = await req('order_status.php?orderId=' + encodeURIComponent(orderId));
        const ordersPayload = data.orders || {};
        const output = $('statusOutput');
        if (output) output.textContent = JSON.stringify(ordersPayload, null, 2);

        state.lastOrderId = orderId;
        applyOrderInfo(ordersPayload, orderId);
        log('‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('listOrdersBtn').onclick = async () => {
    try {
        log('üìã –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤...');
        const data = await req('order_status.php?limit=5');
        const ordersPayload = data.orders || {};
        const output = $('statusOutput');
        if (output) output.textContent = JSON.stringify(ordersPayload, null, 2);

        const infos = extractOrderInfos(ordersPayload);
        if (infos.length) {
            const firstId = infos[0].orderId || infos[0].id || infos[0].uuid || '';
            if (firstId) {
                state.lastOrderId = firstId;
                const orderInput = $('orderIdInput');
                if (orderInput) orderInput.value = firstId;
            }
        }

        applyOrderInfo(ordersPayload);
        log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã');
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('downloadCodesBtn').onclick = async () => {
    const orderInput = $('orderIdInput');
    const orderId = (orderInput ? orderInput.value.trim() : '') || state.lastOrderId;

    if (!orderId) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞');
        return;
    }

    const bufferSelect = $('bufferSelect');
    let effectiveOrderId = orderId;
    if (bufferSelect && bufferSelect.value !== '') {
        const option = bufferSelect.options[bufferSelect.selectedIndex];
        if (option && option.dataset.orderId) {
            effectiveOrderId = option.dataset.orderId;
        }
    }

    const formatSelect = $('codeFormat');
    const format = formatSelect ? formatSelect.value : 'CSV';

    const quantityInput = $('codeQuantity');
    let quantity = parseInt(quantityInput ? quantityInput.value : '1000', 10);
    if (!Number.isFinite(quantity) || quantity <= 0) {
        log('‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ú –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
        return;
    }
    if (quantity > 150000) {
        quantity = 150000;
        if (quantityInput) {
            quantityInput.value = '150000';
        }
        log('‚ÑπÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º 150 000 –ö–ú');
    }

    const gtinInput = $('codeGtin');
    let gtin = gtinInput ? gtinInput.value.trim() : '';
    if (!gtin) {
        if (state.orderItems.length) {
            gtin = String(state.orderItems[0].gtin || '');
        } else if (state.card && state.card.gtin) {
            gtin = String(state.card.gtin);
        }
    }
    gtin = gtin.replace(/\s+/g, '');

    if (!gtin) {
        log('‚ùå –£–∫–∞–∂–∏—Ç–µ GTIN —Ç–æ–≤–∞—Ä–∞');
        return;
    }

    if (!/^\d+$/.test(gtin)) {
        log('‚ùå GTIN –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä');
        return;
    }

    if (gtin.length < 14) {
        gtin = gtin.padStart(14, '0');
    }

    if (gtin.length !== 14) {
        log('‚ùå GTIN –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 14 —Ü–∏—Ñ—Ä');
        return;
    }

    if (gtinInput) {
        gtinInput.value = gtin;
    }

    try {
        log('üì¶ –ó–∞–ø—Ä–æ—Å –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏...');
        const params = new URLSearchParams({
            orderId: effectiveOrderId,
            gtin,
            quantity: String(quantity),
        });

        const result = await req('codes.php?' + params.toString());
        const payload = result.data || {};

        const codes = Array.isArray(payload.codes) ? payload.codes : [];
        if (!codes.length) {
            throw new Error('–°–µ—Ä–≤–∏—Å –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ö–ú');
        }

        if (state.downloadUrl) {
            URL.revokeObjectURL(state.downloadUrl);
        }

        let blobContent = '';
        let contentType = 'text/plain';
        let ext = 'txt';

        if ((format || '').toUpperCase() === 'JSON') {
            blobContent = JSON.stringify(codes, null, 2);
            contentType = 'application/json';
            ext = 'json';
        } else {
            blobContent = codes.join('\n');
            contentType = 'text/csv';
            ext = 'csv';
        }

        const blob = new Blob([blobContent], {type: contentType});
        const url = URL.createObjectURL(blob);
        state.downloadUrl = url;

        const link = $('downloadLink');
        if (link) {
            link.href = url;
            const blockSuffix = payload.blockId ? `_block_${payload.blockId}` : '';
            link.download = `codes_${orderId}${blockSuffix}.${ext}`;
            link.style.display = 'inline-block';
            link.textContent = '–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª';
        }

        const received = typeof payload.receivedQuantity === 'number' ? payload.receivedQuantity : codes.length;
        const infoParts = [`${received} –ö–ú`];
        if (payload.blockId) {
            infoParts.push(`blockId ${payload.blockId}`);
        }

        log('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ' + infoParts.join(', '));
    } catch (e) {
        log('‚ùå ' + e.message);
    }
};

$('sendUtilisationBtn').onclick = async () => {
    if (!state.currentCert) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
        return;
    }

    const textarea = $('utilisationPayload');
    if (!textarea || !textarea.value.trim()) {
        log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–ª–æ –æ—Ç—á—ë—Ç–∞ –æ –Ω–∞–Ω–µ—Å–µ–Ω–∏–∏');
        return;
    }

    try {
        const parsed = JSON.parse(textarea.value);
        const payload = JSON.stringify(parsed);

        log('‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å –æ—Ç—á—ë—Ç–∞...');
        const signature = await signDetached(payload, state.currentCert);

        log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞...');
        const result = await req('utilisation.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload, signature})
        });

        log('‚úÖ –û—Ç—á—ë—Ç –ø—Ä–∏–Ω—è—Ç:');
        log(JSON.stringify(result.response, null, 2));
    } catch (e) {
        if (e instanceof SyntaxError) {
            log('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç—á—ë—Ç–∞: ' + e.message);
        } else {
            log('‚ùå ' + e.message);
        }
    }
};

(async () => {
    try {
        const status = await req('auth.php?action=status');
        state.nkActive = status.nk.active;
        state.suzActive = status.suz.active;

        const oms = status.oms || {};

        if (oms.connection && oms.id) {
            state.omsConnection = oms.connection;
            state.omsId = oms.id;
            state.omsSaved = true;
            applyOmsInputs(oms.connection, oms.id);
            persistOmsSettings(oms.connection, oms.id);
        } else {
            state.omsSaved = false;
            if (state.omsConnection || state.omsId) {
                applyOmsInputs(state.omsConnection, state.omsId);
            }
        }

        updateStatus();
        if (state.nkActive || state.suzActive || state.omsSaved) {
            log('‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Å–µ—Å—Å–∏–∏');
        } else if (state.omsConnection && state.omsId) {
            await autoRestoreOmsSettingsFromStorage();
        }
    } catch (e) {
        console.error(e);
    }
})();

window.addEventListener('beforeunload', () => {
    if (state.downloadUrl) {
        URL.revokeObjectURL(state.downloadUrl);
    }
});

window.addEventListener('load', async () => {
    const certCount = await loadCertificates(true);
    if (certCount > 0) {
        await authorizeNk({auto: true});
    }
});
</script>

</body>
</html>