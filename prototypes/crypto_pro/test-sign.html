<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ü–æ–¥–ø–∏—Å–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –ù–ö (detached)</title>
  <script src="cadesplugin_api.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      max-width: 720px;
      margin: 2rem auto;
      background: linear-gradient(120deg, #fdfbfb, #ebedee);
    }
    select {
      width: 100%;
      padding: 0.6rem;
      margin-top: 1rem;
    }
    button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 1rem;
      background: linear-gradient(135deg, #4b86db, #4277d6);
      color: #fff;
      border: 0;
      border-radius: 4px;
      cursor: pointer;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #log {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1rem;
      background: #fafafa;
      min-height: 12rem;
    }
    .cards-list label {
      display: block;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h2>Detached CAdES-BES ‚Üí /v3/feed-product-sign-pkcs</h2>

  <select id="certs">
    <option>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤‚Ä¶</option>
  </select>

  <div id="cards" class="cards-list" style="margin-top: 1rem"></div>

  <button id="go" type="button">–ü–æ–¥–ø–∏—Å–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>

  <div id="log">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CryptoPro‚Ä¶</div>

  <script>
    // –ü—É—Ç—å –¥–æ PHP-—Å–µ—Ä–≤–∏—Å–æ–≤. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å window.SERVICE_ROOT –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–∫—Ä–∏–ø—Ç–∞.
    const SERVICE_ROOT = (window.SERVICE_ROOT || '/servis_CHZ-MS').replace(/\/$/, '');

    /* ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const $ = (id) => document.getElementById(id);
    const utf8ToB64 = (s) => btoa(unescape(encodeURIComponent(s)));
    const isBase64 = (str) => /^[0-9A-Za-z+/]+={0,2}$/.test(str.replace(/\s+/g, ''));

    function log(text) {
      const target = $('log');
      target.textContent += `\n${text}`;
      target.scrollTop = target.scrollHeight;
    }

    async function fetchJson(url, options) {
      const response = await fetch(url, options);
      const raw = await response.text();
      if (!response.ok) {
        throw new Error(`${url} ${response.status}\n${raw}`);
      }
      try {
        return JSON.parse(raw);
      } catch (error) {
        throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: ${error?.message || error}`);
      }
    }

    async function loadCards() {
      try {
        const data = await fetchJson(`${SERVICE_ROOT}/list_for_sign.php`);
        const container = $('cards');
        container.innerHTML = '';
        data.forEach((row) => {
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = row.goodId;
          label.appendChild(checkbox);
          label.appendChild(
            document.createTextNode(` ${row.goodId} ${row.name ? `‚Äî ${row.name}` : ''}`),
          );
          container.appendChild(label);
        });
        if (!data.length) {
          log('–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏.');
        }
      } catch (error) {
        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫: ${error.message || error}`);
      }
    }

    /* ‚îÄ‚îÄ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let certificates = [];

    function ensurePluginReady() {
      if (typeof window.cadesplugin === 'undefined') {
        return Promise.reject(new Error('CryptoPro plug-in –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω.'));
      }
      if (typeof window.cadesplugin.then === 'function') {
        return window.cadesplugin;
      }
      return Promise.resolve(window.cadesplugin);
    }

    ensurePluginReady()
      .then(async () => {
        try {
          const plugin = window.cadesplugin;
          const store = await plugin.CreateObjectAsync('CAdESCOM.Store');
          await store.Open(2, 'My', 2);
          const collection = await store.Certificates;
          const count = await collection.Count;
          $('certs').innerHTML = '';
          certificates = [];
          for (let index = 1; index <= count; index += 1) {
            const cert = await collection.Item(index);
            if (new Date(await cert.ValidToDate) < new Date()) {
              continue; // –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
            }
            $('certs').add(new Option(await cert.SubjectName, certificates.length));
            certificates.push(cert);
          }
          if (!certificates.length) {
            $('certs').add(new Option('–ù–µ—Ç –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤', ''));
          }
          log('‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
          await loadCards();
        } catch (error) {
          log(`‚ùå CryptoPro: ${error.message || error}`);
        }
      })
      .catch((error) => {
        log(`‚ùå CryptoPro: ${error.message || error}`);
      });

    document.addEventListener('DOMContentLoaded', loadCards);

    /* ‚îÄ‚îÄ –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–ø–∏—Å–∞—Ç—å¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    $('go').addEventListener('click', async () => {
      log('\n=== –ù–æ–≤—ã–π –∑–∞–ø—É—Å–∫ ===');
      const selectedCertificate = certificates[$('certs').value];
      if (!selectedCertificate) {
        log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç.');
        return;
      }
      const ids = Array.from(document.querySelectorAll('#cards input[type="checkbox"]:checked')).map(
        (checkbox) => checkbox.value,
      );
      if (!ids.length) {
        log('‚ùå –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫.');
        return;
      }

      try {
        log('‚ÑπÔ∏è –ü–æ–ª—É—á–∞–µ–º XML –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤‚Ä¶');
        const list = await fetchJson(`${SERVICE_ROOT}/get_xml.php?ids=${ids.join(',')}`);
        log(`‚ÑπÔ∏è –ö –ø–æ–¥–ø–∏—Å–∏: ${list.length}`);

        const pack = [];
        for (const row of list) {
          try {
            const source = row.xmlB64 || row.xml;
            const xmlB64 = isBase64(source) ? source.replace(/\s+/g, '') : utf8ToB64(source);
            const { pkcs7 } = await signDetached(xmlB64, selectedCertificate);
            pack.push({
              goodId: row.goodId,
              base64Xml: xmlB64,
              signature: pkcs7,
            });
            log(`‚úÖ ${row.goodId}`);
          } catch (innerError) {
            log(`üî¥ ${row.goodId}: ${innerError.message || innerError}`);
          }
        }

        if (!pack.length) {
          log('‚úã –ù–µ—á–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å.');
          return;
        }

        log('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–∫–µ—Ç –ø–æ–¥–ø–∏—Å–∏‚Ä¶');
        const response = await fetchJson(`${SERVICE_ROOT}/send_signature.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signPack: pack }),
        });
        if (response.signed?.length) {
          log(`üåø –ü–æ–¥–ø–∏—Å–∞–Ω–æ: ${response.signed.join(', ')}`);
        }
        if (response.errors?.length) {
          log(`‚ö†Ô∏è –û—à–∏–±–∫–∏:\n${JSON.stringify(response.errors, null, 2)}`);
        }
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message || error}`);
      }
    });

    /* ‚îÄ‚îÄ detached‚Äë–ø–æ–¥–ø–∏—Å—å CAdES-BES (PKCS#7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    async function signDetached(xmlB64, cert) {
      const plugin = await ensurePluginReady();
      const signer = await plugin.CreateObjectAsync('CAdESCOM.CPSigner');
      await signer.propset_Certificate(cert);

      const signedData = await plugin.CreateObjectAsync('CAdESCOM.CadesSignedData');

      try {
        if (typeof signedData.propset_ContentEncoding === 'function') {
          await signedData.propset_ContentEncoding(plugin.CADESCOM_BASE64_TO_BINARY);
        }
        await signedData.propset_Content(xmlB64);
        const pkcs7 = await signedData.SignCades(
          signer,
          plugin.CADESCOM_CADES_BES,
          true,
        );
        return { pkcs7 };
      } catch (error) {
        log(`‚ÑπÔ∏è Fallback –ø–æ–¥–ø–∏—Å–∏ (raw bytes): ${error.message || error}`);
      }

      await signedData.propset_Content(atob(xmlB64));
      const pkcs7 = await signedData.SignCades(
        signer,
        plugin.CADESCOM_CADES_BES,
        true,
      );
      return { pkcs7 };
    }
  </script>
</body>
</html>
