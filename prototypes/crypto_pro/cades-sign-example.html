<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Пример CAdES-BES подписи в браузере</title>
    <script src="../../vendor/crypto_pro/cadesplugin_api.js"></script>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      }
      body {
        margin: 0 auto;
        max-width: 680px;
        padding: 24px;
        line-height: 1.5;
        background: linear-gradient(140deg, rgba(92, 138, 247, 0.12), rgba(255, 255, 255, 0.9));
      }
      h1 {
        margin-top: 0;
      }
      fieldset {
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 16px 20px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.8);
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }
      select,
      textarea,
      button,
      output {
        width: 100%;
        box-sizing: border-box;
        font: inherit;
      }
      select,
      textarea {
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 0.9);
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      button {
        margin-top: 12px;
        padding: 10px;
        border: 0;
        border-radius: 6px;
        font-weight: 600;
        color: #fff;
        background: linear-gradient(135deg, #2966f8, #1740b5);
        cursor: pointer;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: progress;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.8);
        min-height: 80px;
      }
      .signature-output {
        font-size: 13px;
        background: rgba(15, 23, 42, 0.88);
        color: #f8fafc;
      }
    </style>
  </head>
  <body>
    <h1>CryptoPro CAdES-BES: подпись строки</h1>
    <p>
      Пример демонстрирует работу с <code>cadesplugin_api.js</code> в Chrome. Скрипт дожидается
      готовности объекта <code>cadesplugin</code>, открывает хранилище сертификатов пользователя
      (<code>CAPICOM_CURRENT_USER_STORE</code>, контейнер «My») и позволяет подписать произвольный
      текст методом <code>CAdESCOM.CadesSignedData.SignCades</code> (attached CAdES-BES).
    </p>

    <fieldset>
      <legend>1. Выбор сертификата</legend>
      <label for="certSelect">Доступные сертификаты</label>
      <select id="certSelect" disabled>
        <option>Загрузка сертификатов…</option>
      </select>
      <pre id="status">Ожидание CryptoPro…</pre>
    </fieldset>

    <fieldset>
      <legend>2. Строка для подписи</legend>
      <label for="payload">Текст</label>
      <textarea id="payload">Это тестовая строка для подписи CAdES-BES.</textarea>
      <button id="sign" type="button" disabled>Подписать выбранным сертификатом</button>
    </fieldset>

    <fieldset>
      <legend>3. Результат</legend>
      <label for="signature">PKCS#7 (Base64)</label>
      <textarea id="signature" class="signature-output" readonly></textarea>
    </fieldset>

    <script>
      const statusPanel = document.getElementById('status');
      const certSelect = document.getElementById('certSelect');
      const payloadInput = document.getElementById('payload');
      const signButton = document.getElementById('sign');
      const signatureOutput = document.getElementById('signature');

      /** @type {Array<{cert: any, subject: string, thumbprint: string, validTo: Date}>} */
      let certificates = [];

      function log(message) {
        const timestamp = new Date().toLocaleTimeString('ru-RU');
        statusPanel.textContent += `\n[${timestamp}] ${message}`;
        statusPanel.scrollTop = statusPanel.scrollHeight;
      }

      function normalizeError(error) {
        if (window.cadesplugin && typeof window.cadesplugin.getLastError === 'function') {
          try {
            return window.cadesplugin.getLastError(error);
          } catch (inner) {
            // игнорируем
          }
        }
        return error?.message || String(error);
      }

      function extractCn(subject) {
        if (!subject) {
          return 'Сертификат без имени';
        }
        const match = subject.match(/CN\s*=\s*([^,]+)/i);
        return match ? match[1].trim() : subject;
      }

      function formatDate(date) {
        return date.toLocaleString('ru-RU');
      }

      async function loadCertificates() {
        statusPanel.textContent = 'CryptoPro готов. Читаем сертификаты…';
        signButton.disabled = true;
        certSelect.disabled = true;
        certSelect.innerHTML = '';
        certificates = [];

        try {
          const plugin = window.cadesplugin;
          const store = await plugin.CreateObjectAsync('CAdESCOM.Store');
          await store.Open(
            plugin.CAPICOM_CURRENT_USER_STORE,
            'My',
            plugin.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED,
          );

          const collection = await store.Certificates;
          const count = await collection.Count;

          for (let index = 1; index <= count; index += 1) {
            const cert = await collection.Item(index);

            try {
              const hasPrivateKey = await cert.HasPrivateKey();
              if (!hasPrivateKey) {
                continue;
              }
            } catch (error) {
              log(`Сертификат ${index}: не удалось проверить наличие закрытого ключа (${normalizeError(error)}).`);
            }

            try {
              const validator = await cert.IsValid();
              const result = await validator.Result;
              if (!result) {
                continue;
              }
            } catch (error) {
              log(`Сертификат ${index}: не удалось проверить валидность (${normalizeError(error)}).`);
            }

            const subject = await cert.SubjectName;
            const validTo = new Date(await cert.ValidToDate);
            const thumbprint = await cert.Thumbprint;

            const option = document.createElement('option');
            option.value = String(certificates.length);
            option.textContent = `${extractCn(subject)} — до ${formatDate(validTo)}`;
            option.dataset.thumbprint = thumbprint;
            certSelect.appendChild(option);

            certificates.push({ cert, subject, thumbprint, validTo });
          }

          if (!certificates.length) {
            certSelect.add(new Option('Нет подходящих сертификатов', ''));
            log('CryptoPro: не найдено действующих сертификатов с закрытым ключом.');
            return;
          }

          certSelect.selectedIndex = 0;
          certSelect.disabled = false;
          signButton.disabled = false;
          log(`Найдено сертификатов: ${certificates.length}`);
        } catch (error) {
          certSelect.add(new Option('Ошибка загрузки сертификатов', ''));
          log(`Ошибка CryptoPro: ${normalizeError(error)}`);
        }
      }

      async function signText(content, certificate) {
        const plugin = window.cadesplugin;
        const signer = await plugin.CreateObjectAsync('CAdESCOM.CPSigner');
        await signer.propset_Certificate(certificate);
        await signer.propset_CheckCertificate(true);
        await signer.propset_Options(plugin.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN);

        const signedData = await plugin.CreateObjectAsync('CAdESCOM.CadesSignedData');
        await signedData.propset_ContentEncoding(plugin.CADESCOM_STRING_TO_UCS2LE);
        await signedData.propset_Content(content);

        const pkcs7 = await signedData.SignCades(
          signer,
          plugin.CADESCOM_CADES_BES,
          false, // attached подпись
        );
        return pkcs7;
      }

      certSelect.addEventListener('change', () => {
        const selected = certificates[certSelect.value];
        signButton.disabled = !selected;
        if (selected) {
          log(`Выбран сертификат ${extractCn(selected.subject)} (${selected.thumbprint}).`);
        }
      });

      signButton.addEventListener('click', async () => {
        const entry = certificates[certSelect.value];
        if (!entry) {
          log('Выберите сертификат для подписи.');
          return;
        }

        const text = payloadInput.value.trim();
        if (!text) {
          log('Строка для подписи пуста.');
          return;
        }

        signButton.disabled = true;
        signatureOutput.value = '';
        log('Формируем подпись…');

        try {
          const pkcs7 = await signText(text, entry.cert);
          signatureOutput.value = pkcs7;
          log('Подпись готова.');
        } catch (error) {
          log(`Ошибка при подписи: ${normalizeError(error)}`);
        } finally {
          signButton.disabled = false;
        }
      });

      if (!window.cadesplugin) {
        log('CryptoPro: объект cadesplugin не найден. Проверьте расширение.');
      }

      if (window.cadesplugin && typeof window.cadesplugin.then === 'function') {
        window.cadesplugin
          .then(() => loadCertificates())
          .catch((error) => log(`CryptoPro не инициализировался: ${normalizeError(error)}`));
      } else {
        log('CryptoPro: текущая версия плагина не поддерживает промисы.');
      }
    </script>
  </body>
</html>
